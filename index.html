<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Body Pulse ULTIMATE v24</title>
    
    <style>
        :root {
            --bg: #000000;
            --surface: #111111;
            --surface-light: #1c1c1e;
            --border: #2c2c2e;
            --primary: #ffffff;
            --accent: #32d74b;
            --secondary: #8e8e93;
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Roboto", sans-serif;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg); color: var(--primary); font-family: var(--font);
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            padding-top: var(--safe-top); overflow: hidden;
        }

        h1 { font-size: 28px; font-weight: 800; margin: 0 0 5px; letter-spacing: 0.5px; }
        h2 { font-size: 11px; font-weight: 700; margin: 0 0 15px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--secondary); }
        .val-big { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
        .label { color: var(--secondary); font-size: 11px; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .sub-text { font-size: 13px; color: var(--secondary); }

        .screen { 
            display: none; flex-direction: column; height: 100%; 
            padding: 20px; padding-bottom: 110px; overflow-y: auto; 
            z-index: 10; position: relative;
        }
        .screen.active { display: flex; animation: fade 0.3s ease; }
        
        .card { 
            background: var(--surface); padding: 20px; border: 1px solid var(--border); 
            margin-bottom: 15px; border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        .btn {
            width: 100%; padding: 18px; border: none; background: var(--primary); 
            color: var(--bg); font-size: 15px; font-weight: 700; text-transform: uppercase; 
            cursor: pointer; transition: 0.1s; margin-top: 10px; letter-spacing: 0.5px; border-radius: 10px;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-outline { background: transparent; color: var(--primary); border: 1px solid var(--border); }
        .btn-close { background: transparent; border: none; font-size: 24px; color: var(--secondary); padding: 10px; }

        input:not([type="checkbox"]):not([type="range"]):not([type="date"]) {
            width: 100%; background: var(--surface-light); border: 1px solid var(--border);
            color: var(--primary); padding: 14px; font-size: 16px; font-family: var(--font);
            border-radius: 8px; margin-bottom: 20px; appearance: none;
        }
        input[type="date"] {
            width: 100%; background: var(--surface-light); border: 1px solid var(--border);
            color: var(--primary); padding: 10px; border-radius: 8px; margin-bottom: 20px;
        }

        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
        input[type="checkbox"] { accent-color: var(--primary); width: 24px; height: 24px; cursor: pointer; }
        input[type="range"] { width: 100%; margin: 10px 0; accent-color: var(--primary); }

        .chart-container { width: 100%; height: 120px; position: relative; margin-top: 10px; border-bottom: 1px solid var(--border); }
        svg.chart { width: 100%; height: 100%; overflow: visible; }
        polyline { fill: none; stroke: var(--primary); stroke-width: 2; }
        .chart-dot { fill: var(--bg); stroke: var(--primary); stroke-width: 2; }

        .full-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg);
            z-index: 2000; display: none; flex-direction: column; padding: var(--safe-top) 25px 25px 25px;
            overflow-y: auto;
        }
        .wiz-step { display: none; flex-direction: column; height: 100%; }
        .wiz-step.active { display: flex; animation: slide 0.3s ease; }
        .opt-item { 
            padding: 22px; border: 1px solid var(--border); margin-bottom: 12px; 
            cursor: pointer; border-radius: 12px; background: var(--surface); font-weight: 500;
        }
        .opt-item.selected { border-color: var(--primary); background: var(--surface-light); color: var(--primary); }

        .timer-wrap { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .progress-ring { width: 260px; height: 260px; transform: rotate(-90deg); }
        .progress-ring__circle { transition: stroke-dashoffset 1.0s linear; transform-origin: 50% 50%; }
        .time-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .time-huge { font-size: 80px; font-weight: 700; font-family: monospace; letter-spacing: -3px; line-height: 1; }
        .phase-lbl { font-size: 16px; font-weight: 600; letter-spacing: 4px; margin-top: 10px; display: block; }
        
        .goal-ring { width: 60px; height: 60px; transform: rotate(-90deg); }

        .check-item { padding: 15px 0; border-bottom: 1px solid var(--border); font-size: 16px; display: flex; align-items: center; gap: 15px; }
        .hist-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--border); font-size: 13px; }

        .nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 85px;
            background: rgba(0,0,0,0.95); border-top: 1px solid var(--border); backdrop-filter: blur(20px);
            display: flex; justify-content: space-around; padding-bottom: var(--safe-bottom); z-index: 1000;
        }
        .nav-btn { flex: 1; display: flex; justify-content: center; align-items: center; opacity: 0.4; font-size: 24px; cursor: pointer; transition: 0.2s; color: white; }
        .nav-btn.active { opacity: 1; transform: scale(1.1); color: var(--primary); }

        @keyframes fade { from{opacity:0;} to{opacity:1;} }
        @keyframes slide { from{opacity:0; transform:translateX(20px);} to{opacity:1; transform:translateX(0);} }
    </style>
</head>
<body>

    <div id="view-onboarding" class="full-overlay">
        <div id="wiz-1" class="wiz-step active">
            <h1 style="margin-top:20px;">DEIN ZIEL</h1>
            <p class="label">Schritt 1 von 3</p>
            <div style="margin-top:20px;">
                <div class="opt-item" onclick="wizSet('goal', 'lose', this)">ABNEHMEN</div>
                <div class="opt-item" onclick="wizSet('goal', 'build', this)">MUSKELAUFBAU</div>
                <div class="opt-item" onclick="wizSet('goal', 'fit', this)">ALLG. FITNESS</div>
            </div>
            <button class="btn" style="margin-top:auto" onclick="wizNext(1)">WEITER</button>
        </div>
        <div id="wiz-2" class="wiz-step">
            <h1 style="margin-top:20px;">FOKUS ZONEN</h1>
            <p class="label">Mehrfachwahl m√∂glich</p>
            <div style="margin-top:20px;">
                <div class="opt-item" onclick="wizToggle('parts', 'bauch', this)">BAUCH & CORE</div>
                <div class="opt-item" onclick="wizToggle('parts', 'beine', this)">BEINE & PO</div>
                <div class="opt-item" onclick="wizToggle('parts', 'ober', this)">OBERK√ñRPER</div>
                <div class="opt-item" onclick="wizToggle('parts', 'cardio', this)">CARDIO / HIIT</div>
            </div>
            <button class="btn" style="margin-top:auto" onclick="wizNext(2)">WEITER</button>
        </div>
        <div id="wiz-3" class="wiz-step">
            <h1 style="margin-top:20px;">PROFIL</h1>
            <p class="label">Basis f√ºr deine Statistik</p>
            <div class="card" style="margin-top:20px;">
                <input type="number" id="wiz-age" placeholder="Alter">
                <div class="input-row">
                    <input type="number" id="wiz-height" placeholder="Gr√∂√üe (cm)">
                    <input type="number" id="wiz-weight" placeholder="Gewicht (kg)">
                </div>
            </div>
            <button class="btn" style="margin-top:auto" onclick="wizFinish()">SETUP ABSCHLIESSEN</button>
        </div>
    </div>

    <div id="tab-home" class="screen active">
        <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:20px;">
            <div>
                <span class="label" id="greeting">HALLO</span>
                <h1>COCKPIT</h1>
            </div>
            <div style="font-size:12px; background:var(--surface-light); border:1px solid var(--border); padding:5px 12px; border-radius:20px;" id="lvl-badge">LVL 1</div>
        </div>

        <div class="stat-grid">
            <div class="card" style="margin:0; text-align:center;">
                <span class="label">LIFETIME KCAL</span>
                <span class="val-big" id="disp-total-kcal">0</span>
            </div>
            <div class="card" style="margin:0; text-align:center;">
                <span class="label">WORKOUTS</span>
                <span class="val-big" id="disp-count">0</span>
            </div>
        </div>

        <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <span class="label">WOCHENZIEL</span>
                <div class="val-big" id="week-val">...</div>
                <div class="sub-text" id="goal-info" style="font-size:12px; margin-top:4px;">Bleib diszipliniert!</div>
            </div>
            <div style="position:relative; width:60px; height:60px;">
                <svg class="goal-ring" width="60" height="60" viewBox="0 0 60 60">
                    <circle stroke="#222" stroke-width="5" fill="transparent" r="24" cx="30" cy="30"/>
                    <circle id="week-circle" stroke="white" stroke-width="5" stroke-linecap="round" fill="transparent" r="24" cx="30" cy="30" stroke-dasharray="150 150" stroke-dashoffset="150"/>
                </svg>
            </div>
        </div>

        <div class="card" style="border: 1px solid var(--primary);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>HEUTE (VARIABEL)</h2>
                <span style="font-size:10px; color:#666;" id="last-workout">Last: Nie</span>
            </div>
            <div style="font-size: 22px; font-weight: 700; margin-bottom: 5px; color:var(--primary);" id="next-title">Mix Workout</div>
            <div style="color: var(--secondary); font-size: 14px; margin-bottom: 20px; line-height: 1.4;" id="next-desc">Lade Plan...</div>
            <button class="btn" onclick="openPlayer()">TRAINING STARTEN</button>
        </div>
    </div>

    <div id="tab-stats" class="screen">
        <h1>TRACKING</h1>
        
        <div class="card">
            <h2>GEWICHTSKURVE</h2>
            <div class="chart-container">
                <svg class="chart" id="weight-chart" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:12px; color:var(--secondary);">
                <span>Start</span>
                <span>Trend</span>
                <span>Heute</span>
            </div>
        </div>

        <div class="card">
            <h2>DIESER MONAT</h2>
            <div class="stat-grid" style="margin-bottom:0;">
                <div style="text-align:center;">
                     <span class="val-big" id="month-workouts">0</span>
                     <span class="label">WORKOUTS</span>
                </div>
                <div style="text-align:center;">
                     <span class="val-big" id="month-kcal">0</span>
                     <span class="label">KCAL</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>MESSUNG EINTRAGEN</h2>
            <input type="date" id="log-date">
            <div class="input-row">
                <div><span class="label">Gewicht (kg)</span><input type="number" id="log-weight" step="0.1"></div>
                <div><span class="label">Bauch (cm)</span><input type="number" id="log-waist"></div>
            </div>
            <div class="input-row">
                <div><span class="label">Po/H√ºfte (cm)</span><input type="number" id="log-hips"></div>
                <div><span class="label">Brust (cm)</span><input type="number" id="log-chest"></div>
            </div>
             <div class="input-row">
                <div><span class="label">Oberschenkel (cm)</span><input type="number" id="log-thigh"></div>
                <div></div>
            </div>
            <button class="btn btn-outline" onclick="saveLog()">WERTE SPEICHERN</button>
        </div>

        <div id="hist-list"></div>
    </div>

    <div id="tab-settings" class="screen">
        <h1>SYSTEM</h1>
        
        <div class="card">
            <h2>TIMER & ZIELE</h2>
            <div style="margin-bottom:25px;">
                <div class="toggle-row"><span>Wochenziel: <b id="lbl-goal">5</b> x</span></div>
                <input type="range" min="1" max="7" step="1" id="rng-goal" oninput="updateRangeSettings()">
            </div>
            <div style="margin-bottom:20px;">
                <div class="toggle-row"><span>Belastung: <b id="lbl-work">40</b> Sek</span></div>
                <input type="range" min="20" max="90" step="5" id="rng-work" oninput="updateRangeSettings()">
            </div>
            <div>
                <div class="toggle-row"><span>Pause: <b id="lbl-rest">20</b> Sek</span></div>
                <input type="range" min="10" max="60" step="5" id="rng-rest" oninput="updateRangeSettings()">
            </div>
        </div>

        <div class="card">
            <h2>OPTIONEN</h2>
            <div class="toggle-row">
                <span style="font-size:16px;">Supplements Erinnerung</span>
                <input type="checkbox" id="tog-supps" onchange="toggleSupps()" checked>
            </div>
        </div>

        <div class="card">
            <h2>DEIN PROFIL</h2>
            <div class="input-row">
                <div><span class="label">Gr√∂√üe (cm)</span><input type="number" id="set-height" onchange="save()"></div>
                <div><span class="label">Alter</span><input type="number" id="set-age" onchange="save()"></div>
            </div>
        </div>

        <button class="btn btn-outline" style="color:#ff453a; border-color:#ff453a; margin-top:20px;" onclick="resetApp()">WERKSEINSTELLUNGEN</button>
    </div>

    <div id="view-player" class="full-overlay" style="background:#000000; z-index:3000;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button class="btn-close" onclick="closePlayer()">‚úï</button>
            <span id="round-disp" style="font-size:12px; letter-spacing:1px;">RUNDE 1/3</span>
            <button class="btn-close" style="font-size:20px;" onclick="toggleMute()" id="mute-icon">üîä</button>
        </div>

        <div class="timer-wrap">
            <svg class="progress-ring" width="260" height="260">
                <circle stroke="#222" stroke-width="8" fill="transparent" r="115" cx="130" cy="130"/>
                <circle id="progress-circle" class="progress-ring__circle" stroke="white" stroke-width="8" stroke-linecap="round" fill="transparent" r="115" cx="130" cy="130"/>
            </svg>
            <div class="time-center">
                <div class="time-huge" id="time-disp">00</div>
                <span id="phase-disp" class="phase-lbl">READY</span>
            </div>
        </div>

        <div style="margin-bottom: 40px; text-align:center;">
            <div id="ex-name" style="font-size:24px; font-weight:700;">√úbung</div>
            <div id="next-ex" style="color:var(--secondary); font-size:14px; margin-bottom:20px;">...</div>
            <button class="btn-outline" style="padding:10px 20px; font-size:12px;" onclick="showInfo()">ANLEITUNG</button>
            <button id="skip-btn" onclick="skipRest()" style="display:none; width:100%; border:none; background:#222; color:#fff; padding:15px; margin-top:20px;">PAUSE √úBERSPRINGEN</button>
        </div>

        <button class="btn" id="play-btn" onclick="toggleTimer()">START</button>
    </div>

    <div id="view-info" class="full-overlay" style="background: rgba(0,0,0,0.97); z-index: 4000;">
        <button class="btn-close" onclick="document.getElementById('view-info').style.display='none'">‚úï</button>
        <h1 id="info-title" style="margin-top:40px;">√úBUNG</h1>
        <p id="info-desc" style="font-size:18px; line-height:1.6; color:var(--secondary); margin-top:20px;"></p>
    </div>

    <div id="view-rpe" class="full-overlay" style="z-index: 4000; justify-content:center;">
        <h1 style="text-align:center;">INTENSIT√ÑT (1-10)</h1>
        <input type="range" min="1" max="10" value="5" id="rpe-slider" style="margin: 40px 0;">
        <button class="btn" onclick="finishWorkout()">ABSCHLIESSEN</button>
    </div>

    <div id="view-supps" class="full-overlay" style="z-index: 5000; justify-content:center; text-align:center;">
        <h1>POST-WORKOUT</h1>
        <p class="label" style="margin-bottom:30px;">Vergiss deine N√§hrstoffe nicht!</p>
        <div style="text-align:left; display:inline-block; max-width: 300px; width:100%;">
            <div class="check-item">ü•§ Eiwei√üpulver</div>
            <div class="check-item">‚ö° Kreatin</div>
            <div class="check-item">üíä Magnesium</div>
            <div class="check-item">üî© Eisen</div>
        </div>
        <button class="btn" style="margin-top:50px;" onclick="location.reload()">ERLEDIGT</button>
    </div>

    <nav class="nav">
        <div class="nav-btn active" onclick="nav('tab-home', this)">‚ñ†</div>
        <div class="nav-btn" onclick="nav('tab-stats', this)">lll</div>
        <div class="nav-btn" onclick="nav('tab-settings', this)">‚óè</div>
    </nav>

    <script>
        // --- DATA POOL ---
        const DB = {
            bauch: [
                {n:"Crunches", d:"R√ºckenlage, Beine angewinkelt. Hebe kontrolliert die Schultern vom Boden."},
                {n:"Leg Raises", d:"R√ºckenlage, H√§nde unter den Po. Hebe die gestreckten Beine auf 90 Grad."},
                {n:"Plank", d:"Unterarmst√ºtz. K√∂rper bildet eine Linie. Core fest anspannen."},
                {n:"Russian Twist", d:"Sitzend, Beine leicht in der Luft. Oberk√∂rper rotiert links/rechts."},
                {n:"Bicycle Crunches", d:"Abwechselnd Ellbogen zum gegen√ºberliegenden Knie f√ºhren."},
                {n:"Mountain Climbers", d:"Hohe Plank. Knie schnell abwechselnd zur Brust ziehen."},
                {n:"Side Plank L", d:"Seitlicher Unterarmst√ºtz links. H√ºfte aktiv hochdr√ºcken."},
                {n:"Side Plank R", d:"Seitlicher Unterarmst√ºtz rechts. H√ºfte aktiv hochdr√ºcken."}
            ],
            beine: [
                {n:"Squats", d:"Kniebeugen. R√ºcken gerade, Gewicht auf die Fersen verlagern."},
                {n:"Lunges", d:"Ausfallschritte. Knie kontrolliert tief f√ºhren."},
                {n:"Glute Bridges", d:"R√ºckenlage. F√º√üe nah am Po. H√ºfte maximal nach oben dr√ºcken."},
                {n:"Calf Raises", d:"Wadenheben im Stehen. Auf die Zehenspitzen dr√ºcken."},
                {n:"Sumo Squats", d:"Breiter Stand, Zehen leicht nach au√üen. Tief in die Hocke."},
                {n:"Wall Sit", d:"R√ºcken an die Wand, Beine im 90 Grad Winkel halten."},
                {n:"Bulgarian Split", d:"Ein Fu√ü auf eine Erh√∂hung hinter dir. Ausfallschritte machen."}
            ],
            ober: [
                {n:"Push-Ups", d:"Liegest√ºtze. H√§nde unter den Schultern. K√∂rper bleibt fest."},
                {n:"Dips", d:"An Stuhlkante/Bank. Arme beugen und wieder strecken."},
                {n:"Superman", d:"Bauchlage. Arme und Beine gleichzeitig leicht anheben."},
                {n:"Shoulder Taps", d:"Hohe Plank. Abwechselnd mit der Hand die andere Schulter tippen."},
                {n:"Diamond Pushups", d:"Enger Liegest√ºtz. H√§nde bilden ein Dreieck unter der Brust."},
                {n:"Pike Pushups", d:"Po hoch in die Luft (V-Form). Kopf Richtung Boden senken."}
            ],
            cardio: [
                {n:"Jumping Jacks", d:"Hampelmann. Arme und Beine gleichzeitig √∂ffnen/schlie√üen."},
                {n:"Burpees", d:"Liegest√ºtz, Hocksprung und Strecksprung in einer Bewegung."},
                {n:"High Knees", d:"Laufen auf der Stelle, Knie so hoch wie m√∂glich ziehen."},
                {n:"Butt Kicks", d:"Laufen auf der Stelle, Fersen ber√ºhren den Po."},
                {n:"Skaters", d:"Seitliche Spr√ºnge wie ein Eisschnelll√§ufer."}
            ]
        };

        const STORE_KEY = 'bp_ultimate_v24_final';
        let app = { 
            profile: { h: '', w: '', a: '' }, 
            goal: '', parts: [], history: [], logs: [],
            settings: { supps: true, work: 40, rest: 20, weeklyGoal: 5 },
            currentWorkout: []
        };
        let sess = { active: [], r: 1, idx: 0, t: 0, max: 0, work: false, run: false, int: null, sound: true };
        let wiz = { goal: '', parts: [] };
        let ac = null;

        const circle = document.getElementById('progress-circle');
        const circumference = 2 * Math.PI * 115; 
        circle.style.strokeDasharray = `${circumference} ${circumference}`;

        window.onload = () => {
            const d = localStorage.getItem(STORE_KEY);
            if(d) {
                app = JSON.parse(d);
                initApp();
            } else {
                document.getElementById('view-onboarding').style.display = 'flex';
                document.getElementById('wiz-1').classList.add('active');
            }
        };

        function initApp() {
            document.getElementById('view-onboarding').style.display = 'none';
            document.getElementById('set-height').value = app.profile.h;
            document.getElementById('set-age').value = app.profile.a;
            document.getElementById('tog-supps').checked = app.settings.supps;
            document.getElementById('rng-work').value = app.settings.work;
            document.getElementById('rng-rest').value = app.settings.rest;
            document.getElementById('rng-goal').value = app.settings.weeklyGoal;
            
            if(app.currentWorkout.length === 0) generateWorkout();
            updateRangeSettings();
            updateGreeting();
            updateUI();
        }

        // --- ROTATION LOGIC ---
        function generateWorkout() {
            let pool = [];
            if(!app.parts || app.parts.length === 0) app.parts = ['bauch','beine','ober','cardio']; 
            app.parts.forEach(p => { if(DB[p]) pool = pool.concat(DB[p]); });
            pool.sort(()=>Math.random()-0.5);
            app.currentWorkout = pool.slice(0, 6);
            save();
        }

        function updateUI() {
            document.getElementById('disp-count').innerText = app.history.length;
            document.getElementById('lvl-badge').innerText = "LVL " + (Math.floor(app.history.length / 5) + 1);
            
            // Weekly Goal
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - (startOfWeek.getDay() || 7) + 1);
            startOfWeek.setHours(0,0,0,0);
            const thisWeek = app.history.filter(h => new Date(h.date) >= startOfWeek).length;
            const target = parseInt(app.settings.weeklyGoal);
            document.getElementById('week-val').innerText = `${thisWeek} / ${target}`;
            const pct = Math.min(thisWeek / target, 1);
            document.getElementById('week-circle').style.strokeDashoffset = 150 - (150 * pct);
            document.getElementById('week-circle').setAttribute("stroke", pct>=1 ? "#32d74b" : "white");
            document.getElementById('goal-info').innerText = pct >= 1 ? "Ziel erreicht! ‚òÖ" : `Noch ${target - thisWeek} Einheiten n√∂tig`;

            // Lifetime Kcal
            let totalKcal = 0;
            app.history.forEach(h => totalKcal += (h.kcal || 0));
            document.getElementById('disp-total-kcal').innerText = totalKcal.toLocaleString();

            // Month Stats
            const now = new Date();
            let mWork = 0; let mKcal = 0;
            app.history.forEach(h => {
                const hd = new Date(h.date);
                if(hd.getMonth() === now.getMonth() && hd.getFullYear() === now.getFullYear()) {
                    mWork++; mKcal += (h.kcal || 0);
                }
            });
            document.getElementById('month-workouts').innerText = mWork;
            document.getElementById('month-kcal').innerText = mKcal.toLocaleString();

            // Next Workout
            document.getElementById('next-desc').innerText = app.currentWorkout.map(e => e.n).join(' ‚Ä¢ ');

            if(app.history.length > 0) {
                const diff = Math.floor((new Date() - new Date(app.history[app.history.length-1].date)) / 86400000);
                document.getElementById('last-workout').innerText = diff === 0 ? "Last: Heute" : `Last: Vor ${diff} Tagen`;
            }

            renderChart(); renderHist();
        }

        // --- PLAYER LOGIC ---
        function openPlayer() {
            if(!ac) ac = new (window.AudioContext||window.webkitAudioContext)();
            sess.idx = 0; sess.r = 1; sess.t = 10; sess.work = false;
            document.getElementById('view-player').style.display = 'flex';
            startPhase('PREP');
        }

        function startPhase(type) {
            sess.work = (type === 'WORK');
            const ph = document.getElementById('phase-disp');
            if(type === 'PREP') {
                sess.t = 10; sess.max = 10; ph.innerText = "READY";
            } else if(type === 'WORK') {
                sess.t = parseInt(app.settings.work); sess.max = sess.t; ph.innerText = "WORK"; ph.style.color = "#fff";
                beep(400, 0.4);
            } else {
                sess.t = parseInt(app.settings.rest); sess.max = sess.t; ph.innerText = "REST"; ph.style.color = "#32d74b";
                beep(600, 0.3);
            }
            updatePlayerUI();
            if(!sess.run) toggleTimer();
        }

        function tick() {
            if(sess.t > 0) {
                sess.t--;
                if(sess.t <= 3) beep(800, 0.1);
                updatePlayerUI();
            } else {
                nextStep();
            }
        }

        function nextStep() {
            if(document.getElementById('phase-disp').innerText === "READY") startPhase('WORK');
            else if(sess.work) {
                if(sess.idx >= app.currentWorkout.length-1 && sess.r >= 3) showRPE();
                else startPhase('REST');
            } else {
                sess.idx++;
                if(sess.idx >= app.currentWorkout.length) { sess.idx = 0; sess.r++; }
                document.getElementById('round-disp').innerText = "RUNDE "+sess.r+"/3";
                startPhase('WORK');
            }
        }

        function updatePlayerUI() {
            document.getElementById('time-disp').innerText = sess.t;
            circle.style.strokeDashoffset = circumference - (sess.t / sess.max) * circumference;
            document.getElementById('ex-name').innerText = app.currentWorkout[sess.idx].n;
            let n = (sess.idx+1 < app.currentWorkout.length) ? app.currentWorkout[sess.idx+1].n : (sess.r<3?"Runde "+(sess.r+1):"ENDE");
            document.getElementById('next-ex').innerText = "Next: " + n;
            document.getElementById('skip-btn').style.display = (!sess.work && sess.t > 2) ? "block" : "none";
        }

        function toggleTimer() {
            const b = document.getElementById('play-btn');
            if(sess.run) { clearInterval(sess.int); sess.run = false; b.innerText="WEITER"; }
            else { sess.int = setInterval(tick, 1000); sess.run = true; b.innerText="STOP"; }
        }

        function showRPE() { clearInterval(sess.int); document.getElementById('view-rpe').style.display = 'flex'; }
        function finishWorkout() {
            const rpe = document.getElementById('rpe-slider').value;
            const weight = parseFloat(app.profile.w) || 75;
            const kcal = Math.floor((6 * 3.5 * weight / 200) * 15);
            app.history.push({date: new Date().toISOString(), rpe: rpe, kcal: kcal});
            generateWorkout(); 
            save();
            document.getElementById('view-rpe').style.display = 'none';
            if(app.settings.supps) document.getElementById('view-supps').style.display = 'flex';
            else location.reload();
        }

        // --- STATS & UTILS ---
        function saveLog() {
            const d = document.getElementById('log-date').value || new Date().toISOString().split('T')[0];
            const w = document.getElementById('log-weight').value;
            if(!w) return alert("Gewicht n√∂tig!");
            app.logs.push({date:d, w:w, waist:document.getElementById('log-waist').value, hips:document.getElementById('log-hips').value, chest:document.getElementById('log-chest').value, thigh:document.getElementById('log-thigh').value});
            app.logs.sort((a,b)=>new Date(a.date)-new Date(b.date));
            save(); updateUI(); alert("Gespeichert");
        }

        function updateRangeSettings() {
            app.settings.work = document.getElementById('rng-work').value;
            app.settings.rest = document.getElementById('rng-rest').value;
            app.settings.weeklyGoal = document.getElementById('rng-goal').value;
            document.getElementById('lbl-work').innerText = app.settings.work;
            document.getElementById('lbl-rest').innerText = app.settings.rest;
            document.getElementById('lbl-goal').innerText = app.settings.weeklyGoal;
            save(); updateUI();
        }

        function renderChart() {
            const svg = document.getElementById('weight-chart'); svg.innerHTML = "";
            if(app.logs.length < 2) return;
            const data = app.logs.slice(-10).map(l => parseFloat(l.w));
            const max = Math.max(...data) + 1; const min = Math.min(...data) - 1;
            let points = "";
            data.forEach((val, i) => {
                const x = i * (100 / (data.length - 1));
                const y = 100 - ((val - min) / (max - min) * 100);
                points += `${x},${y} `;
                const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                dot.setAttribute("cx", x); dot.setAttribute("cy", y); dot.setAttribute("r", 2.5);
                dot.setAttribute("class", "chart-dot");
                svg.appendChild(dot);
            });
            const pl = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            pl.setAttribute("points", points); svg.appendChild(pl);
        }

        function renderHist() {
            const l = document.getElementById('hist-list'); l.innerHTML = "<h2>VERLAUF</h2>";
            app.history.slice(-5).reverse().forEach(h => {
                l.innerHTML += `<div class="hist-item"><span>TRAINING (${h.rpe}/10)</span><span style="color:#666">${new Date(h.date).toLocaleDateString()} ‚Ä¢ ${h.kcal}kcal</span></div>`;
            });
        }

        function wizSet(k, v, el) { wiz[k]=v; el.parentElement.querySelectorAll('div').forEach(d=>d.classList.remove('selected')); el.classList.add('selected'); }
        function wizToggle(k, v, el) { if(!wiz[k]) wiz[k]=[]; const i=wiz[k].indexOf(v); if(i>-1){wiz[k].splice(i,1); el.classList.remove('selected');} else {wiz[k].push(v); el.classList.add('selected');} }
        function wizNext(s) { document.querySelectorAll('.wiz-step').forEach(ws=>ws.classList.remove('active')); document.getElementById('wiz-'+(s+1)).classList.add('active'); }
        function wizFinish() {
            app.profile = { h: document.getElementById('wiz-height').value, a: document.getElementById('wiz-age').value, w: document.getElementById('wiz-weight').value };
            app.parts = wiz.parts; app.goal = wiz.goal;
            if(app.profile.w) app.logs.push({date: new Date().toISOString().split('T')[0], w: app.profile.w});
            save(); initApp();
        }

        function nav(id, el) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); 
            el.classList.add('active'); 
        }

        function beep(freq, dur) { if(!sess.sound || !ac) return; const o=ac.createOscillator(); const g=ac.createGain(); o.connect(g); g.connect(ac.destination); o.frequency.value=freq; g.gain.setValueAtTime(0.05, ac.currentTime); g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime+dur); o.start(); o.stop(ac.currentTime+dur); }
        function toggleMute() { sess.sound = !sess.sound; document.getElementById('mute-icon').innerText = sess.sound ? "üîä" : "üîá"; }
        function updateGreeting() { const h = new Date().getHours(); let g = "GUTEN ABEND"; if(h < 11) g = "GUTEN MORGEN"; else if(h < 18) g = "GUTEN TAG"; document.getElementById('greeting').innerText = g; }
        function showInfo() { const e = app.currentWorkout[sess.idx]; document.getElementById('info-title').innerText = e.n; document.getElementById('info-desc').innerText = e.d; document.getElementById('view-info').style.display = 'flex'; }
        function skipRest() { nextStep(); }
        function closePlayer() { clearInterval(sess.int); location.reload(); }
        function save() { localStorage.setItem(STORE_KEY, JSON.stringify(app)); }
        function resetApp() { if(confirm("App komplett zur√ºcksetzen? Alle Daten gehen verloren.")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
