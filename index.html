<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Body Pulse Smart</title>
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background:%23000000'%3E%3Cpath fill='%2332d74b' d='M256 48C141.1 48 48 141.1 48 256s93.1 208 208 208 208-93.1 208-208S370.9 48 256 48zm-32.1 289.8l-8.8 45.3c-2.1 10.7-16.5 13.6-22.7 4.6l-37.5-54.6c-5.8-8.4-5.4-19.6 1-27.6l74.9-93.6c7.9-9.9 23.4-4.8 24.3 7.9l3.3 46.1 45.1-66.2c6.1-8.9 19.3-8.6 25 0l42.6 62.4c5.8 8.5 5.2 19.7-1.3 27.6l-81.5 98.7c-8.4 10.2-24.6 4.8-25.3-8.3l-2.6-47.5-36.5 5.2z'/%3E%3C/svg%3E">

    <style>
        :root {
            /* DARK MODE (Default) */
            --bg: #000000;
            --card: #1c1c1e;
            --input-bg: #2c2c2e;
            --text: #ffffff;
            --text-dim: #8e8e93;
            --accent: #0a84ff;
            --work: #32d74b;
            --rest: #ff9f0a;
            --nav-bg: rgba(28,28,30, 0.95);
            --border: #333;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* LIGHT MODE OVERRIDE */
        body.light-mode {
            --bg: #f2f2f7;
            --card: #ffffff;
            --input-bg: #e5e5ea;
            --text: #000000;
            --text-dim: #6c6c70;
            --border: #d1d1d6;
            --nav-bg: rgba(255,255,255, 0.95);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg); color: var(--text); font-family: var(--font);
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            padding-top: env(safe-area-inset-top); overflow: hidden; transition: background 0.3s, color 0.3s;
        }

        /* --- SCREENS --- */
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; padding-bottom: 90px; overflow-y: auto; }
        .screen.active { display: flex; animation: fadein 0.3s; }
        .full-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg);
            z-index: 200; display: none; flex-direction: column; padding: env(safe-area-inset-top) 20px 20px 20px;
        }
        .full-overlay.active { display: flex; }

        /* --- UI ELEMENTS --- */
        h1 { font-size: 28px; margin: 0 0 5px; }
        h2 { font-size: 20px; margin: 0 0 10px; }
        .subtitle { color: var(--text-dim); font-size: 14px; margin-bottom: 20px; display: block; }
        
        .card { background: var(--card); padding: 20px; border-radius: 16px; margin-bottom: 15px; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .btn-main { width: 100%; padding: 16px; border-radius: 14px; border: none; font-size: 17px; font-weight: bold; cursor: pointer; background: var(--accent); color: white; margin-top: 10px; }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }
        .btn-sec { background: var(--input-bg); color: var(--text); }

        /* --- ONBOARDING --- */
        .grid-select { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .select-item { 
            background: var(--input-bg); padding: 20px; border-radius: 12px; text-align: center; 
            border: 2px solid transparent; cursor: pointer; transition: 0.2s;
        }
        .select-item.selected { border-color: var(--accent); background: rgba(10, 132, 255, 0.15); color: var(--accent); }
        .select-icon { font-size: 30px; display: block; margin-bottom: 5px; }

        /* --- HOME --- */
        .next-workout-card { border: 2px solid var(--work); background: rgba(50, 215, 75, 0.05); }
        .stat-row { display: flex; justify-content: space-between; margin-top: 5px; }
        .stat-item { text-align: center; }
        .stat-val { font-size: 20px; font-weight: bold; display: block; }
        .stat-lbl { font-size: 12px; color: var(--text-dim); }

        /* --- WORKOUT PLAYER --- */
        .timer-wrap { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .progress-ring { width: 260px; height: 260px; transform: rotate(-90deg); }
        .ring-circle { transition: stroke-dashoffset 1s linear; transform-origin: 50% 50%; }
        .time-big { position: absolute; font-size: 70px; font-weight: 800; font-variant-numeric: tabular-nums; }
        .phase-lbl { position: absolute; top: 68%; font-size: 16px; font-weight: 600; color: var(--text-dim); letter-spacing: 2px; }
        .controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .btn-ctrl { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer;}
        .play { background: var(--text); color: var(--bg); } 
        .pause { background: var(--rest); color: white; }

        /* --- INFO MODAL --- */
        .modal-bg { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 300; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); width: 100%; max-width: 400px; border-radius: 20px; padding: 25px; max-height: 80vh; overflow-y: auto; }
        .muscle-graphic { width: 100%; height: 120px; background: var(--input-bg); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .muscle-icon { width: 60px; height: 60px; fill: var(--accent); }

        /* --- NAV --- */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; background: var(--nav-bg); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding-bottom: env(safe-area-inset-bottom); z-index: 100; backdrop-filter: blur(10px); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dim); font-size: 10px; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }

        /* --- TOGGLE SWITCH --- */
        .row-switch { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--input-bg); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--work); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* STATE COLORS */
        .state-work .ring-circle { stroke: var(--work); }
        .state-rest .ring-circle { stroke: var(--rest); }
        
        input { width: 100%; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 10px; font-size: 16px; margin-bottom: 10px; }

        @keyframes fadein { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="dark-mode">

    <div id="screen-onboarding" class="full-overlay" style="z-index: 500;">
        <h1>Willkommen üëã</h1>
        <p class="subtitle">Lass uns deinen Plan erstellen. Was sind deine Ziele?</p>
        
        <div class="grid-select" id="onboard-grid">
            <div class="select-item" onclick="toggleTarget(this, 'bauch')">
                <span class="select-icon">üç´</span>Bauch
            </div>
            <div class="select-item" onclick="toggleTarget(this, 'po')">
                <span class="select-icon">üçë</span>Po & Beine
            </div>
            <div class="select-item" onclick="toggleTarget(this, 'arme')">
                <span class="select-icon">üí™</span>Arme & Brust
            </div>
            <div class="select-item" onclick="toggleTarget(this, 'ruecken')">
                <span class="select-icon">üéí</span>R√ºcken
            </div>
        </div>

        <div style="margin-top: auto;">
            <p style="font-size: 12px; color: var(--text-dim); text-align: center;">Du kannst das sp√§ter √§ndern.</p>
            <button class="btn-main" onclick="finishOnboarding()">Plan erstellen</button>
        </div>
    </div>

    <div id="modal-reminder" class="modal-bg">
        <div class="modal-content" style="text-align: center;">
            <h2>Zeit f√ºr ein Update! üìè</h2>
            <p class="subtitle">Es ist 14 Tage her. Willst du deine K√∂rperma√üe aktualisieren, um Fortschritte zu sehen?</p>
            <button class="btn-main" onclick="switchTab('tab-stats'); closeModal('modal-reminder')">Ja, eintragen</button>
            <button class="btn-main btn-sec" onclick="closeModal('modal-reminder'); updateReminderDate()">Sp√§ter</button>
        </div>
    </div>

    <div id="modal-info" class="modal-bg">
        <div class="modal-content">
            <div class="muscle-graphic">
                <svg class="muscle-icon" viewBox="0 0 24 24"><path d="M20.57 14.86L22 13.43L20.57 12L17 15.57L8.43 7L12 3.43L10.57 2L9.14 3.43L7.71 2L5.57 4.14L4.14 2.71L2.71 4.14L4.14 5.57L2 7.71L3.43 9.14L2 10.57L3.43 12L7 8.43L15.57 17L12 20.57L13.43 22L14.86 20.57L16.29 22L18.43 19.86L19.86 21.29L21.29 19.86L19.86 18.43L22 16.29L20.57 14.86Z" /></svg>
            </div>
            <h2 id="info-title">√úbung</h2>
            <p id="info-desc" style="line-height: 1.6; color: var(--text-dim);">Beschreibung...</p>
            <button class="btn-main" onclick="closeModal('modal-info')">Verstanden</button>
        </div>
    </div>

    <div id="tab-home" class="screen active">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>Dashboard</h1>
            <div id="streak-badge" style="background:var(--input-bg); padding:5px 10px; border-radius:15px; font-size:12px;">üî• 0 Tage</div>
        </div>
        <span class="subtitle">Dein intelligenter Coach</span>

        <div class="card next-workout-card">
            <h2 style="color:var(--work); font-size:14px; text-transform:uppercase; letter-spacing:1px;">Dein n√§chstes Training</h2>
            <h1 id="next-workout-title" style="margin-bottom: 5px;">Lade Plan...</h1>
            <p id="next-workout-desc" style="color:var(--text-dim); font-size:14px;">...</p>
            <button class="btn-main" onclick="openPlayer()">Jetzt Starten</button>
        </div>

        <div class="card">
            <h2>Deine Leistung</h2>
            <div class="stat-row">
                <div class="stat-item">
                    <span class="stat-val" id="disp-cals">0</span>
                    <span class="stat-lbl">kcal gesamt</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="disp-workouts">0</span>
                    <span class="stat-lbl">Workouts</span>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-stats" class="screen">
        <h1>K√∂rperdaten</h1>
        <span class="subtitle">Tracke deine Ver√§nderung</span>
        
        <div class="card">
            <label style="font-size:12px; color:var(--text-dim)">Datum</label>
            <input type="date" id="input-date">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                <input type="number" id="input-weight" placeholder="Gewicht (kg)">
                <input type="number" id="input-waist" placeholder="Bauch (cm)">
            </div>
            <button class="btn-main" onclick="saveStats()">Speichern</button>
        </div>

        <div class="card">
            <h2>Verlauf (Gewicht)</h2>
            <div style="height: 150px; display:flex; align-items:end; gap:5px;" id="chart-area">
                <p style="width:100%; text-align:center; color:var(--text-dim); font-size:12px; align-self:center;">2 Eintr√§ge ben√∂tigt</p>
            </div>
        </div>
    </div>

    <div id="tab-settings" class="screen">
        <h1>Profil & Einstellungen</h1>
        
        <div class="card">
            <div class="row-switch">
                <span>‚òÄÔ∏è Light Mode</span>
                <label class="switch">
                    <input type="checkbox" id="theme-toggle" onchange="toggleTheme()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="card">
            <h2>Trainingsfokus √§ndern</h2>
            <p class="subtitle">Passe an, welche K√∂rperteile du trainieren willst.</p>
            <button class="btn-main btn-sec" onclick="resetOnboarding()">Fokus neu w√§hlen</button>
        </div>

        <div class="card">
            <h2>Daten</h2>
            <button class="btn-main btn-sec" onclick="exportData()">üíæ Backup speichern</button>
            <input type="file" id="import-file" style="display:none" onchange="importData(this)" accept=".json">
            <button class="btn-main btn-sec" style="margin-top:10px;" onclick="document.getElementById('import-file').click()">üìÇ Backup laden</button>
        </div>
    </div>

    <div id="view-player" class="full-overlay">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <button style="background:none; border:none; color:var(--text-dim); font-size:24px;" onclick="closePlayer()">‚úï</button>
            <div id="round-disp" style="font-weight:bold; font-size:14px;">Runde 1/3</div>
            <div style="display:flex; gap:15px;">
                <button style="background:none; border:none; font-size:20px;" onclick="restartWorkout()">‚Üª</button>
                <button style="background:none; border:none; font-size:20px;" onclick="toggleSound()" id="sound-btn">üîä</button>
            </div>
        </div>

        <div class="timer-wrap">
            <svg class="progress-ring"><circle class="ring-circle" stroke="#333" stroke-width="12" fill="transparent" r="120" cx="130" cy="130"/></svg>
            <div class="time-big" id="time-disp">00</div>
            <div class="phase-lbl" id="phase-disp">BEREIT</div>
        </div>

        <div style="text-align:center; margin-bottom:30px; min-height:80px;">
            <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                <div style="font-size:24px; font-weight:700;" id="ex-name">√úbung</div>
                <button onclick="showExerciseInfo()" style="background:var(--accent); color:white; border:none; border-radius:50%; width:24px; height:24px; font-weight:bold;">i</button>
            </div>
            <div style="color:var(--text-dim); font-size:14px; margin-top:5px;" id="next-ex">...</div>
        </div>

        <div class="controls">
            <button class="btn-ctrl play" id="main-btn" onclick="toggleTimer()">‚ñ∂</button>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="switchTab('tab-home', this)">
            <div class="nav-icon">üè†</div><span>Home</span>
        </div>
        <div class="nav-item" onclick="switchTab('tab-stats', this)">
            <div class="nav-icon">üìä</div><span>Stats</span>
        </div>
        <div class="nav-item" onclick="switchTab('tab-settings', this)">
            <div class="nav-icon">‚öôÔ∏è</div><span>Profil</span>
        </div>
    </nav>

    <script>
        // --- EXERCISE DATABASE (Bodyweight Only & Simple) ---
        // Kategorien: bauch, po, arme, ruecken
        const DB = {
            bauch: [
                { n: "Crunches", d: "R√ºckenlage, Beine anwinkeln. H√§nde an den Kopf. Nur die Schultern vom Boden heben, Bauch fest anspannen. Blick schr√§g zur Decke.", met: 4 },
                { n: "Beinheben", d: "R√ºckenlage, H√§nde unter den Po. Gestreckte Beine langsam heben und senken, ohne den Boden zu ber√ºhren. Unteren R√ºcken am Boden lassen.", met: 5 },
                { n: "Plank", d: "Unterarmst√ºtz. K√∂rper bildet eine Linie. Bauchnabel einziehen, Po nicht durchh√§ngen lassen. Halten.", met: 4 },
                { n: "Russian Twist", d: "Hinsetzen, Oberk√∂rper zur√ºcklehnen, F√º√üe leicht anheben. H√§nde abwechselnd links und rechts zum Boden f√ºhren.", met: 5 }
            ],
            po: [
                { n: "Squats", d: "Schulterbreiter Stand. Po nach hinten unten setzen (wie auf einen Stuhl). R√ºcken gerade. Gewicht auf den Fersen. Tief gehen und hochdr√ºcken.", met: 6 },
                { n: "Glute Bridges", d: "R√ºckenlage, Beine aufstellen. H√ºfte so hoch wie m√∂glich dr√ºcken. Oben Po maximal zusammenkneifen.", met: 4 },
                { n: "Lunges (R√ºckw√§rts)", d: "Gro√üer Schritt nach hinten. Hinteres Knie fast zum Boden. Vorderes Knie bleibt stabil. Abwechselnd links/rechts.", met: 6 },
                { n: "Donkey Kicks", d: "Vierf√º√ülerstand. Ein Bein angewinkelt zur Decke treten (Fu√üsohle hoch). R√ºcken gerade lassen. Nach 20 Sek wechseln.", met: 5 }
            ],
            arme: [
                { n: "Liegest√ºtze (Knie)", d: "H√§nde breiter als Schultern. Auf Knien oder F√º√üen. Brust zum Boden senken, Ellbogen ca 45 Grad zum K√∂rper. Rumpf fest.", met: 7 },
                { n: "Trizeps Dips", d: "R√ºcklings an Bettkante/Stuhl st√ºtzen. Beine lang. Po absenken und nur mit Armkraft hochdr√ºcken.", met: 5 },
                { n: "Plank to Pushup", d: "Vom Unterarmst√ºtz hochdr√ºcken in den Liegest√ºtz und wieder runter. Abwechselnd den F√ºhrungsarm √§ndern.", met: 8 },
                { n: "Shoulder Taps", d: "Liegest√ºtzposition. K√∂rper ganz ruhig halten. Abwechselnd mit der Hand an die gegen√ºberliegende Schulter tippen.", met: 5 }
            ],
            ruecken: [
                { n: "Superman", d: "Bauchlage. Arme und Beine gleichzeitig vom Boden abheben. Kurz halten, Blick zum Boden. Langsam senken.", met: 4 },
                { n: "Snow Angels (Reverse)", d: "Bauchlage, Blick zum Boden. Arme gestreckt vom Po √ºber die Seite bis √ºber den Kopf f√ºhren (Schwimmbewegung), ohne Bodenkontakt.", met: 4 },
                { n: "Br√ºcke", d: "R√ºckenlage. H√ºfte hochdr√ºcken wie bei Glute Bridge, aber Fokus auf Spannung im unteren R√ºcken (nicht √ºberstrecken).", met: 3 },
                { n: "Vierf√º√üler (Diag)", d: "Vierf√º√ülerstand. Rechter Arm und linkes Bein strecken. Kurz halten, dann Ellenbogen und Knie unter dem Bauch zusammenf√ºhren.", met: 4 }
            ]
        };

        // --- STATE ---
        let app = {
            targets: [], // ['bauch', 'po']
            plan: [], // Array of workout objects
            currentPlanIndex: 0, // Welches Workout ist dran? (0, 1, 2...)
            totalCals: 0,
            totalWorkouts: 0,
            logs: [],
            lastReminder: Date.now(),
            onboardingDone: false,
            theme: 'dark'
        };

        let session = {
            activeEx: [],
            round: 1,
            exIdx: 0,
            time: 0,
            maxTime: 0,
            isWork: false,
            running: false,
            timer: null
        };
        
        const CFG = { WORK: 40, REST: 20, PREP: 10, ROUNDS: 3 };
        let soundOn = true; let audCtx;

        // --- INIT ---
        window.onload = () => {
            loadData();
            applyTheme();
            
            if(!app.onboardingDone) {
                document.getElementById('screen-onboarding').classList.add('active');
            } else {
                checkReminder();
                updateHomeUI();
            }
            
            document.getElementById('input-date').valueAsDate = new Date();
            renderChart();
        };

        // --- ONBOARDING LOGIC ---
        let tempTargets = [];
        function toggleTarget(el, key) {
            if(tempTargets.includes(key)) {
                tempTargets = tempTargets.filter(t => t !== key);
                el.classList.remove('selected');
            } else {
                tempTargets.push(key);
                el.classList.add('selected');
            }
        }

        function finishOnboarding() {
            if(tempTargets.length === 0) return alert("Bitte mindestens einen Bereich w√§hlen!");
            app.targets = [...tempTargets];
            app.onboardingDone = true;
            generatePlan();
            document.getElementById('screen-onboarding').classList.remove('active');
            saveData();
            updateHomeUI();
        }

        function resetOnboarding() {
            app.onboardingDone = false;
            tempTargets = [];
            document.querySelectorAll('.select-item').forEach(e => e.classList.remove('selected'));
            document.getElementById('screen-onboarding').classList.add('active');
            switchTab('tab-home', document.querySelector('.nav-item')); // Reset view
        }

        // --- PLAN GENERATOR ---
        function generatePlan() {
            // Wir erstellen 3 verschiedene Workouts (A, B, C) basierend auf den Zielen
            // Wenn nur 1 Ziel: Alle 3 Workouts fokussieren darauf aber mischen √úbungen
            // Wenn viele Ziele: Split
            
            let pool = [];
            app.targets.forEach(t => pool = pool.concat(DB[t]));
            
            // Mische den Pool
            pool.sort(() => Math.random() - 0.5);

            // Erstelle 3 Pl√§ne √† 4 √úbungen
            app.plan = [];
            for(let i=0; i<3; i++) {
                // Nimm 4 √úbungen (rotierend aus dem Pool)
                let workoutEx = [];
                for(let j=0; j<4; j++) {
                    workoutEx.push(pool[(i*4 + j) % pool.length]);
                }
                app.plan.push({
                    name: `Plan ${String.fromCharCode(65+i)} (${app.targets.map(t=>t.toUpperCase()).join('/')})`,
                    ex: workoutEx
                });
            }
            app.currentPlanIndex = 0;
            saveData();
        }

        // --- HOME UI ---
        function updateHomeUI() {
            const plan = app.plan[app.currentPlanIndex % app.plan.length];
            document.getElementById('next-workout-title').innerText = plan.name;
            document.getElementById('next-workout-desc').innerText = plan.ex.map(e => e.n).join(', ');
            
            document.getElementById('disp-cals').innerText = app.totalCals;
            document.getElementById('disp-workouts').innerText = app.totalWorkouts;
        }

        function checkReminder() {
            const twoWeeks = 14 * 24 * 60 * 60 * 1000;
            if(Date.now() - app.lastReminder > twoWeeks) {
                document.getElementById('modal-reminder').style.display = 'flex';
            }
        }

        function updateReminderDate() {
            app.lastReminder = Date.now();
            saveData();
        }

        // --- PLAYER ENGINE ---
        function openPlayer() {
            const currentWorkout = app.plan[app.currentPlanIndex % app.plan.length];
            session.activeEx = currentWorkout.ex;
            session.round = 1;
            session.exIdx = 0;
            
            document.getElementById('view-player').classList.add('active');
            startPhase('PREP');
            initAudio(); // Unlock Audio on first interaction
        }

        function restartWorkout() {
            clearInterval(session.timer); session.running = false;
            session.round = 1; session.exIdx = 0; startPhase('PREP');
        }

        function startPhase(type) {
            session.isWork = (type === 'WORK');
            const phTxt = document.getElementById('phase-disp');
            const exTxt = document.getElementById('ex-name');
            const nxtTxt = document.getElementById('next-ex');
            const circle = document.querySelector('.ring-circle');
            const player = document.getElementById('view-player');

            if(type === 'PREP') {
                session.time = session.maxTime = CFG.PREP;
                phTxt.innerText = "BEREIT MACHEN";
                exTxt.innerText = session.activeEx[0].n;
                nxtTxt.innerText = "";
                player.className = "full-overlay active";
            } else if (type === 'WORK') {
                session.time = session.maxTime = CFG.WORK;
                phTxt.innerText = "GO!";
                exTxt.innerText = session.activeEx[session.exIdx].n;
                nxtTxt.innerText = "Danach: Pause";
                player.className = "full-overlay active state-work";
                playBeep('start');
            } else {
                session.time = session.maxTime = CFG.REST;
                phTxt.innerText = "PAUSE";
                exTxt.innerText = "Erholen";
                let nxt = (session.exIdx+1 < session.activeEx.length) ? session.activeEx[session.exIdx+1].n : (session.round<CFG.ROUNDS ? session.activeEx[0].n : "ENDE");
                nxtTxt.innerText = "N√§chste: " + nxt;
                player.className = "full-overlay active state-rest";
                playBeep('end');
            }
            updateTimerUI();
            if(!session.running) toggleTimer();
        }

        function tick() {
            if(session.time > 0) {
                session.time--;
                updateTimerUI();
                if(session.time <= 3) playBeep('tick');
            } else {
                nextStep();
            }
        }

        function nextStep() {
            const phTxt = document.getElementById('phase-disp').innerText;
            if(phTxt === "BEREIT MACHEN") {
                startPhase('WORK');
            } else if(session.isWork) {
                // Calc Calories (approx)
                const currentMet = session.activeEx[session.exIdx].met;
                // Formel: MET * 3.5 * weight(70kg default) / 200 * minutes
                const burned = Math.floor(currentMet * 3.5 * 70 / 200 * (CFG.WORK/60)); 
                app.totalCals += burned;

                if(session.exIdx >= session.activeEx.length - 1 && session.round >= CFG.ROUNDS) {
                    finishWorkout();
                } else {
                    startPhase('REST');
                }
            } else {
                session.exIdx++;
                if(session.exIdx >= session.activeEx.length) {
                    session.exIdx = 0;
                    session.round++;
                }
                document.getElementById('round-disp').innerText = `Runde ${session.round}/${CFG.ROUNDS}`;
                startPhase('WORK');
            }
        }

        function updateTimerUI() {
            document.getElementById('time-disp').innerText = session.time;
            const circ = 2 * Math.PI * 120; // r=120
            document.querySelector('.ring-circle').style.strokeDasharray = `${circ} ${circ}`;
            const offset = circ - ((session.time / session.maxTime) * circ);
            document.querySelector('.ring-circle').style.strokeDashoffset = session.isWork ? offset : (circ - offset);
        }

        function toggleTimer() {
            const btn = document.getElementById('main-btn');
            if(session.running) {
                clearInterval(session.timer);
                session.running = false;
                btn.innerText = "‚ñ∂"; btn.classList.remove('pause'); btn.classList.add('play');
            } else {
                session.timer = setInterval(tick, 1000);
                session.running = true;
                btn.innerText = "‚è∏"; btn.classList.remove('play'); btn.classList.add('pause');
            }
        }

        function finishWorkout() {
            clearInterval(session.timer); session.running = false;
            closePlayer();
            app.totalWorkouts++;
            app.currentPlanIndex++; // Move to next planned workout
            app.lastReminder = Date.now(); // Reset reminder timer
            saveData();
            updateHomeUI();
            alert(`Training beendet! +${Math.round(app.totalCals)} kcal verbrannt.`);
        }

        function closePlayer() {
            clearInterval(session.timer);
            document.getElementById('view-player').classList.remove('active');
        }

        // --- INFO MODAL ---
        function showExerciseInfo() {
            if(session.running) toggleTimer(); // Auto-Pause
            const ex = session.activeEx[session.exIdx];
            document.getElementById('info-title').innerText = ex.n;
            document.getElementById('info-desc').innerText = ex.d;
            document.getElementById('modal-info').style.display = 'flex';
        }

        // --- AUDIO ENGINE (Loud) ---
        function initAudio() { if(!audCtx) audCtx = new (window.AudioContext||window.webkitAudioContext)(); if(audCtx.state==='suspended') audCtx.resume(); }
        function toggleSound() { soundOn = !soundOn; document.getElementById('sound-btn').style.opacity = soundOn?1:0.5; }
        
        function playBeep(type) {
            if(!soundOn || !audCtx) return;
            const t = audCtx.currentTime;
            const osc = audCtx.createOscillator(); const g = audCtx.createGain();
            osc.connect(g); g.connect(audCtx.destination);
            osc.type = 'sawtooth'; // Aggressive wave
            
            if(type === 'start') { // Sirene hoch
                osc.frequency.setValueAtTime(400, t); osc.frequency.linearRampToValueAtTime(1000, t+0.4);
                g.gain.setValueAtTime(1, t); g.gain.linearRampToValueAtTime(0, t+0.4);
                osc.start(t); osc.stop(t+0.4);
            } else if (type === 'end') { // Sirene runter
                osc.frequency.setValueAtTime(800, t); osc.frequency.linearRampToValueAtTime(300, t+0.4);
                g.gain.setValueAtTime(1, t); g.gain.linearRampToValueAtTime(0, t+0.4);
                osc.start(t); osc.stop(t+0.4);
            } else if (type === 'tick') { // Kurzer Klick
                osc.frequency.setValueAtTime(1200, t);
                g.gain.setValueAtTime(1, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
                osc.start(t); osc.stop(t+0.1);
            }
        }

        // --- DATA & SETTINGS ---
        function saveStats() {
            const d = document.getElementById('input-date').value;
            const w = document.getElementById('input-weight').value;
            if(!d || !w) return alert("Datum & Gewicht n√∂tig.");
            app.logs.push({ date: d, val: w });
            app.logs.sort((a,b)=> new Date(a.date)-new Date(b.date));
            saveData();
            renderChart();
            alert("Gespeichert!");
        }

        function renderChart() {
            const area = document.getElementById('chart-area');
            area.innerHTML = '';
            if(app.logs.length < 2) { area.innerHTML='<p style="width:100%;text-align:center;color:#888;">2 Eintr√§ge ben√∂tigt</p>'; return; }
            
            const vals = app.logs.map(l => parseFloat(l.val));
            const min = Math.min(...vals) * 0.95; const max = Math.max(...vals) * 1.05;
            
            app.logs.forEach(l => {
                const h = ((parseFloat(l.val) - min) / (max - min)) * 100;
                const bar = document.createElement('div');
                bar.style.width = (100 / app.logs.length) + "%";
                bar.style.height = h + "%";
                bar.style.background = "var(--work)";
                bar.style.opacity = 0.6;
                area.appendChild(bar);
            });
        }

        function toggleTheme() {
            app.theme = document.getElementById('theme-toggle').checked ? 'light' : 'dark';
            applyTheme();
            saveData();
        }
        function applyTheme() {
            if(app.theme === 'light') {
                document.body.classList.add('light-mode');
                document.body.classList.remove('dark-mode');
                document.getElementById('theme-toggle').checked = true;
            } else {
                document.body.classList.add('dark-mode');
                document.body.classList.remove('light-mode');
                document.getElementById('theme-toggle').checked = false;
            }
        }

        function saveData() { localStorage.setItem('bodyPulseSmart', JSON.stringify(app)); }
        function loadData() { const d = localStorage.getItem('bodyPulseSmart'); if(d) app = Object.assign(app, JSON.parse(d)); }
        
        function exportData() {
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app));
            const a = document.createElement('a'); a.href = str; a.download = "backup.json";
            document.body.appendChild(a); a.click(); a.remove();
        }
        function importData(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => { 
                try { app = JSON.parse(e.target.result); saveData(); location.reload(); } 
                catch(x) { alert("Fehler!"); } 
            };
            r.readAsText(f);
        }

        // --- UTILS ---
        function switchTab(id, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>
