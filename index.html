<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Body Pulse V28.0 - COMPACT NAV</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <style>
        /* ======================================================================
           1. CSS GRUNDLAGEN (Vollst√§ndig ausgeschrieben)
           ====================================================================== */
        :root {
            --color-background: #000000;
            --color-card-background: #111111;
            --color-card-light: #1c1c1e;
            --color-border: #333333;
            --color-text-primary: #ffffff;
            --color-text-secondary: #8e8e93;
            --color-accent-green: #32d74b;
            --color-accent-blue: #0a84ff;
            --color-accent-orange: #ff9f0a;
            --color-accent-red: #ff453a;
            --color-accent-purple: #bf5af2;
            --font-family-system: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        html, body {
            position: fixed;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            font-family: var(--font-family-system);
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
            padding-top: var(--safe-area-top);
        }

        /* SCREEN LAYOUTS - FIX: Padding reduziert auf 100px */
        .app-screen-container {
            flex: 1;
            display: none;
            flex-direction: column;
            width: 100%;
            padding: 15px;
            padding-bottom: 100px; 
        }

        .app-screen-container.screen-active {
            display: flex;
            animation-name: fadeInAnimation;
            animation-duration: 0.3s;
            animation-timing-function: ease-out;
        }

        @keyframes fadeInAnimation {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #screen-home-tab {
            overflow: hidden;
            justify-content: space-between;
        }
        
        #screen-stats-tab, #screen-settings-tab {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* UI KARTEN */
        .ui-card {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border);
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 10px;
            position: relative;
        }

        .ui-card-compact {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border);
            border-radius: 14px;
            padding: 8px 12px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* DASHBOARD GRID */
        .dashboard-grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 6px;
        }

        .stat-display-item {
            background-color: var(--color-card-light);
            border: 1px solid #222222;
            border-radius: 10px;
            padding: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-value-text {
            font-size: 16px;
            font-weight: 800;
            color: #ffffff;
        }

        .stat-label-text {
            font-size: 9px;
            color: #888888;
            font-weight: 700;
            text-transform: uppercase;
            margin-top: 3px;
        }

        /* TEXTE */
        h1.headline-text {
            font-size: 24px;
            font-weight: 800;
            margin: 0;
            line-height: 1.1;
        }

        h2.sub-headline-text {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: #666666;
            margin: 0 0 8px 0;
            letter-spacing: 1px;
        }
        
        h2.sub-headline-compact {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            color: #666666;
            margin: 0 0 5px 0;
            letter-spacing: 1px;
        }

        /* BUTTONS */
        .primary-button {
            background-color: var(--color-text-primary);
            color: #000000;
            border: none;
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .primary-button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .outline-button {
            background-color: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .outline-button:active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .library-button {
            background-color: var(--color-card-light);
            border: 1px solid var(--color-border);
            color: #aaaaaa;
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 5px;
        }

        .small-toggle-button {
            padding: 8px;
            font-size: 11px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            background-color: transparent;
            color: #888888;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
        }
        .small-toggle-button.button-active {
            background-color: #ffffff;
            color: #000000;
            border-color: #ffffff;
        }

        /* INPUTS */
        input.text-input, select.select-input, textarea.text-area-input {
            width: 100%;
            background-color: #111111;
            border: 1px solid #333333;
            color: white;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 8px;
            font-family: inherit;
            -webkit-appearance: none;
        }
        select.select-input optgroup {
            color: var(--color-text-secondary);
            font-style: normal;
            font-weight: bold;
        }

        /* WASSER TRACKER */
        .water-tracker-row {
            display: flex;
            align-items: center;
            gap: 8px;
            height: 34px;
        }
        .water-control-button {
            width: 34px; height: 100%;
            background-color: #222222;
            border: 1px solid #333333;
            color: #ffffff;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        .water-bar-container {
            flex: 1;
            height: 10px;
            background-color: #222222;
            border-radius: 5px;
            overflow: hidden;
        }
        .water-bar-fill {
            height: 100%;
            width: 0%;
            background-color: var(--color-accent-blue);
            transition: width 0.5s ease;
        }

        /* CHECKLISTE */
        .checklist-row-item {
            display: flex;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #222222;
            cursor: pointer;
        }
        .checkbox-indicator {
            width: 22px; height: 22px;
            border: 2px solid #555555;
            border-radius: 6px;
            margin-right: 12px;
            display: flex; align-items: center; justify-content: center;
        }
        .checklist-row-item.item-checked .checkbox-indicator {
            background-color: var(--color-accent-green);
            border-color: var(--color-accent-green);
            color: #000000;
        }
        .checklist-row-item.item-checked .checkbox-indicator::after {
            content: '‚úì';
            font-weight: 900;
            font-size: 14px;
        }
        .checklist-label {
            font-size: 14px;
            color: #ffffff;
            font-weight: 500;
        }

        /* LOGBUCH ITEMS */
        .log-stack-card {
            background-color: var(--color-card-light);
            border-left: 3px solid var(--color-accent-green);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .log-set-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #aaaaaa;
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid #222222;
        }

        /* BIBLIOTHEK ITEM */
        .library-item {
            padding: 14px;
            border-bottom: 1px solid #222222;
            background: var(--color-card-light);
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
        }
        .library-item:active { background: #333333; }
        .lib-header-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
        .lib-name-text { font-weight: bold; color: white; font-size:14px; }
        .lib-category-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; background: #333333; color: #aaaaaa; }
        .lib-desc-text { font-size: 11px; color: #888888; line-height:1.4; display:block; }
        .lib-more-link { font-size: 10px; color: var(--color-accent-blue); margin-top:5px; display:block; text-transform:uppercase; font-weight:bold; }

        /* VERGLEICHS TABELLE */
        .comparison-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        .comparison-table td { padding: 8px 0; border-bottom: 1px solid #222222; font-size: 13px; color: #dddddd; }
        .comparison-table td:last-child { text-align: right; font-weight: bold; }
        .diff-positive { color: var(--color-accent-green); }
        .diff-negative { color: var(--color-accent-red); }
        .diff-neutral { color: #666666; }

        /* OVERLAYS */
        .fullscreen-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000000;
            z-index: 5000;
            display: none;
            flex-direction: column;
            padding: var(--safe-area-top) 15px 15px 15px;
        }

        .overlay-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #222222;
        }

        .overlay-scroll-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 120px;
        }
        
        .overlay-sticky-footer {
            margin-top: auto;
            padding-top: 10px;
            background-color: #000000;
        }

        .detail-text-content { font-size: 16px; line-height: 1.6; color: #dddddd; white-space: pre-wrap; }
        .detail-category-label { color: var(--color-accent-purple); font-weight: bold; text-transform: uppercase; font-size: 11px; margin-bottom: 10px; display: block; }

        /* PLAYER */
        .player-visual-circle {
            position: relative;
            width: 240px;
            height: 240px;
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-svg-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
        .player-timer-text { font-size: 80px; font-weight: 900; font-variant-numeric: tabular-nums; z-index: 2; }
        
        .player-next-exercise-box {
            background-color: #222222;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            width: 100%;
            border: 1px solid #333333;
        }
        
        .player-category-label {
            color: var(--color-accent-purple);
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .player-guide-link {
            font-size: 13px;
            color: var(--color-accent-blue);
            margin-top: 8px;
            text-align: center;
            max-width: 90%;
            line-height: 1.4;
            cursor: pointer;
            text-decoration: underline;
        }
        
        /* NEXT BOX BUTTON */
        .player-next-guide-button {
            font-size: 11px;
            color: var(--color-accent-blue);
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 5px;
            display: inline-block;
            border: 1px solid var(--color-accent-blue);
            padding: 6px 12px;
            border-radius: 6px;
            background-color: rgba(10, 132, 255, 0.1);
            cursor: pointer;
        }

        /* NAVIGATION BAR - FIX: Tiefer und kompakter */
        .bottom-navbar {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            height: auto;
            min-height: 60px; /* Reduziert von 80px */
            background-color: rgba(10,10,10,0.95);
            border-top: 1px solid #333333;
            display: flex;
            justify-content: space-around;
            padding-top: 8px;
            padding-bottom: calc(10px + var(--safe-area-bottom)); /* Dynamic Padding */
            z-index: 1000;
        }

        .nav-item-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            color: white;
            transition: 0.2s;
            cursor: pointer;
        }
        .nav-item-btn.nav-active { opacity: 1; color: var(--color-text-primary); transform: translateY(-2px); }
        .nav-icon-font { font-size: 20px; margin-bottom: 2px; } /* Kleiner */
        .nav-label-text { font-size: 9px; font-weight: 800; letter-spacing: 0.5px; }

    </style>
</head>
<body>

    <div id="overlay-setup-view" class="fullscreen-overlay" style="z-index:9000; justify-content:center;">
        <h1 style="text-align:center;">WILLKOMMEN</h1>
        <div class="ui-card" style="margin-top:20px;">
            <h2 class="sub-headline-text">PROFIL DATEN</h2>
            <input type="number" id="setup-height-input" class="text-input" placeholder="Gr√∂√üe (cm)">
            <input type="number" id="setup-weight-input" class="text-input" placeholder="Gewicht (kg)">
            <input type="number" id="setup-age-input" class="text-input" placeholder="Alter">
        </div>
        <button class="primary-button" onclick="AppController.finishSetup()">LOS GEHT'S</button>
    </div>

    <div id="overlay-daily-view" class="fullscreen-overlay">
        <div class="overlay-header-row">
            <h1 class="headline-text">DAILY CHECK</h1>
            <button class="small-toggle-button" onclick="UserInterface.closeOverlay('overlay-daily-view')">SCHLIESSEN</button>
        </div>
        <div class="overlay-scroll-content">
            <div class="ui-card">
                <div id="checklist-items-container"></div>
            </div>
            <div class="ui-card">
                <h2 class="sub-headline-text">NOTIZEN</h2>
                <textarea id="daily-note-text" class="text-area-input" style="height:120px; background:transparent; border:none; border-bottom:1px solid #333;" placeholder="Tagebuch..." oninput="AppController.saveNote(this.value)"></textarea>
            </div>
        </div>
    </div>

    <div id="overlay-library-view" class="fullscreen-overlay">
        <div class="overlay-header-row">
            <h1 class="headline-text">BIBLIOTHEK</h1>
            <button class="small-toggle-button" onclick="UserInterface.closeOverlay('overlay-library-view')">SCHLIESSEN</button>
        </div>
        <div class="overlay-scroll-content">
            <div id="library-list-container"></div>
        </div>
    </div>
    
    <div id="overlay-detail-view" class="fullscreen-overlay" style="z-index:6000;">
        <div class="overlay-header-row">
            <h1 class="headline-text" id="detail-title-text">TITEL</h1>
            <button class="small-toggle-button" onclick="UserInterface.closeOverlay('overlay-detail-view')">ZUR√úCK</button>
        </div>
        <div class="overlay-scroll-content">
            <div class="ui-card">
                <span id="detail-category-badge" class="detail-category-label">KATEGORIE</span>
                <h2 class="sub-headline-text">ANLEITUNG</h2>
                <div id="detail-content-text" class="detail-text-content"></div>
            </div>
        </div>
    </div>

    <div id="overlay-manual-view" class="fullscreen-overlay">
        <div class="overlay-header-row">
            <h1 class="headline-text">LOGBUCH</h1>
            <button class="small-toggle-button" onclick="UserInterface.closeOverlay('overlay-manual-view')">ABBRECHEN</button>
        </div>
        <div class="overlay-scroll-content">
            <div class="ui-card" style="background-color:var(--color-card-light);">
                <span style="font-size:10px; font-weight:bold; color:#888;">1. √úBUNG</span>
                <select id="manual-exercise-select" class="select-input" style="margin-bottom:10px;"></select>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <span style="font-size:10px; font-weight:bold; color:#888;">2. RUNDEN</span>
                        <input type="number" id="manual-rounds-input" class="text-input" value="3">
                    </div>
                    <div>
                        <span style="font-size:10px; font-weight:bold; color:#888;">3. WERT (Std)</span>
                        <input type="number" id="manual-value-default" class="text-input" placeholder="z.B. 40">
                    </div>
                </div>
                
                <button class="primary-button" style="margin-top:10px;" onclick="LogSystem.addToStack()">+ HINZUF√úGEN</button>
            </div>
            <div id="manual-stack-container"></div>
        </div>
        <div class="overlay-sticky-footer">
            <button class="primary-button" style="background-color:var(--color-accent-green); color:#000;" onclick="LogSystem.saveWorkout()">WORKOUT SPEICHERN</button>
        </div>
    </div>

    <div id="overlay-player-view" class="fullscreen-overlay">
        <div class="overlay-header-row">
            <button class="small-toggle-button" onclick="PlayerSystem.exitPlayer()">EXIT</button>
            <span id="player-round-display" style="font-weight:bold; color:#888;">RUNDE 1</span>
            <div id="player-mute-icon" onclick="PlayerSystem.toggleMute()" style="cursor:pointer; font-size:24px;">üîä</div>
        </div>
        
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div id="player-phase-text" style="font-size:24px; font-weight:900; color:var(--color-accent-green); letter-spacing:4px;">READY</div>
            
            <div class="player-visual-circle">
                <svg class="player-svg-container">
                    <circle cx="120" cy="120" r="110" stroke="#222" stroke-width="12" fill="none"/>
                    <circle id="player-progress-ring" cx="120" cy="120" r="110" stroke="white" stroke-width="12" fill="none" stroke-dasharray="691" stroke-dashoffset="0" style="transition:1s linear;"/>
                </svg>
                <div id="player-time-display" class="player-timer-text">10</div>
            </div>

            <div style="text-align:center;">
                <div id="player-category-display" class="player-category-label">BAUCH & CORE</div>
                <div id="player-exercise-name" style="font-size:26px; font-weight:900; line-height:1.2;">√úBUNG</div>
            </div>
            
            <div id="player-guide-text" class="player-guide-link" onclick="PlayerSystem.showCurrentDetail()">Anleitung anzeigen (Klick)</div>
            
            <div id="player-next-box" class="player-next-exercise-box" style="display:none;">
                <span style="color:#888; font-size:10px; font-weight:bold;">ALS N√ÑCHSTES:</span><br>
                <span id="player-next-name" style="font-size:18px; font-weight:bold; color:#fff;">-</span><br>
                <div class="player-next-guide-button" onclick="PlayerSystem.showNextDetail()">N√ÑCHSTE ANLEITUNG LESEN</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
            <button id="player-btn-start" class="primary-button" onclick="PlayerSystem.togglePlay()">START</button>
            <button id="player-btn-skip" class="outline-button" onclick="PlayerSystem.skipPhase()">SKIP PAUSE</button>
        </div>
    </div>

    <div id="overlay-rating-view" class="fullscreen-overlay" style="z-index:9100; justify-content:center;">
        <h1 class="headline-text" style="text-align:center;">WORKOUT BEENDET</h1>
        <p style="text-align:center; color:#888;">Wie anstrengend war es?</p>
        <div class="ui-card" style="text-align:center;">
            <h2 id="rating-value-display" style="font-size:40px; color:var(--color-accent-green); margin:10px 0;">5</h2>
            <input type="range" id="rating-slider-input" min="1" max="10" value="5" oninput="document.getElementById('rating-value-display').innerText=this.value">
            <div style="display:flex; justify-content:space-between; font-size:10px; color:#666;">
                <span>Leicht</span><span>Extrem</span>
            </div>
        </div>
        <button class="primary-button" onclick="PlayerSystem.saveRatedWorkout()">SPEICHERN & SCHLIESSEN</button>
    </div>

    <div id="screen-home-tab" class="app-screen-container screen-active">
        
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
            <div>
                <h1 id="header-day-display" class="headline-text">TAG 1</h1>
                <span id="header-date-display" style="font-size:11px; font-weight:bold; color:var(--color-accent-green);">LADEN...</span>
            </div>
            <div style="text-align:right;">
                <span style="font-size:9px; font-weight:700; color:#666; display:block;">STREAK</span>
                <span style="font-size:20px; font-weight:900; color:var(--color-accent-orange);">üî• <span id="header-streak-display">0</span></span>
            </div>
        </div>

        <div>
            <div class="dashboard-grid-layout">
                <div class="stat-display-item">
                    <span class="stat-label-text">BMI</span>
                    <span class="stat-value-text" id="kpi-bmi-value">-</span>
                </div>
                <div class="stat-display-item">
                    <span class="stat-label-text">KCAL</span>
                    <span class="stat-value-text" id="kpi-kcal-value">0</span>
                </div>
                <div class="stat-display-item">
                    <span class="stat-label-text">LEVEL</span>
                    <span class="stat-value-text" id="kpi-level-value" style="color:var(--color-accent-orange)">1</span>
                </div>
            </div>
            <div class="dashboard-grid-layout">
                <div class="stat-display-item">
                    <span class="stat-label-text">WOCHE</span>
                    <span class="stat-value-text" id="freq-week-value">0</span>
                </div>
                <div class="stat-display-item">
                    <span class="stat-label-text">MONAT</span>
                    <span class="stat-value-text" id="freq-month-value">0</span>
                </div>
                <div class="stat-display-item">
                    <span class="stat-label-text">JAHR</span>
                    <span class="stat-value-text" id="freq-year-value">0</span>
                </div>
            </div>
        </div>

        <div class="ui-card" style="padding:10px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                <h2 style="margin:0; font-size:9px;">WASSER</h2>
                <span id="water-level-text" style="font-size:10px; font-weight:bold; color:var(--color-accent-blue);">0.0L</span>
            </div>
            <div class="water-tracker-row">
                <button class="water-control-button" onclick="AppController.modifyWater(-1)">-</button>
                <div class="water-bar-container"><div id="water-progress-bar" class="water-bar-fill"></div></div>
                <button class="water-control-button" style="background-color:var(--color-accent-blue); border-color:var(--color-accent-blue);" onclick="AppController.modifyWater(1)">+</button>
            </div>
        </div>

        <div class="ui-card-compact" style="flex:1;">
            <h2 class="sub-headline-compact" style="text-align:center; margin-bottom:5px;">WORKOUT STARTEN</h2>
            <div class="dashboard-grid-layout">
                <button id="preset-btn-10" class="small-toggle-button" onclick="AppController.setDuration(10)">10 MIN</button>
                <button id="preset-btn-20" class="small-toggle-button" onclick="AppController.setDuration(20)">20 MIN</button>
                <button id="preset-btn-30" class="small-toggle-button" onclick="AppController.setDuration(30)">30 MIN</button>
            </div>
            <div style="display:flex; gap:5px; margin-bottom:8px;">
                <input type="number" id="custom-duration-input" class="text-input" placeholder="Minuten..." style="margin:0; text-align:center; padding:8px;" oninput="AppController.setCustomDuration(this.value)">
            </div>
            
            <button class="library-button" onclick="UserInterface.openLibraryOverlay()">BIBLIOTHEK ANZEIGEN</button>
            
            <div style="margin-bottom:8px;">
                <span style="font-size:9px; font-weight:bold; color:#666; margin-left:2px;">TRAININGS-FOKUS:</span>
                <select id="home-focus-select" class="select-input" style="margin-top:2px; padding:8px;">
                    <option value="all">Ganzk√∂rper (Mix)</option>
                    <option value="Bauch & Core">Bauch & Core</option>
                    <option value="Beine & Po">Beine & Po</option>
                    <option value="Oberk√∂rper">Oberk√∂rper</option>
                    <option value="Ganzk√∂rper & Cardio">Cardio Focus</option>
                </select>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                <button class="primary-button" onclick="PlayerSystem.initializePlayer()">LIVE START</button>
                <button class="outline-button" onclick="LogSystem.openOverlay()">LOGBUCH</button>
            </div>
        </div>

        <button class="outline-button" style="padding:12px; border-radius:10px; font-size:11px; font-weight:700; color:#fff; border-color:#fff; background-color: #1c1c1e;" onclick="UserInterface.openDailyOverlay()">
            DAILY CHECKLISTE & NOTIZEN
        </button>
    </div>

    <div id="screen-stats-tab" class="app-screen-container">
        <h1 class="headline-text">STATISTIK</h1>
        
        <div class="ui-card" style="margin-top:15px;">
            <h2 class="sub-headline-text">GEWICHTSVERLAUF</h2>
            <div style="height:150px; width:100%;">
                <svg id="weight-chart-svg" width="100%" height="100%" preserveAspectRatio="none" style="overflow:visible;"></svg>
            </div>
        </div>
        
        <div class="ui-card">
            <h2 class="sub-headline-text">VERGLEICH (ZULETZT)</h2>
            <div id="compare-table-container" style="padding:5px;">
                <span style="font-size:11px; color:#666;">Keine Daten zum Vergleichen.</span>
            </div>
        </div>

        <div class="ui-card">
            <h2 class="sub-headline-text">MESSUNG EINTRAGEN</h2>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <input type="number" id="measure-weight" class="text-input" placeholder="Gewicht (kg)">
                <input type="number" id="measure-waist" class="text-input" placeholder="Bauch (cm)">
                <input type="number" id="measure-chest" class="text-input" placeholder="Brust (cm)">
                <input type="number" id="measure-arm" class="text-input" placeholder="Arm (cm)">
                <input type="number" id="measure-leg" class="text-input" placeholder="Bein (cm)">
                <input type="number" id="measure-glute" class="text-input" placeholder="Po (cm)">
            </div>
            <button class="outline-button" style="margin-top:10px;" onclick="AppController.logBodyMeasurements()">WERTE SPEICHERN</button>
        </div>

        <div id="history-list-container"></div>
    </div>

    <div id="screen-settings-tab" class="app-screen-container">
        <h1 class="headline-text">SYSTEM</h1>
        
        <div class="ui-card" style="margin-top:15px;">
            <h2 class="sub-headline-text">TIMER</h2>
            <div style="display:flex; justify-content:space-between;">
                <span>Belastung</span>
                <b id="setting-work-display">40s</b>
            </div>
            <input type="range" id="setting-work-input" min="20" max="120" step="5" oninput="AppController.updateSettings()">
            
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                <span>Pausenzeit</span>
                <b id="setting-rest-display">20s</b>
            </div>
            <input type="range" id="setting-rest-input" min="10" max="60" step="5" oninput="AppController.updateSettings()">
        </div>

        <div class="ui-card">
            <h2 class="sub-headline-text">DATEN</h2>
            <button class="outline-button" style="margin-bottom:5px;" onclick="BackupSystem.exportData()">BACKUP EXPORTIEREN</button>
            <input type="file" id="backup-file-upload" style="display:none" onchange="BackupSystem.importData(this)">
            <button class="outline-button" style="margin-bottom:15px;" onclick="document.getElementById('backup-file-upload').click()">BACKUP IMPORTIEREN</button>
            <button class="outline-button" style="border-color:var(--color-accent-red); color:var(--color-accent-red);" onclick="AppController.hardReset()">APP ZUR√úCKSETZEN</button>
        </div>
    </div>

    <div class="bottom-navbar">
        <div class="nav-item-btn active" onclick="UserInterface.navigateTo('screen-home-tab', this)">
            <div class="nav-icon-font">üè†</div>
            <span class="nav-label-text">HOME</span>
        </div>
        <div class="nav-item-btn" onclick="UserInterface.navigateTo('screen-stats-tab', this)">
            <div class="nav-icon-font">üìä</div>
            <span class="nav-label-text">STATS</span>
        </div>
        <div class="nav-item-btn" onclick="UserInterface.navigateTo('screen-settings-tab', this)">
            <div class="nav-icon-font">‚öôÔ∏è</div>
            <span class="nav-label-text">SYSTEM</span>
        </div>
    </div>

    <script>
        // ======================================================
        // DATENBANK & KONSTANTEN
        // ======================================================
        const LOCAL_STORAGE_KEY = "BP_V28_COMPACT_NAV";
        
        // Vollst√§ndige √úbungsdatenbank MIT KATEGORIEN UND ANLEITUNGEN
        const EXERCISE_DB = {
            "Planks": {
                cat: "Bauch & Core",
                short: "R√ºcken gerade, Bauch fest anspannen.",
                long: "1. Lege dich auf den Bauch.\n2. St√ºtze dich auf die Unterarme, Ellbogen unter den Schultern.\n3. Hebe deinen K√∂rper an, sodass er von Kopf bis Fu√ü eine Linie bildet.\n4. Spanne Bauch und Po fest an. Vermeide ein Hohlkreuz!\n5. Halte die Position und atme ruhig weiter."
            },
            "Liegest√ºtze": {
                cat: "Oberk√∂rper",
                short: "Brust bis fast zum Boden, K√∂rper eine Linie.",
                long: "1. H√§nde etwas breiter als schulterbreit aufstellen.\n2. F√º√üe zusammen oder leicht ge√∂ffnet.\n3. K√∂rper anspannen (Linie).\n4. Senke den K√∂rper kontrolliert ab, bis die Brust fast den Boden ber√ºhrt.\n5. Dr√ºcke dich explosiv wieder nach oben."
            },
            "Kniebeugen": {
                cat: "Beine & Po",
                short: "R√ºcken gerade, Gewicht auf den Fersen, Knie stabil.",
                long: "1. Stehe schulterbreit.\n2. Schiebe den Po nach hinten unten, als w√ºrdest du dich setzen.\n3. Halte den R√ºcken gerade und die Brust oben.\n4. Gehe so tief, wie du die Spannung halten kannst.\n5. Dr√ºcke dich aus den Fersen wieder hoch."
            },
            "Crunches": {
                cat: "Bauch & Core",
                short: "Nur Schulterbl√§tter l√∂sen, ausatmen beim Hochgehen.",
                long: "1. R√ºckenlage, Beine angewinkelt aufstellen.\n2. H√§nde an die Schl√§fen (nicht am Kopf ziehen!).\n3. Hebe nur die Schulterbl√§tter vom Boden ab.\n4. Atme beim Hochgehen aus, beim Senken ein.\n5. Der untere R√ºcken bleibt am Boden."
            },
            "Ausfallschritte": {
                cat: "Beine & Po",
                short: "Vorderes Knie 90 Grad, Oberk√∂rper aufrecht halten.",
                long: "1. Mache einen gro√üen Schritt nach vorne.\n2. Senke das hintere Knie bis knapp √ºber den Boden.\n3. Beide Knie sollten ca. 90 Grad gebeugt sein.\n4. Oberk√∂rper bleibt aufrecht.\n5. Dr√ºcke dich wieder zur√ºck in den Stand und wechsle das Bein."
            },
            "Dips": {
                cat: "Oberk√∂rper",
                short: "Ellenbogen nah am K√∂rper f√ºhren, tief absenken.",
                long: "1. St√ºtze dich auf einer Erh√∂hung (Stuhl/Bank) oder am Boden ab.\n2. Beine gestreckt oder angewinkelt.\n3. Senke den Po ab, indem du die Arme beugst.\n4. Ellenbogen zeigen nach hinten, nicht nach au√üen.\n5. Dr√ºcke dich wieder hoch."
            },
            "Burpees": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Explosiver Sprung nach oben, sauberer Liegest√ºtz unten.",
                long: "1. Aus dem Stand in die Hocke, H√§nde zum Boden.\n2. Springe mit den F√º√üen nach hinten in die Liegest√ºtzposition.\n3. Absolviere einen Liegest√ºtz (optional: Brust ablegen).\n4. Springe mit den F√º√üen wieder zu den H√§nden.\n5. Mache einen Strecksprung nach oben."
            },
            "Mountain Climber": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Knie abwechselnd schnell zur Brust ziehen.",
                long: "1. Startposition: Liegest√ºtz/Plank auf den H√§nden.\n2. Ziehe abwechselnd und dynamisch ein Knie zur Brust.\n3. Halte den R√ºcken gerade und den Po tief.\n4. Bewege dich rhythmisch und schnell."
            },
            "Wandsitzen": {
                cat: "Beine & Po",
                short: "Beine im 90 Grad Winkel, R√ºcken flach an die Wand.",
                long: "1. Lehne dich mit dem R√ºcken gegen eine Wand.\n2. Rutsche nach unten, bis Ober- und Unterschenkel einen 90¬∞ Winkel bilden.\n3. Dr√ºcke den unteren R√ºcken fest gegen die Wand.\n4. Halte die Position statisch."
            },
            "Hampelmann": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Arme ganz nach oben f√ºhren, weich auf Ballen landen.",
                long: "1. Starte im aufrechten Stand, F√º√üe zusammen, Arme am K√∂rper.\n2. Springe, √∂ffne die Beine und f√ºhre die H√§nde √ºber dem Kopf zusammen.\n3. Springe zur√ºck in die Ausgangsposition.\n4. Lande weich auf den Fu√üballen."
            },
            "Beinheben": {
                cat: "Bauch & Core",
                short: "Beine gestreckt heben, unterer R√ºcken bleibt am Boden.",
                long: "1. R√ºckenlage, H√§nde unter den Po oder neben den K√∂rper.\n2. Hebe beide Beine gestreckt an, bis sie senkrecht stehen.\n3. Senke sie langsam ab, ohne den Boden zu ber√ºhren.\n4. WICHTIG: Der untere R√ºcken muss Kontakt zum Boden halten!"
            },
            "Glute Bridge": {
                cat: "Beine & Po",
                short: "H√ºfte so weit wie m√∂glich heben, Po oben fest anspannen.",
                long: "1. R√ºckenlage, F√º√üe nah am Po aufstellen.\n2. Hebe das Becken an, bis Oberschenkel und Oberk√∂rper eine Linie bilden.\n3. Spanne den Po oben maximal an.\n4. Senke das Becken kontrolliert ab (nicht ablegen)."
            },
            "High Knees": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Knie explosiv bis zur H√ºfte hochziehen, R√ºcken gerade.",
                long: "1. Laufe auf der Stelle.\n2. Ziehe dabei die Knie so hoch wie m√∂glich (H√ºfth√∂he).\n3. Nutze die Arme aktiv mit.\n4. Bleibe aufrecht im Oberk√∂rper."
            },
            "Russian Twist": {
                cat: "Bauch & Core",
                short: "Beine in der Luft, Oberk√∂rper rotieren, Boden ber√ºhren.",
                long: "1. Setze dich hin, lehne den Oberk√∂rper leicht zur√ºck.\n2. Hebe die F√º√üe vom Boden ab (Balance halten).\n3. Rotiere den Oberk√∂rper und ber√ºhre abwechselnd links und rechts den Boden.\n4. Folge den H√§nden mit dem Blick."
            },
            "Superman": {
                cat: "Bauch & Core",
                short: "Arme und Beine gleichzeitig heben, Spannung halten.",
                long: "1. Bauchlage, Arme nach vorne gestreckt.\n2. Hebe gleichzeitig Arme und Beine vom Boden ab.\n3. Halte die Spannung im unteren R√ºcken kurz.\n4. Senke alles wieder ab."
            },
            "Wadenheben": {
                cat: "Beine & Po",
                short: "Auf Zehenspitzen dr√ºcken, langsam absenken.",
                long: "1. Stehe aufrecht, F√º√üe h√ºftbreit.\n2. Dr√ºcke dich so hoch wie m√∂glich auf die Zehenspitzen.\n3. Halte kurz die Spannung in den Waden.\n4. Senke die Fersen langsam wieder ab (ohne Boden ganz zu ber√ºhren f√ºr mehr Intensit√§t)."
            },
            "Side Plank (L)": {
                cat: "Bauch & Core",
                short: "H√ºfte oben halten, K√∂rper bildet eine Linie.",
                long: "1. Lege dich auf die linke Seite.\n2. St√ºtze dich auf den linken Unterarm.\n3. Hebe die H√ºfte an, bis der K√∂rper eine gerade Linie bildet.\n4. Halte diese Position statisch."
            },
            "Side Plank (R)": {
                cat: "Bauch & Core",
                short: "H√ºfte oben halten, K√∂rper bildet eine Linie.",
                long: "1. Lege dich auf die rechte Seite.\n2. St√ºtze dich auf den rechten Unterarm.\n3. Hebe die H√ºfte an, bis der K√∂rper eine gerade Linie bildet.\n4. Halte diese Position statisch."
            },
            "Diamond Pushups": {
                cat: "Oberk√∂rper",
                short: "H√§nde bilden Raute unter der Brust, Trizeps Fokus.",
                long: "1. Liegest√ºtzposition, aber H√§nde sind direkt unter der Brust.\n2. Daumen und Zeigefinger bilden ein Dreieck/Raute.\n3. F√ºhre den Liegest√ºtz aus, Ellenbogen nah am K√∂rper.\n4. Zielmuskel: Trizeps."
            },
            "Bicycle Crunches": {
                cat: "Bauch & Core",
                short: "Ellenbogen zum gegen√ºberliegenden Knie, Bein strecken.",
                long: "1. R√ºckenlage, H√§nde an den Kopf, Beine in der Luft.\n2. F√ºhre rechten Ellenbogen zum linken Knie, w√§hrend das rechte Bein gestreckt wird.\n3. Wechsle flie√üend die Seite (wie Fahrradfahren).\n4. Drehe den Oberk√∂rper aktiv ein."
            },
            "Flutter Kicks": {
                cat: "Bauch & Core",
                short: "Beine gestreckt knapp √ºber Boden abwechselnd auf/ab.",
                long: "1. R√ºckenlage, H√§nde unter den Po.\n2. Hebe beide Beine gestreckt leicht an.\n3. Bewege sie abwechselnd kleine St√ºcke auf und ab (Paddelbewegung).\n4. R√ºcken fest am Boden lassen."
            },
            "Box Jumps": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Beidbeinig auf Erh√∂hung springen, weich landen.",
                long: "1. Stehe vor einer stabilen Box oder Erh√∂hung.\n2. Gehe leicht in die Hocke und hole Schwung.\n3. Springe beidbeinig auf die Box.\n4. Lande weich und richte dich komplett auf.\n5. Steige einzeln wieder hinab."
            },
            "Schattenboxen": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Schnelle, saubere Schl√§ge, in Bewegung bleiben.",
                long: "1. Leichte Gr√§tschstellung, F√§uste vor das Gesicht (Deckung).\n2. Schlage abwechselnd gerade nach vorne.\n3. Drehe die H√ºfte bei jedem Schlag mit ein.\n4. Bleib leichtf√º√üig in Bewegung."
            },
            "Sit-Ups": {
                cat: "Bauch & Core",
                short: "Oberk√∂rper komplett aufrichten, Wirbel f√ºr Wirbel.",
                long: "1. R√ºckenlage, Beine angewinkelt, F√º√üe am Boden.\n2. Richte den Oberk√∂rper komplett auf, bis du sitzt.\n3. Ber√ºhre evtl. deine F√º√üe.\n4. Rolle dich kontrolliert Wirbel f√ºr Wirbel wieder ab."
            },
            "Trizeps Dips": {
                cat: "Oberk√∂rper",
                short: "An Stuhl/Bank abst√ºtzen, tief beugen.",
                long: "1. Setze dich vor einen Stuhl/Sofa, H√§nde auf der Kante.\n2. Strecke die Beine aus (schwer) oder winkle sie an (leicht).\n3. Beuge die Arme, bis der Po fast den Boden ber√ºhrt.\n4. Dr√ºcke dich aus den Armen wieder hoch."
            },
            "Reverse Crunches": {
                cat: "Bauch & Core",
                short: "H√ºfte vom Boden l√∂sen, Knie zur Brust rollen.",
                long: "1. R√ºckenlage, Beine angewinkelt in der Luft.\n2. Spanne den Bauch an und rolle das Becken vom Boden ab.\n3. Ziehe die Knie Richtung Stirn.\n4. Senke das Becken langsam wieder ab."
            },
            "Plank Jacks": {
                cat: "Ganzk√∂rper & Cardio",
                short: "In Plank-Position Beine wie beim Hampelmann.",
                long: "1. Starte im Unterarmst√ºtz (Plank).\n2. Springe mit den F√º√üen auseinander (Gr√§tsche) und sofort wieder zusammen.\n3. Der Oberk√∂rper bleibt stabil, Po nicht zu hoch."
            },
            "Skater Jumps": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Seitlich springen, inneres Bein hinterkreuzen.",
                long: "1. Springe seitlich auf das rechte Bein.\n2. Kreuze das linke Bein hinter dem rechten, ohne den Boden zu ber√ºhren.\n3. Springe sofort zur anderen Seite.\n4. Nutze die Arme f√ºr Schwung."
            },
            "Donkey Kicks": {
                cat: "Beine & Po",
                short: "Vierf√º√ülerstand, Bein angewinkelt nach oben kicken.",
                long: "1. Vierf√º√ülerstand auf H√§nden und Knien.\n2. Hebe ein Bein angewinkelt (90¬∞) nach oben, als w√ºrdest du die Decke treten.\n3. Spanne den Po oben an.\n4. Senke das Bein, ohne abzusetzen."
            },
            "Fire Hydrants": {
                cat: "Beine & Po",
                short: "Vierf√º√ülerstand, Bein seitlich anheben.",
                long: "1. Vierf√º√ülerstand.\n2. Hebe ein Bein seitlich an (wie ein Hund am Hydranten), Knie bleibt gebeugt.\n3. Halte den R√ºcken gerade, nicht zur Seite kippen.\n4. Senke das Bein wieder."
            },
            "Armkreisen": {
                cat: "Oberk√∂rper",
                short: "Arme seitlich strecken, kleine schnelle Kreise.",
                long: "1. Stehe aufrecht, Arme waagerecht zur Seite gestreckt.\n2. Mache kleine, schnelle Kreise mit den Armen.\n3. Halte die Schultern tief und den Nacken entspannt.\n4. Wechsle nach der H√§lfte der Zeit die Richtung."
            },
            "Seitl. Beinheben": {
                cat: "Beine & Po",
                short: "Auf der Seite liegen, oberes Bein gestreckt heben.",
                long: "1. Lege dich auf die Seite, Kopf auf dem Arm ablegen.\n2. Das obere Bein ist gestreckt.\n3. Hebe das Bein kontrolliert so hoch wie m√∂glich.\n4. Senke es langsam, ohne es ganz abzulegen."
            },
            "K√§fer (Dead Bug)": {
                cat: "Bauch & Core",
                short: "R√ºcken flach, gegen√ºberliegenden Arm/Bein senken.",
                long: "1. R√ºckenlage, Arme senkrecht nach oben, Beine 90¬∞ in der Luft.\n2. Strecke rechten Arm nach hinten und linkes Bein nach vorne aus.\n3. R√ºcken bleibt flach am Boden!\n4. Zur√ºck zur Mitte und Seite wechseln."
            },
            "Hollow Body": {
                cat: "Bauch & Core",
                short: "Schiffchen-Position, unterer R√ºcken fest am Boden.",
                long: "1. R√ºckenlage, Arme nach hinten gestreckt.\n2. Hebe Arme, Kopf, Schultern und Beine gleichzeitig an.\n3. Der K√∂rper bildet eine bananenf√∂rmige Kurve.\n4. Der untere R√ºcken MUSS Kontakt zum Boden haben."
            },
            "Inchworm": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Aus dem Stand in Plank laufen und zur√ºck.",
                long: "1. Stehe aufrecht.\n2. Beuge dich vor, H√§nde zum Boden (Beine m√∂glichst gestreckt).\n3. Laufe mit den H√§nden nach vorne in die Plank-Position.\n4. Laufe mit den H√§nden wieder zur√ºck zu den F√º√üen und richte dich auf."
            },
            "Wall Pushups": {
                cat: "Oberk√∂rper",
                short: "Liegest√ºtz gegen Wand, K√∂rper gespannt.",
                long: "1. Stehe etwa einen Schritt von einer Wand entfernt.\n2. H√§nde auf Schulterh√∂he an die Wand.\n3. Beuge die Arme und bringe das Gesicht zur Wand.\n4. Dr√ºcke dich wieder weg. K√∂rper bleibt steif wie ein Brett."
            }
        };
        const EXERCISE_KEYS = Object.keys(EXERCISE_DB).sort();

        // Checklist Items
        const CHECKLIST_ITEMS_LIST = ["Protein Shake", "Kreatin", "Vitamine", "Eisen", "Magnesium"];

        // Globaler App Status
        let appData = {
            profile: { height:0, weight:0, age:0 },
            config: { workTime:40, restTime:20, durationPreference:10, note:"" },
            status: { 
                waterLevel:0, 
                waterDate:"", 
                checklistState:[false,false,false,false,false],
                streakCount:0, 
                lastWorkoutTimestamp:0 
            },
            historyLog: [], 
            bodyMeasurementsLog: [], 
            metaData: { installTimestamp: Date.now() }
        };

        let manualStack = [];
        let playerState = { 
            timerId:null, 
            isRunning:false, 
            timeRemaining:10, 
            phase:'PREP', 
            round:1, 
            exerciseIdx:0, 
            workoutPlan:[], 
            isCompleted:false,
            exercisesCount: 0
        };
        let audioCtx=null, isSoundOn=true;
        let tempKcalStorage = 0;

        // ======================================================
        // INITIALISIERUNG
        // ======================================================
        window.onload = function() {
            let stored = localStorage.getItem(LOCAL_STORAGE_KEY);
            if(stored) { 
                try { 
                    appData = JSON.parse(stored); 
                    AppController.checkDailyReset(); 
                    UserInterface.refreshAll();
                } catch(e) { console.log(e); }
            } else {
                document.getElementById('overlay-setup-view').style.display='flex';
            }
        };

        // ======================================================
        // APP CONTROLLER LOGIK
        // ======================================================
        const AppController = {
            saveToStorage: function() { 
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData)); 
            },
            
            finishSetup: function() {
                appData.profile.height = parseFloat(document.getElementById('setup-height-input').value)||175;
                appData.profile.weight = parseFloat(document.getElementById('setup-weight-input').value)||75;
                appData.profile.age = parseFloat(document.getElementById('setup-age-input').value)||30;
                appData.metaData.installTimestamp = Date.now();
                appData.status.waterDate = new Date().toDateString();
                this.saveToStorage(); 
                document.getElementById('overlay-setup-view').style.display='none';
                UserInterface.refreshAll();
            },

            checkDailyReset: function() {
                let todayStr = new Date().toDateString();
                if(appData.status.waterDate !== todayStr) {
                    appData.status.waterLevel = 0; 
                    appData.status.waterDate = todayStr;
                    appData.status.checklistState = new Array(CHECKLIST_ITEMS_LIST.length).fill(false);
                    this.saveToStorage();
                }
            },

            modifyWater: function(amount) { 
                appData.status.waterLevel = Math.max(0, appData.status.waterLevel + amount); 
                this.saveToStorage(); 
                UserInterface.refreshAll(); 
            },

            setDuration: function(val) { 
                appData.config.durationPreference = val; 
                document.getElementById('custom-duration-input').value=""; 
                this.saveToStorage(); 
                UserInterface.refreshAll(); 
            },

            setCustomDuration: function(val) { 
                if(val>0) { 
                    appData.config.durationPreference = parseInt(val); 
                    this.saveToStorage(); 
                    UserInterface.refreshAll(); 
                } 
            },

            saveNote: function(text) { 
                appData.config.note = text; 
                this.saveToStorage(); 
            },

            updateSettings: function() { 
                appData.config.workTime = parseInt(document.getElementById('setting-work-input').value); 
                appData.config.restTime = parseInt(document.getElementById('setting-rest-input').value); 
                this.saveToStorage(); 
                UserInterface.refreshAll(); 
            },

            logBodyMeasurements: function() {
                let logEntry = {
                    date: new Date().toISOString(),
                    w: document.getElementById('measure-weight').value,
                    b: document.getElementById('measure-waist').value,
                    c: document.getElementById('measure-chest').value,
                    h: document.getElementById('measure-glute').value,
                    a: document.getElementById('measure-arm').value,
                    l: document.getElementById('measure-leg').value
                };
                if(logEntry.w) { 
                    appData.profile.weight = parseFloat(logEntry.w); 
                    appData.bodyMeasurementsLog.push(logEntry); 
                    this.saveToStorage(); 
                    UserInterface.refreshAll(); 
                    alert("Gespeichert"); 
                }
            },

            hardReset: function() { 
                if(confirm("ALLES L√ñSCHEN?")) { 
                    localStorage.clear(); 
                    location.reload(); 
                } 
            }
        };

        // ======================================================
        // UI LOGIK
        // ======================================================
        const UserInterface = {
            refreshAll: function() {
                // Header
                let dayDiff = Math.ceil((Date.now() - appData.metaData.installTimestamp) / 86400000);
                document.getElementById('header-day-display').innerText = "TAG " + dayDiff;
                document.getElementById('header-date-display').innerText = new Date().toLocaleDateString('de-DE').toUpperCase();
                document.getElementById('header-streak-display').innerText = appData.status.streakCount;
                
                // KPIs
                let heightM = appData.profile.height / 100;
                document.getElementById('kpi-bmi-value').innerText = (appData.profile.weight / (heightM * heightM)).toFixed(1);
                
                let totalKcal = appData.historyLog.reduce((acc, item) => acc + (item.kcal || 0), 0);
                document.getElementById('kpi-kcal-value').innerText = totalKcal.toLocaleString();
                document.getElementById('kpi-level-value').innerText = 1 + Math.floor(totalKcal / 1000);

                // Wasser
                document.getElementById('water-level-text').innerText = (appData.status.waterLevel * 0.25).toFixed(1) + " / 2.5L";
                document.getElementById('water-progress-bar').style.width = Math.min((appData.status.waterLevel / 10) * 100, 100) + "%";

                // Buttons Active State
                document.querySelectorAll('.small-toggle-button').forEach(btn => btn.classList.remove('button-active'));
                let activeBtn = document.getElementById('preset-btn-' + appData.config.durationPreference);
                if(activeBtn) activeBtn.classList.add('button-active');

                // Settings Slider
                document.getElementById('setting-work-input').value = appData.config.workTime;
                document.getElementById('setting-rest-input').value = appData.config.restTime;
                document.getElementById('setting-work-display').innerText = appData.config.workTime + "s";
                document.getElementById('setting-rest-display').innerText = appData.config.restTime + "s";

                // Note
                document.getElementById('daily-note-text').value = appData.config.note;

                StatsSystem.renderAll();
            },

            navigateTo: function(screenId, navElement) {
                document.querySelectorAll('.app-screen-container').forEach(s => s.classList.remove('screen-active'));
                document.getElementById(screenId).classList.add('screen-active');
                document.querySelectorAll('.nav-item-btn').forEach(i => i.classList.remove('nav-active'));
                navElement.classList.add('nav-active');
            },

            openDailyOverlay: function() {
                let container = document.getElementById('checklist-items-container'); 
                container.innerHTML = "";
                
                CHECKLIST_ITEMS_LIST.forEach((label, index) => {
                    if(appData.status.checklistState[index] === undefined) appData.status.checklistState[index] = false;
                    
                    let div = document.createElement('div'); 
                    div.className = "checklist-row-item" + (appData.status.checklistState[index] ? " item-checked" : "");
                    div.innerHTML = `<div class="checkbox-indicator"></div><span class="checklist-label">${label}</span>`;
                    div.onclick = () => { 
                        appData.status.checklistState[index] = !appData.status.checklistState[index]; 
                        AppController.saveToStorage(); 
                        UserInterface.openDailyOverlay(); 
                    };
                    container.appendChild(div);
                });
                document.getElementById('overlay-daily-view').style.display = 'flex';
            },

            openLibraryOverlay: function() {
                let container = document.getElementById('library-list-container');
                container.innerHTML = "";
                
                EXERCISE_KEYS.forEach(key => {
                    let exercise = EXERCISE_DB[key];
                    let div = document.createElement('div');
                    div.className = "library-item";
                    div.onclick = () => { UserInterface.openDetailOverlay(key); };
                    div.innerHTML = `
                        <div class="lib-header-row">
                            <span class="lib-name-text">${key}</span>
                            <span class="lib-category-badge">${exercise.cat}</span>
                        </div>
                        <span class="lib-desc-text">${exercise.short}</span>
                        <span class="lib-more-link">ANLEITUNG √ñFFNEN ‚ñ∏</span>
                    `;
                    container.appendChild(div);
                });
                document.getElementById('overlay-library-view').style.display = 'flex';
            },
            
            openDetailOverlay: function(exerciseKey) {
                let exercise = EXERCISE_DB[exerciseKey];
                document.getElementById('detail-title-text').innerText = exerciseKey;
                document.getElementById('detail-category-badge').innerText = exercise.cat;
                document.getElementById('detail-content-text').innerText = exercise.long;
                document.getElementById('overlay-detail-view').style.display = 'flex';
            },

            closeOverlay: function(id) {
                document.getElementById(id).style.display = 'none';
            }
        };

        // ======================================================
        // LOG SYSTEM LOGIK
        // ======================================================
        const LogSystem = {
            openOverlay: function() {
                manualStack = []; 
                this.renderStack();
                let select = document.getElementById('manual-exercise-select'); 
                select.innerHTML = "";
                
                // Gruppieren der √úbungen f√ºr das Dropdown
                let groups = {};
                EXERCISE_KEYS.forEach(key => {
                    let cat = EXERCISE_DB[key].cat;
                    if(!groups[cat]) groups[cat] = [];
                    groups[cat].push(key);
                });

                // Dropdown f√ºllen mit optgroups
                Object.keys(groups).sort().forEach(cat => {
                    let group = document.createElement('optgroup');
                    group.label = cat;
                    groups[cat].forEach(exName => {
                        let opt = document.createElement('option');
                        opt.value = exName;
                        opt.innerText = exName;
                        group.appendChild(opt);
                    });
                    select.appendChild(group);
                });

                document.getElementById('overlay-manual-view').style.display = 'flex';
            },

            addToStack: function() {
                let name = document.getElementById('manual-exercise-select').value;
                if(!name) return; 

                let rounds = parseInt(document.getElementById('manual-rounds-input').value);
                let defaultVal = document.getElementById('manual-value-default').value || 0;
                
                let entry = { name: name, sets: [] }; 
                for(let i=0; i<rounds; i++) {
                    entry.sets.push({ value: defaultVal });
                }
                manualStack.push(entry); 
                this.renderStack();
            },

            renderStack: function() {
                let container = document.getElementById('manual-stack-container'); 
                container.innerHTML = "";
                
                manualStack.forEach((entry, index) => {
                    let div = document.createElement('div'); 
                    div.className = "log-stack-card";
                    let html = `<div style="display:flex;justify-content:space-between"><b>${entry.name}</b><span onclick="manualStack.splice(${index},1);LogSystem.renderStack()" style="color:var(--color-accent-red);font-weight:bold;cursor:pointer;">‚úï</span></div>`;
                    
                    entry.sets.forEach((set, setIdx) => {
                        html += `<div class="log-set-detail-row"><span>Satz ${setIdx+1}</span><input type="number" value="${set.value}" oninput="manualStack[${index}].sets[${setIdx}].value=this.value" style="width:60px;margin:0;padding:4px;text-align:right;"></div>`;
                    });
                    div.innerHTML = html; 
                    container.appendChild(div);
                });
            },

            saveWorkout: function() {
                if(manualStack.length === 0) return;
                let totalSets = manualStack.reduce((acc, item) => acc + item.sets.length, 0);
                tempKcalStorage = totalSets * 15;
                document.getElementById('overlay-manual-view').style.display = 'none';
                document.getElementById('overlay-rating-view').style.display = 'flex';
            }
        };

        // ======================================================
        // PLAYER SYSTEM LOGIK
        // ======================================================
        const PlayerSystem = {
            initializePlayer: function() {
                if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
                
                // 1. Berechnung der Anzahl √úbungen basierend auf Zeit
                // Formel: Gesamtsekunden / (Work + Rest)
                let totalSeconds = appData.config.durationPreference * 60;
                let cycleSeconds = appData.config.workTime + appData.config.restTime;
                let exerciseCount = Math.floor(totalSeconds / cycleSeconds);
                // Mindestens 1 √úbung
                if(exerciseCount < 1) exerciseCount = 1;
                
                playerState.exercisesCount = exerciseCount;

                // 2. Generiere Workout basierend auf FOKUS
                let focus = document.getElementById('home-focus-select').value;
                let poolMain = [];
                let poolOther = [];
                
                EXERCISE_KEYS.forEach(key => {
                    let cat = EXERCISE_DB[key].cat;
                    if(focus === 'all') {
                        poolMain.push(key);
                    } else {
                        if(cat === focus) poolMain.push(key);
                        else poolOther.push(key);
                    }
                });

                let plan = [];
                
                if(focus === 'all') {
                    // Zuf√§llig mischen
                    for(let i=0; i<exerciseCount; i++) {
                        plan.push(poolMain[Math.floor(Math.random() * poolMain.length)]);
                    }
                } else {
                    // Gewichtet: ca 70% Fokus, 30% Rest
                    let mainCount = Math.ceil(exerciseCount * 0.7);
                    let otherCount = exerciseCount - mainCount;
                    
                    for(let i=0; i<mainCount; i++) {
                        if(poolMain.length > 0) plan.push(poolMain[Math.floor(Math.random() * poolMain.length)]);
                        else if(poolOther.length > 0) plan.push(poolOther[Math.floor(Math.random() * poolOther.length)]);
                    }
                    for(let i=0; i<otherCount; i++) {
                        if(poolOther.length > 0) plan.push(poolOther[Math.floor(Math.random() * poolOther.length)]);
                        else if(poolMain.length > 0) plan.push(poolMain[Math.floor(Math.random() * poolMain.length)]);
                    }
                    // Mischen, damit Fokus nicht nur am Anfang kommt
                    plan.sort(() => 0.5 - Math.random());
                }

                playerState.workoutPlan = plan;
                playerState.round = 1; 
                playerState.exerciseIdx = 0; 
                playerState.phase = 'PREP'; 
                playerState.timeRemaining = 10; 
                playerState.isCompleted = false;
                
                document.getElementById('overlay-player-view').style.display = 'flex';
                this.drawUI();
            },

            togglePlay: function() {
                let btn = document.getElementById('player-btn-start');
                if(playerState.isRunning) { 
                    clearInterval(playerState.timerId); 
                    playerState.isRunning = false; 
                    btn.innerText = "WEITER"; 
                } else { 
                    playerState.timerId = setInterval(this.tick, 1000); 
                    playerState.isRunning = true; 
                    btn.innerText = "PAUSE"; 
                }
            },

            tick: function() {
                if(playerState.timeRemaining > 0) { 
                    playerState.timeRemaining--; 
                    if(playerState.timeRemaining < 4 && playerState.timeRemaining > 0) PlayerSystem.beep(600); 
                    PlayerSystem.drawUI(); 
                } else { 
                    PlayerSystem.beep(900); 
                    PlayerSystem.nextPhase(); 
                }
            },

            nextPhase: function() {
                if(playerState.phase === 'PREP') { 
                    playerState.phase = 'WORK'; 
                    playerState.timeRemaining = appData.config.workTime; 
                } else if(playerState.phase === 'WORK') { 
                    // Pr√ºfen ob letzte √úbung
                    if(playerState.exerciseIdx >= playerState.workoutPlan.length - 1) {
                        PlayerSystem.finish();
                        return;
                    }
                    playerState.phase = 'REST'; 
                    playerState.timeRemaining = appData.config.restTime; 
                } else {
                    playerState.exerciseIdx++;
                    playerState.phase = 'WORK'; 
                    playerState.timeRemaining = appData.config.workTime;
                }
                PlayerSystem.drawUI();
            },

            skipPhase: function() { 
                if(playerState.phase !== 'WORK') { 
                    playerState.timeRemaining = 0; 
                    PlayerSystem.nextPhase(); 
                } else { 
                    alert("WORKOUT L√ÑUFT!"); 
                } 
            },

            drawUI: function() {
                document.getElementById('player-time-display').innerText = playerState.timeRemaining;
                document.getElementById('player-phase-text').innerText = playerState.phase;
                
                let maxTime = playerState.phase === 'WORK' ? appData.config.workTime : (playerState.phase === 'REST' ? appData.config.restTime : 10);
                let offset = 691 - (playerState.timeRemaining / maxTime) * 691;
                document.getElementById('player-progress-ring').style.strokeDashoffset = offset;

                // Anzeige Logik
                
                let currentExName = playerState.workoutPlan[playerState.exerciseIdx];
                let nextExName = (playerState.exerciseIdx + 1 < playerState.workoutPlan.length) ? playerState.workoutPlan[playerState.exerciseIdx + 1] : "ENDE";
                
                if(playerState.phase === 'WORK' || playerState.phase === 'PREP') {
                    let exData = EXERCISE_DB[currentExName];
                    document.getElementById('player-exercise-name').innerText = currentExName.toUpperCase();
                    document.getElementById('player-category-display').innerText = exData.cat;
                    document.getElementById('player-guide-text').style.display = 'block';
                    document.getElementById('player-next-box').style.display = 'none';
                    
                    document.getElementById('player-round-display').innerText = `√úBUNG ${playerState.exerciseIdx + 1} / ${playerState.workoutPlan.length}`;
                } else {
                    // PAUSE
                    document.getElementById('player-exercise-name').innerText = "PAUSE";
                    document.getElementById('player-category-display').innerText = "ERHOLUNG";
                    document.getElementById('player-guide-text').style.display = 'none';
                    
                    document.getElementById('player-next-box').style.display = 'block';
                    document.getElementById('player-next-name').innerText = nextExName;
                }
                
                let skipBtn = document.getElementById('player-btn-skip');
                if(playerState.phase === 'WORK') { 
                    skipBtn.style.opacity = 0.3; 
                    skipBtn.innerText = "GESPERRT"; 
                    skipBtn.style.pointerEvents = 'none';
                } else { 
                    skipBtn.style.opacity = 1; 
                    skipBtn.innerText = "SKIP PAUSE"; 
                    skipBtn.style.pointerEvents = 'auto';
                }
            },
            
            showCurrentDetail: function() {
                let exName = playerState.workoutPlan[playerState.exerciseIdx];
                UserInterface.openDetailOverlay(exName);
            },
            
            showNextDetail: function() {
                if(playerState.exerciseIdx + 1 < playerState.workoutPlan.length) {
                    let nextName = playerState.workoutPlan[playerState.exerciseIdx + 1];
                    UserInterface.openDetailOverlay(nextName);
                }
            },

            finish: function() {
                clearInterval(playerState.timerId);
                tempKcalStorage = appData.config.durationPreference * 8; // Grobe Sch√§tzung
                document.getElementById('overlay-player-view').style.display = 'none';
                document.getElementById('overlay-rating-view').style.display = 'flex';
            },

            saveRatedWorkout: function() {
                let rating = document.getElementById('rating-slider-input').value;
                let type = document.getElementById('overlay-player-view').style.display === 'none' ? "Live Training" : "Logbuch";
                if(manualStack.length > 0) type = "Logbuch";
                
                appData.historyLog.push({ 
                    date: new Date().toISOString(), 
                    type: type, 
                    kcal: tempKcalStorage, 
                    rating: rating 
                });
                
                StatsSystem.updateStreak(); 
                AppController.saveToStorage(); 
                UserInterface.refreshAll();
                document.getElementById('overlay-rating-view').style.display = 'none';
                alert("Training gespeichert!");
            },

            exitPlayer: function() { 
                clearInterval(playerState.timerId); 
                document.getElementById('overlay-player-view').style.display = 'none'; 
            },
            
            beep: function(freq) { 
                if(isSoundOn && audioCtx) { 
                    let osc = audioCtx.createOscillator();
                    let gain = audioCtx.createGain(); 
                    osc.connect(gain); 
                    gain.connect(audioCtx.destination); 
                    osc.frequency.value = freq; 
                    gain.gain.value = 0.1; 
                    osc.start(); 
                    osc.stop(audioCtx.currentTime + 0.1); 
                } 
            },
            
            toggleMute: function() { 
                isSoundOn = !isSoundOn; 
                document.getElementById('player-mute-icon').innerText = isSoundOn ? "üîä" : "üîá"; 
            }
        };

        // ======================================================
        // STATISTIK SYSTEM
        // ======================================================
        const StatsSystem = {
            updateStreak: function() {
                let lastDate = new Date(appData.status.lastWorkoutTimestamp).toDateString();
                let today = new Date().toDateString();
                if(lastDate !== today) { 
                    appData.status.streakCount++; 
                    appData.status.lastWorkoutTimestamp = Date.now(); 
                }
            },

            renderAll: function() {
                let now = new Date();
                let weekC=0, monthC=0, yearC=0;
                let startW = new Date(now); startW.setDate(now.getDate() - now.getDay() + 1); startW.setHours(0,0,0,0);
                let startM = new Date(now.getFullYear(), now.getMonth(), 1);
                let startY = new Date(now.getFullYear(), 0, 1);

                appData.historyLog.forEach(h => {
                    let d = new Date(h.date);
                    if(d >= startW) weekC++;
                    if(d >= startM) monthC++;
                    if(d >= startY) yearC++;
                });

                document.getElementById('freq-week-value').innerText = weekC;
                document.getElementById('freq-month-value').innerText = monthC;
                document.getElementById('freq-year-value').innerText = yearC;

                let svg = document.getElementById('weight-chart-svg'); 
                svg.innerHTML = "";
                if(appData.bodyMeasurementsLog.length > 1) {
                    let vals = appData.bodyMeasurementsLog.map(l => parseFloat(l.w));
                    let min = Math.min(...vals) - 1;
                    let max = Math.max(...vals) + 1;
                    let pts = vals.map((w, i) => `${(i / (vals.length - 1)) * 100},${100 - ((w - min) / (max - min) * 100)}`).join(' ');
                    svg.innerHTML = `<polyline points="${pts}" fill="none" stroke="#32d74b" stroke-width="3"/>`;
                }

                // VERGLEICHS TABELLE RENDERN
                let compareContainer = document.getElementById('compare-table-container');
                if(appData.bodyMeasurementsLog.length >= 2) {
                    let current = appData.bodyMeasurementsLog[appData.bodyMeasurementsLog.length - 1];
                    let previous = appData.bodyMeasurementsLog[appData.bodyMeasurementsLog.length - 2];
                    
                    let keys = [
                        {id:'w', label:'Gewicht'},
                        {id:'b', label:'Bauch'},
                        {id:'c', label:'Brust'},
                        {id:'a', label:'Arm'},
                        {id:'l', label:'Bein'},
                        {id:'g', label:'Po'}
                    ];

                    let html = `<table class="comparison-table">`;
                    keys.forEach(k => {
                        let valCurr = parseFloat(current[k.id]);
                        let valPrev = parseFloat(previous[k.id]);
                        
                        if(!isNaN(valCurr) && !isNaN(valPrev)) {
                            let diff = valCurr - valPrev;
                            let diffStr = (diff > 0 ? "+" : "") + diff.toFixed(1);
                            
                            // Logik f√ºr Farbe
                            let colorClass = "diff-neutral";
                            if(k.id === 'w') {
                                if(diff < 0) colorClass = "diff-positive";
                                else if(diff > 0) colorClass = "diff-negative";
                            } else {
                                if(diff > 0) colorClass = "diff-positive";
                                else if(diff < 0) colorClass = "diff-negative";
                            }

                            if(diff === 0) colorClass = "diff-neutral";

                            html += `<tr>
                                <td>${k.label}</td>
                                <td>${valCurr}</td>
                                <td class="${colorClass}">${diffStr}</td>
                            </tr>`;
                        }
                    });
                    html += `</table><div style="margin-top:5px; font-size:9px; color:#666; text-align:right;">Vergleich zum ${new Date(previous.date).toLocaleDateString()}</div>`;
                    compareContainer.innerHTML = html;
                } else {
                    compareContainer.innerHTML = `<span style="font-size:11px; color:#666;">Mindestens 2 Messungen f√ºr Vergleich ben√∂tigt.</span>`;
                }

                let list = document.getElementById('history-list-container'); 
                list.innerHTML = "<h2>VERLAUF</h2>";
                [...appData.historyLog].reverse().slice(0, 15).forEach(h => {
                    let div = document.createElement('div'); 
                    div.className = "ui-card";
                    let ratingStr = h.rating ? ` ‚Ä¢ Int: ${h.rating}/10` : "";
                    div.innerHTML = `<div style="display:flex;justify-content:space-between;font-size:12px"><b>${h.type}</b><span>${new Date(h.date).toLocaleDateString()}</span></div><div style="font-size:11px;color:#888">${h.kcal} kcal${ratingStr}</div>`;
                    list.appendChild(div);
                });
            }
        };

        // ======================================================
        // BACKUP SYSTEM
        // ======================================================
        const BackupSystem = {
            exportData: function() {
                let blob = new Blob([JSON.stringify(appData)], {type:'application/json'});
                let a = document.createElement('a'); 
                a.href = URL.createObjectURL(blob); 
                a.download = 'bodypulse_backup.json'; 
                a.click();
            },
            importData: function(el) {
                let reader = new FileReader();
                reader.onload = e => { 
                    appData = JSON.parse(e.target.result); 
                    AppController.saveToStorage(); 
                    location.reload(); 
                };
                reader.readAsText(el.files[0]);
            }
        };
    </script>
</body>
</html>
