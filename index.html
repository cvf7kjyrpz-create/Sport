<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Body Pulse V22.1 - ULTIMATE UNCOMPRESSED</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <style>
        /* ======================================================================
           SEKTION 1: GRUNDLEGENDE CSS-VARIABLEN UND RESET
           ====================================================================== */
        :root {
            /* Farbpalette - High Contrast Dark Mode */
            --color-background: #000000;
            --color-card-background: #111111;
            --color-card-light: #1c1c1e;
            --color-border: #333333;
            
            /* Textfarben */
            --color-text-primary: #ffffff;
            --color-text-secondary: #8e8e93;
            
            /* Akzentfarben */
            --color-accent-green: #32d74b;
            --color-accent-blue: #0a84ff;
            --color-accent-orange: #ff9f0a;
            --color-accent-red: #ff453a;
            
            /* System Schriftart */
            --font-family-system: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
            
            /* Safe Area Insets f√ºr iPhone Notch/Dynamic Island */
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* Globaler Reset */
        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            /* WICHTIG: touch-action NICHT auf 'none' setzen f√ºr Alles, sonst gehen Buttons nicht */
        }

        html, body {
            position: fixed;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            font-family: var(--font-family-system);
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
            padding-top: var(--safe-area-top);
        }

        /* ======================================================================
           SEKTION 2: SCREEN-LAYOUTS UND NAVIGATION
           ====================================================================== */
        .app-screen-container {
            flex: 1;
            display: none; /* Standardm√§√üig ausgeblendet */
            flex-direction: column;
            width: 100%;
            padding: 15px;
            padding-bottom: 90px; /* Platz f√ºr die untere Navigationsleiste */
        }

        /* Animation beim Wechseln der Screens */
        .app-screen-container.screen-active {
            display: flex;
            animation-name: fadeInAnimation;
            animation-duration: 0.3s;
            animation-timing-function: ease-out;
        }

        @keyframes fadeInAnimation {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Spezifisches Layout f√ºr den Home-Screen (kein Scrollen) */
        #screen-home-tab {
            overflow: hidden;
            justify-content: space-between;
        }
        
        /* Layout f√ºr scrollbare Screens (Stats, Settings) */
        #screen-stats-tab, #screen-settings-tab {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* ======================================================================
           SEKTION 3: UI KARTEN, TEXTE UND GRIDS
           ====================================================================== */
        .ui-card {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border);
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 10px;
            position: relative;
        }

        /* Das Grid f√ºr die Dashboard-Elemente */
        .dashboard-grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 6px;
        }

        /* Einzelne Statistik-Box im Dashboard */
        .stat-display-item {
            background-color: var(--color-card-light);
            border: 1px solid #222222;
            border-radius: 10px;
            padding: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-value-text {
            font-size: 16px;
            font-weight: 800;
            color: #ffffff;
            display: block;
        }

        .stat-label-text {
            font-size: 9px;
            color: #888888;
            font-weight: 700;
            text-transform: uppercase;
            margin-top: 3px;
            display: block;
        }

        /* √úberschriften */
        h1.headline-text {
            font-size: 24px;
            font-weight: 800;
            margin: 0;
            line-height: 1.1;
        }

        h2.sub-headline-text {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: #666666;
            margin: 0 0 8px 0;
            letter-spacing: 1px;
        }

        /* ======================================================================
           SEKTION 4: BUTTONS UND EINGABEFELDER
           ====================================================================== */
        .primary-button {
            background-color: var(--color-text-primary);
            color: #000000;
            border: none;
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }
        .primary-button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .outline-button {
            background-color: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .outline-button:active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .small-toggle-button {
            padding: 8px;
            font-size: 11px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            background-color: transparent;
            color: #888888;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
        }
        .small-toggle-button.button-active {
            background-color: #ffffff;
            color: #000000;
            border-color: #ffffff;
        }

        /* Eingabefelder */
        input.text-input, select.select-input, textarea.text-area-input {
            width: 100%;
            background-color: #111111;
            border: 1px solid #333333;
            color: white;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 8px;
            font-family: inherit;
            -webkit-appearance: none;
        }

        /* ======================================================================
           SEKTION 5: SPEZIELLE MODULE (WASSER, CHECKLISTE, LOG)
           ====================================================================== */
        
        /* Wasser Tracker (Kompakt Design) */
        .water-tracker-row {
            display: flex;
            align-items: center;
            gap: 8px;
            height: 34px;
        }
        .water-control-button {
            width: 34px; height: 100%;
            background-color: #222222;
            border: 1px solid #333333;
            color: #ffffff;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        .water-bar-container {
            flex: 1;
            height: 10px;
            background-color: #222222;
            border-radius: 5px;
            overflow: hidden;
        }
        .water-bar-fill {
            height: 100%;
            width: 0%;
            background-color: var(--color-accent-blue);
            transition: width 0.5s ease;
        }

        /* Checklisten Items */
        .checklist-row-item {
            display: flex;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #222222;
            cursor: pointer;
        }
        .checkbox-indicator {
            width: 22px; height: 22px;
            border: 2px solid #555555;
            border-radius: 6px;
            margin-right: 12px;
            display: flex; align-items: center; justify-content: center;
        }
        .checklist-row-item.item-checked .checkbox-indicator {
            background-color: var(--color-accent-green);
            border-color: var(--color-accent-green);
            color: #000000;
        }
        .checklist-row-item.item-checked .checkbox-indicator::after {
            content: '‚úì';
            font-weight: 900;
            font-size: 14px;
        }
        .checklist-label {
            font-size: 14px;
            color: #ffffff;
            font-weight: 500;
        }

        /* Manual Log Stack Eintr√§ge */
        .log-stack-card {
            background-color: var(--color-card-light);
            border-left: 3px solid var(--color-accent-green);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .log-set-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #aaaaaa;
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid #222222;
        }

        /* ======================================================================
           SEKTION 6: VOLLBILD OVERLAYS (POPUP FENSTER)
           ====================================================================== */
        .fullscreen-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000000;
            z-index: 5000;
            display: none; /* JS schaltet dies auf Flex */
            flex-direction: column;
            padding: var(--safe-area-top) 15px 15px 15px;
        }

        .overlay-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #222222;
        }

        .overlay-scroll-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 60px; /* Platz f√ºr Sticky Footer */
        }
        
        .overlay-sticky-footer {
            margin-top: auto;
            padding-top: 10px;
            background-color: #000000;
        }

        /* Player Design Elemente */
        .player-visual-circle {
            position: relative;
            width: 240px;
            height: 240px;
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-svg-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            transform: rotate(-90deg);
        }
        .player-timer-text {
            font-size: 80px;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
            z-index: 2;
        }
        .player-next-exercise-box {
            background-color: #222222;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            width: 100%;
            border: 1px solid #333333;
        }
        .player-guide-text {
            font-size: 13px;
            color: #aaaaaa;
            margin-top: 8px;
            text-align: center;
            max-width: 90%;
            line-height: 1.4;
        }

        /* ======================================================================
           SEKTION 7: UNTERE NAVIGATIONSLEISTE
           ====================================================================== */
        .bottom-navbar {
            position: fixed;
            bottom: 0; left: 0; width: 100%; height: 80px;
            background-color: rgba(10,10,10,0.95);
            border-top: 1px solid #333333;
            display: flex;
            justify-content: space-around;
            padding-bottom: var(--safe-area-bottom);
            z-index: 1000;
        }

        .nav-item-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            color: white;
            transition: 0.2s;
            cursor: pointer;
        }
        .nav-item-btn.nav-active {
            opacity: 1;
            color: var(--color-text-primary);
            transform: translateY(-2px);
        }

        .nav-icon-font {
            font-size: 24px;
            margin-bottom: 3px;
        }
        .nav-label-text {
            font-size: 9px;
            font-weight: 800;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>

    <div id="overlay-setup-view" class="fullscreen-overlay" style="z-index:9000; justify-content:center;">
        <h1 style="text-align:center;">WILLKOMMEN</h1>
        <div class="ui-card" style="margin-top:20px;">
            <h2 class="sub-headline-text">PROFIL DATEN EINGEBEN</h2>
            <input type="number" id="setup-height-input" class="text-input" placeholder="Gr√∂√üe (cm)">
            <input type="number" id="setup-weight-input" class="text-input" placeholder="Gewicht (kg)">
            <input type="number" id="setup-age-input" class="text-input" placeholder="Alter">
        </div>
        <button class="primary-button" onclick="AppController.finishSetup()">LOS GEHT'S</button>
    </div>

    <div id="screen-home-tab" class="app-screen-container screen-active">
        
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
            <div>
                <h1 id="header-day-display" class="headline-text">TAG 1</h1>
                <span id="header-date-display" style="font-size:11px; font-weight:bold; color:var(--color-accent-green);">LADEN...</span>
            </div>
            <div style="text-align:right;">
                <span style="font-size:9px; font-weight:700; color:#666; display:block;">STREAK</span>
                <span style="font-size:20px; font-weight:900; color:var(--color-accent-orange);">üî• <span id="header-streak-display">0</span></span>
            </div>
        </div>

        <div>
            <div class="dashboard-grid-layout">
                <div class="stat-display-item">
                    <span class="stat-label-text">BMI</span>
                    <span class="stat-value-text" id="kpi-bmi-value">-</span>
                </div>
                <div class="stat-display-item">
                    <span class="stat-label-text">KCAL</span>
                    <span class="stat-value-text" id="kpi-kcal-value">0</span>
                </div>
                <div class="stat-display-item">
                    <span class="stat-label-text">LEVEL</span>
                    <span class="stat-value-text" id="kpi-level-value" style="color:var(--color-accent-orange)">1</span>
                </div>
            </div>
            <div class="dashboard-grid-layout">
                <div class="stat-display-item">
                    <span class="stat-label-text">WOCHE</span>
                    <span class="stat-value-text" id="freq-week-value">0</span>
                </div>
                <div class="stat-display-item">
                    <span class="stat-label-text">MONAT</span>
                    <span class="stat-value-text" id="freq-month-value">0</span>
                </div>
                <div class="stat-display-item">
                    <span class="stat-label-text">JAHR</span>
                    <span class="stat-value-text" id="freq-year-value">0</span>
                </div>
            </div>
        </div>

        <div class="ui-card" style="padding:10px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                <h2 style="margin:0; font-size:9px;">WASSER</h2>
                <span id="water-level-text" style="font-size:10px; font-weight:bold; color:var(--color-accent-blue);">0.0L</span>
            </div>
            <div class="water-tracker-row">
                <button class="water-control-button" onclick="AppController.modifyWater(-1)">-</button>
                <div class="water-bar-container"><div id="water-progress-bar" class="water-bar-fill"></div></div>
                <button class="water-control-button" style="background-color:var(--color-accent-blue); border-color:var(--color-accent-blue);" onclick="AppController.modifyWater(1)">+</button>
            </div>
        </div>

        <div class="ui-card" style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <h2 class="sub-headline-text" style="margin-bottom:10px;">WORKOUT STARTEN</h2>
            <div class="dashboard-grid-layout">
                <button id="preset-btn-10" class="small-toggle-button" onclick="AppController.setDuration(10)">10 MIN</button>
                <button id="preset-btn-20" class="small-toggle-button" onclick="AppController.setDuration(20)">20 MIN</button>
                <button id="preset-btn-30" class="small-toggle-button" onclick="AppController.setDuration(30)">30 MIN</button>
            </div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="number" id="custom-duration-input" class="text-input" placeholder="Eigene Zeit (Minuten)" style="margin:0; text-align:center;" oninput="AppController.setCustomDuration(this.value)">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                <button class="primary-button" onclick="PlayerSystem.initializePlayer()">LIVE START</button>
                <button class="outline-button" onclick="LogSystem.openOverlay()">LOGBUCH</button>
            </div>
        </div>

        <button class="outline-button" style="padding:14px; border-radius:12px; font-size:12px; font-weight:800; color:#fff; border-color:#fff; background-color: #1c1c1e;" onclick="UserInterface.openDailyOverlay()">
            DAILY CHECKLISTE & NOTIZEN √ñFFNEN
        </button>
    </div>

    <div id="screen-stats-tab" class="app-screen-container">
        <h1 class="headline-text">STATISTIK</h1>
        
        <div class="ui-card" style="margin-top:15px;">
            <h2 class="sub-headline-text">GEWICHTSVERLAUF</h2>
            <div style="height:150px; width:100%;">
                <svg id="weight-chart-svg" width="100%" height="100%" preserveAspectRatio="none" style="overflow:visible;"></svg>
            </div>
        </div>
        
        <div class="ui-card">
            <h2 class="sub-headline-text">K√ñRPERDATEN LOGGEN</h2>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <input type="number" id="measure-weight" class="text-input" placeholder="Gewicht (kg)">
                <input type="number" id="measure-waist" class="text-input" placeholder="Bauch (cm)">
                <input type="number" id="measure-chest" class="text-input" placeholder="Brust (cm)">
                <input type="number" id="measure-arm" class="text-input" placeholder="Arm (cm)">
                <input type="number" id="measure-leg" class="text-input" placeholder="Bein (cm)">
                <input type="number" id="measure-glute" class="text-input" placeholder="Po (cm)">
            </div>
            <button class="outline-button" style="margin-top:10px;" onclick="AppController.logBodyMeasurements()">WERTE SPEICHERN</button>
        </div>

        <div id="history-list-container">
            </div>
    </div>

    <div id="screen-settings-tab" class="app-screen-container">
        <h1 class="headline-text">SYSTEM</h1>
        
        <div class="ui-card" style="margin-top:15px;">
            <h2 class="sub-headline-text">TIMER EINSTELLUNGEN</h2>
            <div style="display:flex; justify-content:space-between;">
                <span>Belastung</span>
                <b id="setting-work-display">40s</b>
            </div>
            <input type="range" id="setting-work-input" min="20" max="120" step="5" oninput="AppController.updateSettings()">
            
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                <span>Pausenzeit</span>
                <b id="setting-rest-display">20s</b>
            </div>
            <input type="range" id="setting-rest-input" min="10" max="60" step="5" oninput="AppController.updateSettings()">
        </div>

        <div class="ui-card">
            <h2 class="sub-headline-text">DATENVERWALTUNG</h2>
            <button class="outline-button" style="margin-bottom:5px;" onclick="BackupSystem.exportData()">BACKUP EXPORTIEREN</button>
            
            <input type="file" id="backup-file-upload" style="display:none" onchange="BackupSystem.importData(this)">
            <button class="outline-button" style="margin-bottom:15px;" onclick="document.getElementById('backup-file-upload').click()">BACKUP IMPORTIEREN</button>
            
            <button class="outline-button" style="border-color:var(--color-accent-red); color:var(--color-accent-red);" onclick="AppController.hardReset()">APP ZUR√úCKSETZEN</button>
        </div>
    </div>

    <div id="overlay-daily-view" class="fullscreen-overlay">
        <div class="overlay-header-row">
            <h1 class="headline-text">DAILY CHECK</h1>
            <button class="small-toggle-button" onclick="UserInterface.closeOverlay('overlay-daily-view')">SCHLIESSEN</button>
        </div>
        <div class="overlay-scroll-content">
            <div class="ui-card">
                <div id="checklist-items-container"></div>
            </div>
            <div class="ui-card">
                <h2 class="sub-headline-text">NOTIZEN</h2>
                <textarea id="daily-note-text" class="text-area-input" style="height:120px; background:transparent; border:none; border-bottom:1px solid #333;" placeholder="Tagebuch..." oninput="AppController.saveNote(this.value)"></textarea>
            </div>
        </div>
    </div>

    <div id="overlay-manual-view" class="fullscreen-overlay">
        <div class="overlay-header-row">
            <h1 class="headline-text">LOGBUCH</h1>
            <button class="small-toggle-button" onclick="UserInterface.closeOverlay('overlay-manual-view')">ABBRECHEN</button>
        </div>
        <div class="overlay-scroll-content">
            <div class="ui-card" style="background-color:var(--color-card-light);">
                <span style="font-size:10px; font-weight:bold; color:#888;">1. √úBUNG W√ÑHLEN</span>
                <select id="manual-exercise-select" class="select-input" style="margin-bottom:10px;"></select>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <span style="font-size:10px; font-weight:bold; color:#888;">2. RUNDEN</span>
                        <input type="number" id="manual-rounds-input" class="text-input" value="3">
                    </div>
                    <div>
                        <span style="font-size:10px; font-weight:bold; color:#888;">3. WERT (Std)</span>
                        <input type="number" id="manual-value-default" class="text-input" placeholder="z.B. 40">
                    </div>
                </div>
                
                <button class="primary-button" style="margin-top:10px;" onclick="LogSystem.addToStack()">+ HINZUF√úGEN</button>
            </div>
            <div id="manual-stack-container"></div>
        </div>
        <div class="overlay-sticky-footer">
            <button class="primary-button" style="background-color:var(--color-accent-green); color:#000;" onclick="LogSystem.saveWorkout()">WORKOUT SPEICHERN</button>
        </div>
    </div>

    <div id="overlay-player-view" class="fullscreen-overlay">
        <div class="overlay-header-row">
            <button class="small-toggle-button" onclick="PlayerSystem.exitPlayer()">EXIT</button>
            <span id="player-round-display" style="font-weight:bold; color:#888;">RUNDE 1</span>
            <div id="player-mute-icon" onclick="PlayerSystem.toggleMute()" style="cursor:pointer; font-size:24px;">üîä</div>
        </div>
        
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div id="player-phase-text" style="font-size:24px; font-weight:900; color:var(--color-accent-green); letter-spacing:4px;">READY</div>
            
            <div class="player-visual-circle">
                <svg class="player-svg-container">
                    <circle cx="120" cy="120" r="110" stroke="#222" stroke-width="12" fill="none"/>
                    <circle id="player-progress-ring" cx="120" cy="120" r="110" stroke="white" stroke-width="12" fill="none" stroke-dasharray="691" stroke-dashoffset="0" style="transition:1s linear;"/>
                </svg>
                <div id="player-time-display" class="player-timer-text">10</div>
            </div>

            <div id="player-exercise-name" style="font-size:26px; font-weight:900; text-align:center;">√úBUNG</div>
            <div id="player-guide-text" class="player-guide-text">Anleitung...</div>
            
            <div id="player-next-box" class="player-next-exercise-box" style="display:none;">
                <span style="color:#888; font-size:10px; font-weight:bold;">ALS N√ÑCHSTES:</span><br>
                <span id="player-next-name" style="font-size:18px; font-weight:bold; color:#fff;">-</span>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
            <button id="player-btn-start" class="primary-button" onclick="PlayerSystem.togglePlay()">START</button>
            <button id="player-btn-skip" class="outline-button" onclick="PlayerSystem.skipPhase()">SKIP PAUSE</button>
        </div>
    </div>

    <div id="overlay-rating-view" class="fullscreen-overlay" style="z-index:9100; justify-content:center;">
        <h1 class="headline-text" style="text-align:center;">WORKOUT BEENDET</h1>
        <p style="text-align:center; color:#888;">Wie anstrengend war es?</p>
        <div class="ui-card" style="text-align:center;">
            <h2 id="rating-value-display" style="font-size:40px; color:var(--color-accent-green); margin:10px 0;">5</h2>
            <input type="range" id="rating-slider-input" min="1" max="10" value="5" oninput="document.getElementById('rating-value-display').innerText=this.value">
            <div style="display:flex; justify-content:space-between; font-size:10px; color:#666;">
                <span>Leicht</span><span>Extrem</span>
            </div>
        </div>
        <button class="primary-button" onclick="PlayerSystem.saveRatedWorkout()">SPEICHERN & SCHLIESSEN</button>
    </div>

    <div class="bottom-navbar">
        <div class="nav-item-btn active" onclick="UserInterface.navigateTo('screen-home-tab', this)">
            <div class="nav-icon-font">üè†</div>
            <span class="nav-label-text">HOME</span>
        </div>
        <div class="nav-item-btn" onclick="UserInterface.navigateTo('screen-stats-tab', this)">
            <div class="nav-icon-font">üìä</div>
            <span class="nav-label-text">STATS</span>
        </div>
        <div class="nav-item-btn" onclick="UserInterface.navigateTo('screen-settings-tab', this)">
            <div class="nav-icon-font">‚öôÔ∏è</div>
            <span class="nav-label-text">SYSTEM</span>
        </div>
    </div>

    <script>
        // ======================================================
        // KONSTANTEN & DATEN
        // ======================================================
        const LOCAL_STORAGE_KEY = "BODY_PULSE_V22_FINAL";
        
        // √úbungsdatenbank mit Anleitungen
        const EXERCISE_DB = {
            "Planks": "R√ºcken gerade, Bauch fest anspannen.",
            "Liegest√ºtze": "Brust bis fast zum Boden, K√∂rper eine Linie.",
            "Kniebeugen": "R√ºcken gerade, Knie nicht √ºber Zehenspitzen.",
            "Crunches": "Schulterbl√§tter vom Boden l√∂sen, ausatmen.",
            "Ausfallschritte": "Knie 90 Grad, Oberk√∂rper aufrecht.",
            "Dips": "Ellenbogen nah am K√∂rper, tief gehen.",
            "Burpees": "Sprung explosiv, sauberer Liegest√ºtz.",
            "Mountain Climber": "Knie schnell zur Brust ziehen.",
            "Wandsitzen": "Beine 90 Grad, R√ºcken flach an die Wand.",
            "Hampelmann": "Arme ganz nach oben, weich landen.",
            "Beinheben": "Beine gestreckt, unterer R√ºcken am Boden.",
            "Glute Bridge": "H√ºfte ganz nach oben, Po anspannen."
        };
        const EXERCISE_KEYS = Object.keys(EXERCISE_DB);

        // Standard Checklist Items (Hier definiert)
        const CHECKLIST_ITEMS_LIST = ["Protein Shake", "Kreatin", "Vitamine", "Eisen", "Magnesium"];

        // Globales Datenobjekt
        let appData = {
            profile: { height:0, weight:0, age:0 },
            config: { workTime:40, restTime:20, durationPreference:10, note:"" },
            status: { 
                waterLevel:0, 
                waterDate:"", 
                checklistState:[false,false,false,false,false], // Muss L√§nge von CHECKLIST_ITEMS_LIST haben
                streakCount:0, 
                lastWorkoutTimestamp:0 
            },
            historyLog: [], 
            bodyMeasurementsLog: [], 
            metaData: { installTimestamp: Date.now() }
        };

        // Tempor√§re Variablen
        let manualStack = [];
        let playerState = { 
            timerId:null, 
            isRunning:false, 
            timeRemaining:10, 
            phase:'PREP', 
            round:1, 
            exerciseIdx:0, 
            workoutPlan:[], 
            isCompleted:false 
        };
        let audioCtx=null, isSoundOn=true;
        let tempKcalStorage = 0;

        // ======================================================
        // INITIALISIERUNG
        // ======================================================
        window.onload = function() {
            let stored = localStorage.getItem(LOCAL_STORAGE_KEY);
            if(stored) { 
                try { 
                    appData = JSON.parse(stored); 
                    AppController.checkDailyReset(); 
                    UserInterface.refreshAll();
                } catch(e) {
                    console.log(e);
                }
            } else {
                document.getElementById('overlay-setup-view').style.display='flex';
            }
        };

        // ======================================================
        // APP CONTROLLER LOGIK
        // ======================================================
        const AppController = {
            saveToStorage: function() { 
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData)); 
            },
            
            finishSetup: function() {
                appData.profile.height = parseFloat(document.getElementById('setup-height-input').value)||175;
                appData.profile.weight = parseFloat(document.getElementById('setup-weight-input').value)||75;
                appData.profile.age = parseFloat(document.getElementById('setup-age-input').value)||30;
                appData.metaData.installTimestamp = Date.now();
                appData.status.waterDate = new Date().toDateString();
                this.saveToStorage(); 
                document.getElementById('overlay-setup-view').style.display='none';
                UserInterface.refreshAll();
            },

            checkDailyReset: function() {
                let todayStr = new Date().toDateString();
                if(appData.status.waterDate !== todayStr) {
                    appData.status.waterLevel = 0; 
                    appData.status.waterDate = todayStr;
                    // Reset Checkliste auf korrekte L√§nge
                    appData.status.checklistState = new Array(CHECKLIST_ITEMS_LIST.length).fill(false);
                    this.saveToStorage();
                }
            },

            modifyWater: function(amount) { 
                appData.status.waterLevel = Math.max(0, appData.status.waterLevel + amount); 
                this.saveToStorage(); 
                UserInterface.refreshAll(); 
            },

            setDuration: function(val) { 
                appData.config.durationPreference = val; 
                document.getElementById('custom-duration-input').value=""; 
                this.saveToStorage(); 
                UserInterface.refreshAll(); 
            },

            setCustomDuration: function(val) { 
                if(val>0) { 
                    appData.config.durationPreference = parseInt(val); 
                    this.saveToStorage(); 
                    UserInterface.refreshAll(); 
                } 
            },

            saveNote: function(text) { 
                appData.config.note = text; 
                this.saveToStorage(); 
            },

            updateSettings: function() { 
                appData.config.workTime = parseInt(document.getElementById('setting-work-input').value); 
                appData.config.restTime = parseInt(document.getElementById('setting-rest-input').value); 
                this.saveToStorage(); 
                UserInterface.refreshAll(); 
            },

            logBodyMeasurements: function() {
                let logEntry = {
                    date: new Date().toISOString(),
                    w: document.getElementById('measure-weight').value,
                    b: document.getElementById('measure-waist').value,
                    c: document.getElementById('measure-chest').value,
                    h: document.getElementById('measure-glute').value,
                    a: document.getElementById('measure-arm').value,
                    l: document.getElementById('measure-leg').value
                };
                if(logEntry.w) { 
                    appData.profile.weight = parseFloat(logEntry.w); 
                    appData.bodyMeasurementsLog.push(logEntry); 
                    this.saveToStorage(); 
                    UserInterface.refreshAll(); 
                    alert("Gespeichert"); 
                }
            },

            hardReset: function() { 
                if(confirm("ALLES L√ñSCHEN?")) { 
                    localStorage.clear(); 
                    location.reload(); 
                } 
            }
        };

        // ======================================================
        // UI LOGIK
        // ======================================================
        const UserInterface = {
            refreshAll: function() {
                // Header Daten
                let dayDiff = Math.ceil((Date.now() - appData.metaData.installTimestamp) / 86400000);
                document.getElementById('header-day-display').innerText = "TAG " + dayDiff;
                document.getElementById('header-date-display').innerText = new Date().toLocaleDateString('de-DE').toUpperCase();
                document.getElementById('header-streak-display').innerText = appData.status.streakCount;
                
                // KPIs
                let heightM = appData.profile.height / 100;
                document.getElementById('kpi-bmi-value').innerText = (appData.profile.weight / (heightM * heightM)).toFixed(1);
                
                let totalKcal = appData.historyLog.reduce((acc, item) => acc + (item.kcal || 0), 0);
                document.getElementById('kpi-kcal-value').innerText = totalKcal.toLocaleString();
                document.getElementById('kpi-level-value').innerText = 1 + Math.floor(totalKcal / 1000);

                // Wasser
                document.getElementById('water-level-text').innerText = (appData.status.waterLevel * 0.25).toFixed(1) + " / 2.5L";
                document.getElementById('water-progress-bar').style.width = Math.min((appData.status.waterLevel / 10) * 100, 100) + "%";

                // Buttons Active State
                document.querySelectorAll('.small-toggle-button').forEach(btn => btn.classList.remove('button-active'));
                let activeBtn = document.getElementById('preset-btn-' + appData.config.durationPreference);
                if(activeBtn) activeBtn.classList.add('button-active');

                // Settings Slider
                document.getElementById('setting-work-input').value = appData.config.workTime;
                document.getElementById('setting-rest-input').value = appData.config.restTime;
                document.getElementById('setting-work-display').innerText = appData.config.workTime + "s";
                document.getElementById('setting-rest-display').innerText = appData.config.restTime + "s";

                // Note
                document.getElementById('daily-note-text').value = appData.config.note;

                StatsSystem.renderAll();
            },

            navigateTo: function(screenId, navElement) {
                document.querySelectorAll('.app-screen-container').forEach(s => s.classList.remove('screen-active'));
                document.getElementById(screenId).classList.add('screen-active');
                document.querySelectorAll('.nav-item-btn').forEach(i => i.classList.remove('nav-active'));
                navElement.classList.add('nav-active');
            },

            openDailyOverlay: function() {
                let container = document.getElementById('checklist-items-container'); 
                container.innerHTML = "";
                
                CHECKLIST_ITEMS_LIST.forEach((label, index) => {
                    // Safe Check
                    if(appData.status.checklistState[index] === undefined) appData.status.checklistState[index] = false;
                    
                    let div = document.createElement('div'); 
                    div.className = "checklist-row-item" + (appData.status.checklistState[index] ? " item-checked" : "");
                    div.innerHTML = `<div class="checkbox-indicator"></div><span class="checklist-label">${label}</span>`;
                    
                    div.onclick = () => { 
                        appData.status.checklistState[index] = !appData.status.checklistState[index]; 
                        AppController.saveToStorage(); 
                        UserInterface.openDailyOverlay(); // Refresh
                    };
                    container.appendChild(div);
                });
                document.getElementById('overlay-daily-view').style.display = 'flex';
            },

            closeOverlay: function(id) {
                document.getElementById(id).style.display = 'none';
            }
        };

        // ======================================================
        // LOG SYSTEM LOGIK
        // ======================================================
        const LogSystem = {
            openOverlay: function() {
                manualStack = []; 
                this.renderStack();
                let select = document.getElementById('manual-exercise-select'); 
                select.innerHTML = "";
                EXERCISE_KEYS.forEach(key => { 
                    let opt = document.createElement('option'); 
                    opt.value = key; 
                    opt.innerText = key; 
                    select.appendChild(opt); 
                });
                document.getElementById('overlay-manual-view').style.display = 'flex';
            },

            addToStack: function() {
                let name = document.getElementById('manual-exercise-select').value;
                let rounds = parseInt(document.getElementById('manual-rounds-input').value);
                let defaultVal = document.getElementById('manual-value-default').value || 0;
                
                let entry = { name: name, sets: [] }; 
                for(let i=0; i<rounds; i++) {
                    entry.sets.push({ value: defaultVal });
                }
                manualStack.push(entry); 
                this.renderStack();
            },

            renderStack: function() {
                let container = document.getElementById('manual-stack-container'); 
                container.innerHTML = "";
                
                manualStack.forEach((entry, index) => {
                    let div = document.createElement('div'); 
                    div.className = "log-stack-card";
                    let html = `<div style="display:flex;justify-content:space-between"><b>${entry.name}</b><span onclick="manualStack.splice(${index},1);LogSystem.renderStack()" style="color:var(--color-accent-red);font-weight:bold;cursor:pointer;">‚úï</span></div>`;
                    
                    entry.sets.forEach((set, setIdx) => {
                        html += `<div class="log-set-detail-row"><span>Satz ${setIdx+1}</span><input type="number" value="${set.value}" oninput="manualStack[${index}].sets[${setIdx}].value=this.value" style="width:60px;margin:0;padding:4px;text-align:right;"></div>`;
                    });
                    div.innerHTML = html; 
                    container.appendChild(div);
                });
            },

            saveWorkout: function() {
                if(manualStack.length === 0) return;
                let totalSets = manualStack.reduce((acc, item) => acc + item.sets.length, 0);
                tempKcalStorage = totalSets * 15;
                document.getElementById('overlay-manual-view').style.display = 'none';
                document.getElementById('overlay-rating-view').style.display = 'flex';
            }
        };

        // ======================================================
        // PLAYER SYSTEM LOGIK
        // ======================================================
        const PlayerSystem = {
            initializePlayer: function() {
                if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
                
                playerState.workoutPlan = [...EXERCISE_KEYS].sort(() => 0.5 - Math.random()).slice(0, 6);
                playerState.round = 1; 
                playerState.exerciseIdx = 0; 
                playerState.phase = 'PREP'; 
                playerState.timeRemaining = 10; 
                playerState.isCompleted = false;
                
                document.getElementById('overlay-player-view').style.display = 'flex';
                this.drawUI();
            },

            togglePlay: function() {
                let btn = document.getElementById('player-btn-start');
                if(playerState.isRunning) { 
                    clearInterval(playerState.timerId); 
                    playerState.isRunning = false; 
                    btn.innerText = "WEITER"; 
                } else { 
                    playerState.timerId = setInterval(this.tick, 1000); 
                    playerState.isRunning = true; 
                    btn.innerText = "PAUSE"; 
                }
            },

            tick: function() {
                if(playerState.timeRemaining > 0) { 
                    playerState.timeRemaining--; 
                    if(playerState.timeRemaining < 4 && playerState.timeRemaining > 0) PlayerSystem.beep(600); 
                    PlayerSystem.drawUI(); 
                } else { 
                    PlayerSystem.beep(900); 
                    PlayerSystem.nextPhase(); 
                }
            },

            nextPhase: function() {
                if(playerState.phase === 'PREP') { 
                    playerState.phase = 'WORK'; 
                    playerState.timeRemaining = appData.config.workTime; 
                } else if(playerState.phase === 'WORK') { 
                    playerState.phase = 'REST'; 
                    playerState.timeRemaining = appData.config.restTime; 
                } else {
                    playerState.exerciseIdx++;
                    if(playerState.exerciseIdx >= 6) {
                        playerState.exerciseIdx = 0; 
                        playerState.round++;
                        let maxRounds = appData.config.durationPreference === 10 ? 1 : (appData.config.durationPreference === 20 ? 2 : 3);
                        if(playerState.round > maxRounds) { 
                            PlayerSystem.finish(); 
                            return; 
                        }
                    }
                    playerState.phase = 'WORK'; 
                    playerState.timeRemaining = appData.config.workTime;
                }
                PlayerSystem.drawUI();
            },

            skipPhase: function() { 
                if(playerState.phase !== 'WORK') { 
                    playerState.timeRemaining = 0; 
                    PlayerSystem.nextPhase(); 
                } else { 
                    alert("WORKOUT L√ÑUFT!"); 
                } 
            },

            drawUI: function() {
                document.getElementById('player-time-display').innerText = playerState.timeRemaining;
                document.getElementById('player-phase-text').innerText = playerState.phase;
                
                let maxTime = playerState.phase === 'WORK' ? appData.config.workTime : (playerState.phase === 'REST' ? appData.config.restTime : 10);
                let offset = 691 - (playerState.timeRemaining / maxTime) * 691;
                document.getElementById('player-progress-ring').style.strokeDashoffset = offset;

                let exName = playerState.workoutPlan[playerState.exerciseIdx];
                document.getElementById('player-exercise-name').innerText = exName.toUpperCase();
                document.getElementById('player-guide-text').innerText = EXERCISE_DB[exName];

                let nextBox = document.getElementById('player-next-box');
                if(playerState.phase === 'REST' || playerState.phase === 'PREP') {
                    nextBox.style.display = 'block';
                    let nextName = (playerState.phase === 'PREP') ? exName : (playerState.exerciseIdx+1 < 6 ? playerState.workoutPlan[playerState.exerciseIdx+1] : "N√ÑCHSTE RUNDE");
                    document.getElementById('player-next-name').innerText = nextName;
                } else {
                    nextBox.style.display = 'none';
                }

                let skipBtn = document.getElementById('player-btn-skip');
                if(playerState.phase === 'WORK') { 
                    skipBtn.style.opacity = 0.3; 
                    skipBtn.innerText = "GESPERRT"; 
                    skipBtn.style.pointerEvents = 'none';
                } else { 
                    skipBtn.style.opacity = 1; 
                    skipBtn.innerText = "SKIP PAUSE"; 
                    skipBtn.style.pointerEvents = 'auto';
                }
            },

            finish: function() {
                clearInterval(playerState.timerId);
                tempKcalStorage = appData.config.durationPreference * 8;
                document.getElementById('overlay-player-view').style.display = 'none';
                document.getElementById('overlay-rating-view').style.display = 'flex';
            },

            saveRatedWorkout: function() {
                let rating = document.getElementById('rating-slider-input').value;
                let type = document.getElementById('overlay-player-view').style.display === 'none' ? "Live Training" : "Logbuch";
                if(manualStack.length > 0) type = "Logbuch";
                
                appData.historyLog.push({ 
                    date: new Date().toISOString(), 
                    type: type, 
                    kcal: tempKcalStorage, 
                    rating: rating 
                });
                
                StatsSystem.updateStreak(); 
                AppController.saveToStorage(); 
                UserInterface.refreshAll();
                document.getElementById('overlay-rating-view').style.display = 'none';
                alert("Training gespeichert!");
            },

            exitPlayer: function() { 
                clearInterval(playerState.timerId); 
                document.getElementById('overlay-player-view').style.display = 'none'; 
            },
            
            beep: function(freq) { 
                if(isSoundOn && audioCtx) { 
                    let osc = audioCtx.createOscillator();
                    let gain = audioCtx.createGain(); 
                    osc.connect(gain); 
                    gain.connect(audioCtx.destination); 
                    osc.frequency.value = freq; 
                    gain.gain.value = 0.1; 
                    osc.start(); 
                    osc.stop(audioCtx.currentTime + 0.1); 
                } 
            },
            
            toggleMute: function() { 
                isSoundOn = !isSoundOn; 
                document.getElementById('player-mute-icon').innerText = isSoundOn ? "üîä" : "üîá"; 
            }
        };

        // ======================================================
        // STATISTIK SYSTEM
        // ======================================================
        const StatsSystem = {
            updateStreak: function() {
                let lastDate = new Date(appData.status.lastWorkoutTimestamp).toDateString();
                let today = new Date().toDateString();
                if(lastDate !== today) { 
                    appData.status.streakCount++; 
                    appData.status.lastWorkoutTimestamp = Date.now(); 
                }
            },

            renderAll: function() {
                let now = new Date();
                let weekC=0, monthC=0, yearC=0;
                let startW = new Date(now); startW.setDate(now.getDate() - now.getDay() + 1); startW.setHours(0,0,0,0);
                let startM = new Date(now.getFullYear(), now.getMonth(), 1);
                let startY = new Date(now.getFullYear(), 0, 1);

                appData.historyLog.forEach(h => {
                    let d = new Date(h.date);
                    if(d >= startW) weekC++;
                    if(d >= startM) monthC++;
                    if(d >= startY) yearC++;
                });

                document.getElementById('freq-week-value').innerText = weekC;
                document.getElementById('freq-month-value').innerText = monthC;
                document.getElementById('freq-year-value').innerText = yearC;

                let svg = document.getElementById('weight-chart-svg'); 
                svg.innerHTML = "";
                if(appData.bodyMeasurementsLog.length > 1) {
                    let vals = appData.bodyMeasurementsLog.map(l => parseFloat(l.w));
                    let min = Math.min(...vals) - 1;
                    let max = Math.max(...vals) + 1;
                    let pts = vals.map((w, i) => `${(i / (vals.length - 1)) * 100},${100 - ((w - min) / (max - min) * 100)}`).join(' ');
                    svg.innerHTML = `<polyline points="${pts}" fill="none" stroke="#32d74b" stroke-width="3"/>`;
                }

                let list = document.getElementById('history-list-container'); 
                list.innerHTML = "<h2>VERLAUF</h2>";
                [...appData.historyLog].reverse().slice(0, 15).forEach(h => {
                    let div = document.createElement('div'); 
                    div.className = "ui-card";
                    let ratingStr = h.rating ? ` ‚Ä¢ Int: ${h.rating}/10` : "";
                    div.innerHTML = `<div style="display:flex;justify-content:space-between;font-size:12px"><b>${h.type}</b><span>${new Date(h.date).toLocaleDateString()}</span></div><div style="font-size:11px;color:#888">${h.kcal} kcal${ratingStr}</div>`;
                    list.appendChild(div);
                });
            }
        };

        // ======================================================
        // BACKUP SYSTEM
        // ======================================================
        const BackupSystem = {
            exportData: function() {
                let blob = new Blob([JSON.stringify(appData)], {type:'application/json'});
                let a = document.createElement('a'); 
                a.href = URL.createObjectURL(blob); 
                a.download = 'bodypulse_backup.json'; 
                a.click();
            },
            importData: function(el) {
                let reader = new FileReader();
                reader.onload = e => { 
                    appData = JSON.parse(e.target.result); 
                    AppController.saveToStorage(); 
                    location.reload(); 
                };
                reader.readAsText(el.files[0]);
            }
        };
    </script>
</body>
</html>
