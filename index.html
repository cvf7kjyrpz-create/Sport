<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Body Pulse V21.1 - ULTIMATE ROBUST</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <style>
        /* ======================================================================
           1. BASIS DESIGN & VARIABLEN
           ====================================================================== */
        :root {
            --color-background: #000000;
            --color-surface: #111111;
            --color-surface-light: #1c1c1e;
            --color-border: #333333;
            --color-text-primary: #ffffff;
            --color-text-secondary: #8e8e93;
            
            --color-accent: #32d74b;
            --color-blue: #0a84ff;
            --color-orange: #ff9f0a;
            --color-red: #ff453a;
            
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        html, body {
            position: fixed;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            font-family: var(--font-stack);
            overflow: hidden;
            touch-action: none;
        }

        body {
            display: flex;
            flex-direction: column;
            padding-top: var(--safe-area-top);
        }

        /* ======================================================================
           2. SCREEN & LAYOUT MANAGEMENT
           ====================================================================== */
        .app-screen {
            flex: 1;
            display: none;
            flex-direction: column;
            width: 100%;
            padding: 15px;
            padding-bottom: 90px; /* Platz f√ºr Navbar */
        }

        .app-screen.active-screen {
            display: flex;
            animation: fadeInEffect 0.3s ease-out;
        }

        @keyframes fadeInEffect {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* SPEZIAL: HOME SCREEN (NICHT SCROLLBAR) */
        #screen-home {
            overflow: hidden;
            justify-content: space-between; /* Verteilt Elemente oben/mitte/unten */
        }

        /* ANDERE SCREENS (SCROLLBAR) */
        #screen-stats, #screen-settings {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* ======================================================================
           3. UI KOMPONENTEN
           ====================================================================== */
        .content-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 10px;
            position: relative;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 6px;
        }

        .stat-display-box {
            background-color: var(--color-surface-light);
            border: 1px solid #222;
            border-radius: 10px;
            padding: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-value-text {
            font-size: 16px;
            font-weight: 800;
            color: #fff;
        }

        .stat-label-text {
            font-size: 9px;
            color: #666;
            font-weight: 700;
            text-transform: uppercase;
            margin-top: 3px;
        }

        h1.main-title {
            font-size: 24px;
            font-weight: 800;
            margin: 0;
            line-height: 1.1;
        }

        h2.sub-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: #666;
            margin: 0 0 8px 0;
            letter-spacing: 1px;
        }

        /* BUTTONS */
        .action-button {
            background-color: var(--color-text-primary);
            color: #000;
            border: none;
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-button:active { opacity: 0.8; transform: scale(0.98); }

        .button-outline {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }

        .button-small {
            padding: 8px;
            font-size: 11px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            background: transparent;
            color: #888;
            cursor: pointer;
        }
        .button-small.active-preset {
            background-color: #fff;
            color: #000;
            border-color: #fff;
        }

        .button-disabled {
            opacity: 0.3;
            pointer-events: none;
            background-color: #222;
            border-color: #333;
            color: #666;
        }

        /* INPUTS */
        input, select, textarea {
            width: 100%;
            background-color: #111;
            border: 1px solid #333;
            color: white;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 8px;
            font-family: inherit;
            -webkit-appearance: none;
        }

        /* ======================================================================
           4. FEATURE: WASSER TRACKER (KOMPAKT)
           ====================================================================== */
        .water-compact-row {
            display: flex;
            align-items: center;
            gap: 8px;
            height: 32px;
        }
        .water-action-btn {
            width: 32px; height: 100%;
            background-color: #222;
            border: 1px solid #333;
            color: #fff;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
        .water-bar-track {
            flex: 1;
            height: 8px;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
        }
        .water-bar-fill {
            height: 100%;
            width: 0%;
            background-color: var(--color-blue);
            transition: width 0.5s ease;
        }

        /* ======================================================================
           5. FEATURE: MANUAL LOG STACK (SMART)
           ====================================================================== */
        .log-stack-entry {
            background-color: var(--color-surface-light);
            border-left: 3px solid var(--color-accent);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .log-set-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #aaa;
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid #222;
        }

        /* ======================================================================
           6. FEATURE: CHECKLIST
           ====================================================================== */
        .checklist-row {
            display: flex;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #222;
            cursor: pointer;
        }
        .checklist-box {
            width: 22px; height: 22px;
            border: 2px solid #444;
            border-radius: 6px;
            margin-right: 12px;
            display: flex; align-items: center; justify-content: center;
        }
        .checklist-row.is-checked .checklist-box {
            background-color: var(--color-accent);
            border-color: var(--color-accent);
            color: #000;
        }
        .checklist-row.is-checked .checklist-box::after {
            content: '‚úì';
            font-weight: 900;
            font-size: 14px;
        }
        
        /* ======================================================================
           7. OVERLAYS (VOLLBILD)
           ====================================================================== */
        .full-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 5000;
            display: none;
            flex-direction: column;
            padding: var(--safe-area-top) 15px 15px 15px;
        }

        .overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #222;
        }

        .overlay-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 80px; /* Platz f√ºr den fixen Button */
        }
        
        .overlay-sticky-footer {
            /* Fixierter Footer f√ºr den Speicher-Button */
            margin-top: auto;
            padding-top: 10px;
            background: #000;
        }

        /* PLAYER SPEZIFISCH */
        .player-visual-container {
            position: relative;
            width: 220px;
            height: 220px;
            margin: 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-svg-ring {
            position: absolute; top:0; left:0;
            width: 100%; height: 100%;
            transform: rotate(-90deg);
        }
        .player-timer-number {
            font-size: 75px;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
            z-index: 2;
        }
        .player-next-box {
            background-color: #222;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            width: 100%;
            border: 1px solid #333;
        }
        .player-instruction-text {
            font-size: 13px;
            color: #aaa;
            margin-top: 8px;
            text-align: center;
            max-width: 90%;
            line-height: 1.4;
        }

        /* ======================================================================
           8. NAVIGATION LEISTE
           ====================================================================== */
        .navigation-bar {
            position: fixed;
            bottom: 0; left: 0; width: 100%; height: 80px;
            background-color: rgba(10,10,10,0.96);
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-around;
            padding-bottom: var(--safe-area-bottom);
            z-index: 1000;
        }
        .nav-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            color: white;
            transition: all 0.2s;
        }
        .nav-button.active-nav {
            opacity: 1;
            color: var(--color-text-primary);
            transform: translateY(-2px);
        }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }
        .nav-label { font-size: 9px; font-weight: 800; letter-spacing: 0.5px; }

    </style>
</head>
<body>

    <div id="overlay-setup" class="full-overlay" style="z-index:9000; justify-content:center;">
        <h1 style="text-align:center;">WILLKOMMEN</h1>
        <p style="text-align:center; color:#666;">Bitte richte dein Profil ein.</p>
        <div class="content-card" style="margin-top:20px;">
            <h2 class="sub-title">DEINE DATEN</h2>
            <input type="number" id="input-setup-height" placeholder="Gr√∂√üe (cm)">
            <input type="number" id="input-setup-weight" placeholder="Gewicht (kg)">
            <input type="number" id="input-setup-age" placeholder="Alter">
        </div>
        <button class="action-button" onclick="AppCore.finishSetup()">PROFIL SPEICHERN</button>
    </div>

    <div id="overlay-daily" class="full-overlay">
        <div class="overlay-header">
            <h1>DAILY CHECK</h1>
            <button class="button-small" onclick="UserInterface.closeOverlay('overlay-daily')">SCHLIESSEN</button>
        </div>
        <div class="overlay-content">
            <div class="content-card">
                <div id="checklist-container">
                    </div>
            </div>
            <div class="content-card">
                <h2 class="sub-title">NOTIZEN / TAGEBUCH</h2>
                <textarea id="daily-note-text" style="height:120px; background:transparent; border:none; border-bottom:1px solid #333;" placeholder="Wie f√ºhlst du dich heute?..." oninput="AppCore.saveNote(this.value)"></textarea>
            </div>
        </div>
    </div>

    <div id="overlay-manual" class="full-overlay">
        <div class="overlay-header">
            <h1>LOGBUCH</h1>
            <button class="button-small" onclick="UserInterface.closeOverlay('overlay-manual')">ABBRECHEN</button>
        </div>
        <div class="overlay-content">
            <div class="content-card" style="background:var(--color-surface-light);">
                <span style="font-size:10px; font-weight:bold; color:#888;">1. √úBUNG W√ÑHLEN</span>
                <select id="manual-exercise-select" style="margin-bottom:12px;"></select>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <span style="font-size:10px; font-weight:bold; color:#888;">2. RUNDEN</span>
                        <input type="number" id="manual-rounds-input" value="3">
                    </div>
                    <div>
                        <span style="font-size:10px; font-weight:bold; color:#888;">3. WERT (Standard)</span>
                        <input type="number" id="manual-value-standard" placeholder="z.B. 40">
                    </div>
                </div>
                
                <button class="action-button" style="margin-top:10px;" onclick="LogSystem.addExerciseToStack()">+ HINZUF√úGEN</button>
            </div>

            <div id="manual-stack-list"></div>
        </div>
        <div class="overlay-sticky-footer">
            <button class="action-button" style="background-color:var(--color-accent); color:#000;" onclick="LogSystem.saveWorkout()">WORKOUT SPEICHERN</button>
        </div>
    </div>

    <div id="overlay-player" class="full-overlay">
        <div class="overlay-header">
            <button class="button-small" onclick="PlayerSystem.exit()">EXIT</button>
            <span id="player-round-info" style="font-weight:bold; color:#888;">RUNDE 1</span>
            <div id="player-mute-btn" onclick="PlayerSystem.toggleMute()" style="cursor:pointer; font-size:20px;">üîä</div>
        </div>
        
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div id="player-phase-display" style="font-size:24px; font-weight:900; color:var(--color-accent); letter-spacing:4px;">READY</div>
            
            <div class="player-visual-container">
                <svg class="player-svg-ring">
                    <circle cx="110" cy="110" r="100" stroke="#222" stroke-width="10" fill="none"/>
                    <circle id="player-progress-ring" cx="110" cy="110" r="100" stroke="white" stroke-width="10" fill="none" stroke-dasharray="628" stroke-dashoffset="0" style="transition: stroke-dashoffset 1s linear;"/>
                </svg>
                <div id="player-time-display" class="player-timer-number">10</div>
            </div>

            <div id="player-exercise-display" style="font-size:26px; font-weight:900; text-align:center; line-height:1.2;">√úBUNG</div>
            
            <div id="player-instruction-display" class="player-instruction-text">
                Hier steht die Anleitung f√ºr die √úbung...
            </div>
            
            <div id="player-next-box" class="player-next-box" style="display:none;">
                <span style="color:#888; font-size:10px; font-weight:bold;">ALS N√ÑCHSTES:</span><br>
                <span id="player-next-name" style="font-size:18px; font-weight:bold; color:#fff;">-</span>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
            <button id="player-btn-start" class="action-button" onclick="PlayerSystem.togglePlay()">START</button>
            <button id="player-btn-skip" class="action-button button-outline" onclick="PlayerSystem.skipPhase()">SKIP PAUSE</button>
        </div>
    </div>

    <div id="overlay-rating" class="full-overlay" style="z-index:9100; justify-content:center;">
        <h1 style="text-align:center;">WORKOUT BEENDET</h1>
        <p style="text-align:center; color:#888;">Wie anstrengend war es?</p>
        
        <div class="content-card" style="text-align:center; padding:30px;">
            <h2 id="rating-value-display" style="font-size:60px; color:var(--color-accent); margin:10px 0;">5</h2>
            <input type="range" id="rating-slider" min="1" max="10" value="5" oninput="document.getElementById('rating-value-display').innerText=this.value">
            
            <div style="display:flex; justify-content:space-between; font-size:10px; color:#666; margin-top:10px;">
                <span>SEHR LEICHT</span>
                <span>EXTREM HART</span>
            </div>
        </div>
        
        <button class="action-button" onclick="AppCore.saveRatedWorkout()">SPEICHERN & SCHLIESSEN</button>
    </div>

    <div id="screen-home" class="app-screen active-screen">
        
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
            <div>
                <h1 id="home-day-display">TAG 1</h1>
                <span id="home-date-display" style="font-size:11px; font-weight:bold; color:var(--color-accent);">LADEN...</span>
            </div>
            <div style="text-align:right;">
                <span style="font-size:9px; font-weight:700; color:#666; display:block;">STREAK</span>
                <span style="font-size:20px; font-weight:900; color:var(--color-orange);">üî• <span id="home-streak-display">0</span></span>
            </div>
        </div>

        <div>
            <div class="dashboard-grid">
                <div class="stat-display-box"><span class="stat-label-text">BMI</span><span class="stat-value-text" id="kpi-bmi">-</span></div>
                <div class="stat-display-box"><span class="stat-label-text">KCAL</span><span class="stat-value-text" id="kpi-kcal">0</span></div>
                <div class="stat-display-box"><span class="stat-label-text">LEVEL</span><span class="stat-value-text" id="kpi-level" style="color:var(--color-orange)">1</span></div>
            </div>
            <div class="dashboard-grid">
                <div class="stat-display-box"><span class="stat-label-text">WOCHE</span><span class="stat-value-text" id="freq-week">0</span></div>
                <div class="stat-display-box"><span class="stat-label-text">MONAT</span><span class="stat-value-text" id="freq-month">0</span></div>
                <div class="stat-display-box"><span class="stat-label-text">JAHR</span><span class="stat-value-text" id="freq-year">0</span></div>
            </div>
        </div>

        <div class="content-card" style="padding:10px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                <h2 style="margin:0; font-size:9px;">WASSER BILANZ</h2>
                <span id="water-text-display" style="font-size:10px; font-weight:bold; color:var(--color-blue);">0.0L</span>
            </div>
            <div class="water-compact-row">
                <button class="water-action-btn" onclick="AppCore.modifyWater(-1)">-</button>
                <div class="water-bar-track"><div id="water-bar-fill" class="water-bar-fill"></div></div>
                <button class="water-action-btn" style="background:var(--color-blue); border-color:var(--color-blue);" onclick="AppCore.modifyWater(1)">+</button>
            </div>
        </div>

        <div class="content-card" style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <h2 style="margin-bottom:10px;">WORKOUT STARTEN</h2>
            
            <div class="dashboard-grid">
                <button id="preset-10" class="button-small" onclick="AppCore.setDuration(10)">10 MIN</button>
                <button id="preset-20" class="button-small" onclick="AppCore.setDuration(20)">20 MIN</button>
                <button id="preset-30" class="button-small" onclick="AppCore.setDuration(30)">30 MIN</button>
            </div>
            
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="number" id="custom-duration-input" placeholder="Eigene Min..." style="margin:0; text-align:center;" oninput="AppCore.setCustomDuration(this.value)">
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                <button class="action-button" onclick="PlayerSystem.init()">LIVE</button>
                <button class="action-button button-outline" onclick="LogSystem.openOverlay()">LOG</button>
            </div>
        </div>

        <button class="button-outline" style="padding:12px; border-radius:10px; font-size:11px; font-weight:700; color:#fff; border-color:#fff;" onclick="UserInterface.openOverlay('overlay-daily')">
            DAILY CHECKLISTE & NOTIZEN √ñFFNEN
        </button>
    </div>

    <div id="screen-stats" class="app-screen">
        <h1 class="main-title">STATISTIK</h1>

        <div class="content-card" style="margin-top:20px;">
            <h2 class="sub-title">GEWICHTSVERLAUF</h2>
            <div style="height:150px; width:100%;">
                <svg id="chart-svg" width="100%" height="100%" preserveAspectRatio="none" style="overflow:visible;"></svg>
            </div>
        </div>
        
        <div class="content-card">
            <h2 class="sub-title">K√ñRPERDATEN LOGGEN</h2>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <input type="number" id="measure-weight" placeholder="Gewicht (kg)">
                <input type="number" id="measure-waist" placeholder="Bauch (cm)">
                <input type="number" id="measure-chest" placeholder="Brust (cm)">
                <input type="number" id="measure-arm" placeholder="Arm (cm)">
                <input type="number" id="measure-leg" placeholder="Bein (cm)">
                <input type="number" id="measure-glute" placeholder="Po (cm)">
            </div>
            <button class="action-button button-outline" style="margin-top:10px;" onclick="AppCore.logBodyMeasurements()">WERTE SPEICHERN</button>
        </div>

        <div id="history-list-container">
            </div>
    </div>

    <div id="screen-settings" class="app-screen">
        <h1 class="main-title">SYSTEM</h1>
        
        <div class="content-card" style="margin-top:20px;">
            <h2 class="sub-title">TIMER EINSTELLUNGEN</h2>
            
            <div style="display:flex; justify-content:space-between;">
                <span>Belastungszeit</span>
                <b id="setting-work-display">40s</b>
            </div>
            <input type="range" id="setting-work-input" min="20" max="120" step="5" oninput="AppCore.updateSettings()">
            
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                <span>Pausenzeit</span>
                <b id="setting-rest-display">20s</b>
            </div>
            <input type="range" id="setting-rest-input" min="10" max="60" step="5" oninput="AppCore.updateSettings()">
        </div>

        <div class="content-card">
            <h2 class="sub-title">DATEN & BACKUP</h2>
            <button class="button-outline" style="width:100%; padding:14px; margin-bottom:5px; border-radius:12px;" onclick="BackupSystem.exportData()">BACKUP EXPORTIEREN</button>
            
            <input type="file" id="backup-file-input" style="display:none" onchange="BackupSystem.importData(this)">
            <button class="button-outline" style="width:100%; padding:14px; margin-bottom:15px; border-radius:12px;" onclick="document.getElementById('backup-file-input').click()">BACKUP IMPORTIEREN</button>
            
            <button class="button-outline" style="width:100%; padding:14px; border-radius:12px; border-color:var(--color-red); color:var(--color-red);" onclick="AppCore.hardReset()">ALLES L√ñSCHEN</button>
        </div>
    </div>

    <div class="navigation-bar">
        <div class="nav-button active-nav" onclick="UserInterface.switchTab('screen-home', this)">
            <div class="nav-icon">üè†</div>
            <span class="nav-label">HOME</span>
        </div>
        <div class="nav-button" onclick="UserInterface.switchTab('screen-stats', this)">
            <div class="nav-icon">üìä</div>
            <span class="nav-label">STATS</span>
        </div>
        <div class="nav-button" onclick="UserInterface.switchTab('screen-settings', this)">
            <div class="nav-icon">‚öôÔ∏è</div>
            <span class="nav-label">SYSTEM</span>
        </div>
    </div>

    <script>
        // --- KONSTANTEN & DATENBANKEN ---
        const STORAGE_KEY = "BODY_PULSE_V21_1_FULL";
        
        // √úbungen mit Anleitungen
        const EXERCISE_DATABASE = {
            "Planks": "R√ºcken gerade, Bauch fest anspannen, nicht durchh√§ngen.",
            "Liegest√ºtze": "Brust bis fast zum Boden, K√∂rper bildet eine Linie.",
            "Kniebeugen": "R√ºcken gerade, Gewicht auf den Fersen, Knie stabil.",
            "Crunches": "Nur Schulterbl√§tter l√∂sen, ausatmen beim Hochgehen.",
            "Ausfallschritte": "Vorderes Knie 90 Grad, Oberk√∂rper aufrecht halten.",
            "Dips": "Ellenbogen nah am K√∂rper f√ºhren, tief absenken.",
            "Burpees": "Explosiver Sprung nach oben, sauberer Liegest√ºtz unten.",
            "Mountain Climber": "Knie abwechselnd schnell zur Brust ziehen.",
            "Wandsitzen": "Beine im 90 Grad Winkel, R√ºcken flach an die Wand pressen.",
            "Hampelmann": "Arme ganz nach oben f√ºhren, weich auf Ballen landen.",
            "Beinheben": "Beine gestreckt heben, unterer R√ºcken bleibt am Boden.",
            "Glute Bridge": "H√ºfte so weit wie m√∂glich heben, Po oben fest anspannen."
        };
        const EXERCISE_NAMES = Object.keys(EXERCISE_DATABASE);

        // Globaler Status
        let applicationData = {
            profile: { height: 0, weight: 0, age: 0 },
            config: { workTime: 40, restTime: 20, durationPreference: 10, note: "" },
            status: { waterLevel: 0, waterDate: "", checklist: [false, false, false, false], streak: 0, lastWorkoutDate: 0 },
            history: [],
            bodyLogs: [],
            meta: { installDate: Date.now() }
        };

        // Tempor√§re Variablen
        let manualLogStack = [];
        let temporaryKcalStorage = 0; // F√ºr die √úbergabe an Rating

        let playerEngine = {
            timerId: null,
            isRunning: false,
            timeRemaining: 10,
            phase: 'PREP',
            currentRound: 1,
            exerciseIndex: 0,
            workoutPlan: [],
            isCompleted: false,
            audioContext: null,
            isMuted: false
        };

        // ======================================================
        // INITIALISIERUNG
        // ======================================================
        window.onload = function() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if(storedData) { 
                try { 
                    applicationData = JSON.parse(storedData); 
                    AppCore.checkDailyReset();
                    UserInterface.refreshAll();
                } catch(e) {
                    console.error("Datenfehler: ", e);
                }
            } else {
                document.getElementById('ov-setup').style.display = 'flex';
            }
        };

        // ======================================================
        // APP CORE LOGIC
        // ======================================================
        const AppCore = {
            saveToStorage: function() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(applicationData));
            },
            
            finishSetup: function() {
                applicationData.profile.height = parseFloat(document.getElementById('input-setup-height').value) || 175;
                applicationData.profile.weight = parseFloat(document.getElementById('input-setup-weight').value) || 75;
                applicationData.profile.age = parseFloat(document.getElementById('input-setup-age').value) || 30;
                applicationData.meta.installDate = Date.now();
                applicationData.status.waterDate = new Date().toDateString();
                
                this.saveToStorage(); 
                document.getElementById('ov-setup').style.display = 'none';
                UserInterface.refreshAll();
            },

            checkDailyReset: function() {
                const today = new Date().toDateString();
                if(applicationData.status.waterDate !== today) {
                    applicationData.status.waterLevel = 0;
                    applicationData.status.waterDate = today;
                    applicationData.status.checklist = [false, false, false, false];
                    this.saveToStorage();
                }
            },

            modifyWater: function(amount) {
                applicationData.status.waterLevel = Math.max(0, applicationData.status.waterLevel + amount);
                this.saveToStorage();
                UserInterface.refreshAll();
            },

            setDuration: function(minutes) {
                applicationData.config.durationPreference = minutes;
                document.getElementById('custom-duration-input').value = "";
                this.saveToStorage();
                UserInterface.refreshAll();
            },

            setCustomDuration: function(val) {
                if(val > 0) {
                    applicationData.config.durationPreference = parseInt(val);
                    this.saveToStorage();
                    UserInterface.refreshAll();
                }
            },

            saveNote: function(text) {
                applicationData.config.note = text;
                this.saveToStorage();
            },

            updateSettings: function() {
                applicationData.config.workTime = parseInt(document.getElementById('setting-work-input').value);
                applicationData.config.restTime = parseInt(document.getElementById('setting-rest-input').value);
                this.saveToStorage();
                UserInterface.refreshAll();
            },

            logBodyMeasurements: function() {
                const logEntry = {
                    date: new Date().toISOString(),
                    w: document.getElementById('m-weight').value,
                    b: document.getElementById('m-waist').value,
                    c: document.getElementById('m-chest').value,
                    h: document.getElementById('m-glute').value,
                    a: document.getElementById('m-arm').value,
                    l: document.getElementById('m-leg').value
                };
                
                if(logEntry.w) {
                    applicationData.profile.weight = parseFloat(logEntry.w);
                    applicationData.bodyLogs.push(logEntry);
                    this.saveToStorage();
                    UserInterface.refreshAll();
                    alert("Messwerte erfolgreich gespeichert!");
                }
            },
            
            saveRatedWorkout: function() {
                const rating = document.getElementById('rating-slider').value;
                const workoutType = document.getElementById('ov-player').style.display === 'none' ? "Live Training" : "Logbuch";
                
                // Wir f√ºgen den Eintrag erst JETZT hinzu, mit Rating
                applicationData.history.push({ 
                    date: new Date().toISOString(), 
                    type: "Workout", 
                    kcal: temporaryKcalStorage, 
                    rating: rating 
                });
                
                StatsSystem.checkStreak();
                this.saveToStorage();
                UserInterface.refreshAll();
                
                document.getElementById('overlay-rating').style.display = 'none';
                alert("Training gespeichert! Starke Leistung.");
            },

            hardReset: function() {
                if(confirm("ACHTUNG: M√∂chtest du wirklich alle Daten l√∂schen?")) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };

        // ======================================================
        // UI & NAVIGATION
        // ======================================================
        const UserInterface = {
            refreshAll: function() {
                // Header Daten
                const daysSinceStart = Math.ceil((Date.now() - applicationData.meta.installDate) / 86400000);
                document.getElementById('lbl-day').innerText = "TAG " + daysSinceStart;
                document.getElementById('lbl-date').innerText = new Date().toLocaleDateString('de-DE').toUpperCase();
                document.getElementById('lbl-streak').innerText = applicationData.status.streak;
                document.getElementById('home-streak-display').innerText = applicationData.status.streak;
                
                // KPIs Berechnen
                const heightM = applicationData.profile.height / 100;
                const bmi = (applicationData.profile.weight / (heightM * heightM)).toFixed(1);
                document.getElementById('kpi-bmi').innerText = bmi;
                
                const totalKcal = applicationData.history.reduce((sum, item) => sum + (item.kcal || 0), 0);
                document.getElementById('kpi-kcal').innerText = totalKcal.toLocaleString();
                document.getElementById('kpi-lvl').innerText = 1 + Math.floor(totalKcal / 1000);

                // Wasser Anzeige
                const liters = (applicationData.status.waterLevel * 0.25).toFixed(1);
                document.getElementById('water-txt').innerText = liters + " / 2.5L";
                const pct = Math.min((applicationData.status.waterLevel / 10) * 100, 100);
                document.getElementById('water-bar').style.width = pct + "%";

                // Workout Buttons Highlight
                document.querySelectorAll('.button-small').forEach(btn => btn.classList.remove('active-preset'));
                const activeBtn = document.getElementById('dur-' + applicationData.config.durationPreference);
                if(activeBtn) activeBtn.classList.add('active-preset');

                // Settings Slider Werte
                document.getElementById('rng-work').value = applicationData.config.workTime;
                document.getElementById('rng-rest').value = applicationData.config.restTime;
                document.getElementById('lbl-work').innerText = applicationData.config.workTime + "s";
                document.getElementById('lbl-rest').innerText = applicationData.config.restTime + "s";

                // Notiz Feld
                document.getElementById('note-txt').value = applicationData.config.note;

                // Statistiken aktualisieren
                StatsSystem.renderFreq();
                StatsSystem.renderChart();
                StatsSystem.renderList();
            },

            nav: function(screenId, navElement) {
                // Screens umschalten
                document.querySelectorAll('.app-screen').forEach(s => s.classList.remove('active-screen'));
                document.getElementById(screenId).classList.add('active-screen');
                
                // Nav Buttons umschalten
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                navElement.classList.add('active');
            },

            openDaily: function() {
                const container = document.getElementById('checklist-container');
                container.innerHTML = "";
                
                // Neue Checklist Items (Eisen, Magnesium, Schlaf weg)
                const items = ["Protein Shake", "Kreatin", "Vitamine", "Eisen", "Magnesium"];
                
                items.forEach((label, index) => {
                    // Sicherstellen, dass Array lang genug ist
                    if(applicationData.status.checklist[index] === undefined) applicationData.status.checklist[index] = false;
                    
                    const div = document.createElement('div');
                    const isChecked = applicationData.status.checklist[index];
                    div.className = "check-item" + (isChecked ? " done" : "");
                    
                    div.innerHTML = `<div class="check-box"></div><span>${label}</span>`;
                    
                    div.onclick = function() {
                        applicationData.status.checklist[index] = !applicationData.status.checklist[index];
                        AppCore.saveToStorage();
                        UserInterface.openDaily(); // Refresh Checklist View
                    };
                    container.appendChild(div);
                });
                
                document.getElementById('ov-daily').style.display = 'flex';
            },

            closeDaily: function() {
                document.getElementById('ov-daily').style.display = 'none';
            },

            closeManual: function() {
                document.getElementById('ov-manual').style.display = 'none';
            },
            
            openOverlay: function(id) {
                document.getElementById(id).style.display = 'flex';
            },
            
            closeOverlay: function(id) {
                document.getElementById(id).style.display = 'none';
            }
        };

        // ======================================================
        // LOG SYSTEM (SMART MANUAL INPUT)
        // ======================================================
        const LogSystem = {
            open: function() {
                manualLogStack = [];
                this.renderStack();
                
                const select = document.getElementById('man-sel');
                select.innerHTML = "";
                EXERCISE_NAMES.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.innerText = name;
                    select.appendChild(option);
                });
                
                document.getElementById('ov-manual').style.display = 'flex';
            },

            add: function() {
                const name = document.getElementById('man-sel').value;
                const rounds = parseInt(document.getElementById('man-rounds').value);
                const standardVal = document.getElementById('man-val-def').value || 0; // Smart Input
                
                const entry = {
                    name: name,
                    sets: []
                };

                // Alle S√§tze mit dem Standardwert f√ºllen
                for(let i = 0; i < rounds; i++) {
                    entry.sets.push({ value: standardVal });
                }

                manualLogStack.push(entry);
                this.renderStack();
            },

            renderStack: function() {
                const container = document.getElementById('man-stack');
                container.innerHTML = "";
                
                manualLogStack.forEach((entry, index) => {
                    const div = document.createElement('div');
                    div.className = "stack-entry";
                    
                    let html = `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <b>${entry.name}</b>
                        <span onclick="LogSystem.remove(${index})" style="color:var(--red); font-weight:bold; cursor:pointer;">‚úï</span>
                    </div>`;

                    entry.sets.forEach((set, setIndex) => {
                        html += `<div class="set-row">
                            <span>Satz ${setIndex + 1}</span>
                            <input type="number" value="${set.value}" 
                                   oninput="manualLogStack[${index}].sets[${setIndex}].value = this.value"
                                   style="width:60px; margin:0; padding:4px; text-align:right; font-size:12px;">
                        </div>`;
                    });

                    div.innerHTML = html;
                    container.appendChild(div);
                });
            },

            remove: function(index) {
                manualLogStack.splice(index, 1);
                this.renderStack();
            },

            save: function() {
                if(manualLogStack.length === 0) return;
                
                let totalSets = 0;
                manualLogStack.forEach(e => totalSets += e.sets.length);
                temporaryKcalStorage = totalSets * 15; // Sch√§tzung
                
                document.getElementById('ov-manual').style.display = 'none';
                document.getElementById('overlay-rating').style.display = 'flex';
            }
        };

        // ======================================================
        // PLAYER SYSTEM
        // ======================================================
        const PlayerSystem = {
            init: function() {
                if(!playerEngine.audioContext) playerEngine.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                playerEngine.workoutPlan = [...EXERCISE_NAMES].sort(() => 0.5 - Math.random()).slice(0, 6);
                playerEngine.currentRound = 1;
                playerEngine.exerciseIndex = 0;
                playerEngine.phase = 'PREP';
                playerEngine.timeRemaining = 10;
                playerEngine.isCompleted = false;
                
                document.getElementById('ov-player').style.display = 'flex';
                this.draw();
            },

            togglePlay: function() {
                const btn = document.getElementById('p-btn-go');
                if(playerEngine.isRunning) {
                    clearInterval(playerEngine.timerId);
                    playerEngine.isRunning = false;
                    btn.innerText = "WEITER";
                } else {
                    playerEngine.timerId = setInterval(this.tick, 1000);
                    playerEngine.isRunning = true;
                    btn.innerText = "PAUSE";
                }
            },

            tick: function() {
                if(playerEngine.timeRemaining > 0) {
                    playerEngine.timeRemaining--;
                    if(playerEngine.timeRemaining < 4 && playerEngine.timeRemaining > 0) PlayerSystem.beep(600);
                    PlayerSystem.draw();
                } else {
                    PlayerSystem.beep(900);
                    PlayerSystem.nextPhase();
                }
            },

            nextPhase: function() {
                if(playerEngine.phase === 'PREP') {
                    playerEngine.phase = 'WORK';
                    playerEngine.timeRemaining = applicationData.config.workTime;
                } else if(playerEngine.phase === 'WORK') {
                    playerEngine.phase = 'REST';
                    playerEngine.timeRemaining = applicationData.config.restTime;
                } else {
                    // Ende von REST
                    playerEngine.exerciseIndex++;
                    if(playerEngine.exerciseIndex >= 6) {
                        playerEngine.exerciseIndex = 0;
                        playerEngine.currentRound++;
                        
                        const maxRounds = applicationData.config.durationPreference === 10 ? 1 : (applicationData.config.durationPreference === 20 ? 2 : 3);
                        if(playerEngine.currentRound > maxRounds) {
                            PlayerSystem.finish();
                            return;
                        }
                    }
                    playerEngine.phase = 'WORK';
                    playerEngine.timeRemaining = applicationData.config.workTime;
                }
                PlayerSystem.draw();
            },

            skipPhase: function() {
                if(playerEngine.phase === 'WORK') {
                    alert("Training l√§uft! Durchhalten!");
                } else {
                    playerEngine.timeRemaining = 0;
                    this.nextPhase();
                }
            },

            draw: function() {
                // Timer
                document.getElementById('p-time').innerText = playerEngine.timeRemaining;
                document.getElementById('p-phase').innerText = playerEngine.phase;
                
                // Ring
                const maxTime = playerEngine.phase === 'WORK' ? applicationData.config.workTime : (playerEngine.phase === 'REST' ? applicationData.config.restTime : 10);
                const offset = 628 - (playerEngine.timeRemaining / maxTime) * 628;
                document.getElementById('p-ring').style.strokeDashoffset = offset;

                // √úbung & Guide
                const exName = playerEngine.workoutPlan[playerEngine.exerciseIndex];
                document.getElementById('p-ex').innerText = exName.toUpperCase();
                document.getElementById('p-guide').innerText = EXERCISE_DATABASE[exName];

                // Next Preview
                const nextBox = document.getElementById('p-next-box');
                if(playerEngine.phase === 'REST' || playerEngine.phase === 'PREP') {
                    nextBox.style.display = 'block';
                    let nextName = (playerEngine.phase==='PREP') ? exName : (playerEngine.exerciseIndex+1 < 6 ? playerEngine.workoutPlan[playerEngine.exerciseIndex+1] : "N√ÑCHSTE RUNDE");
                    document.getElementById('p-next-name').innerText = nextName;
                } else {
                    nextBox.style.display = 'none';
                }

                // Skip Button Sperre
                const skipBtn = document.getElementById('p-btn-skip');
                if(playerEngine.phase === 'WORK') {
                    skipBtn.style.opacity = '0.3';
                    skipBtn.innerText = "GESPERRT";
                    skipBtn.style.pointerEvents = 'none';
                } else {
                    skipBtn.style.opacity = '1';
                    skipBtn.innerText = "SKIP PAUSE";
                    skipBtn.style.pointerEvents = 'auto';
                }
            },

            finish: function() {
                clearInterval(playerEngine.timerId);
                temporaryKcalStorage = applicationData.config.durationPreference * 8;
                document.getElementById('ov-player').style.display = 'none';
                document.getElementById('overlay-rating').style.display = 'flex';
            },

            exit: function() {
                clearInterval(playerEngine.timerId);
                document.getElementById('ov-player').style.display = 'none';
            },

            beep: function(freq) {
                if(playerEngine.isMuted || !playerEngine.audioContext) return;
                const osc = playerEngine.audioContext.createOscillator();
                const gain = playerEngine.audioContext.createGain();
                osc.connect(gain);
                gain.connect(playerEngine.audioContext.destination);
                osc.frequency.value = freq;
                gain.gain.value = 0.1;
                osc.start();
                osc.stop(playerEngine.audioContext.currentTime + 0.1);
            },
            
            toggleMute: function() {
                playerEngine.isMuted = !playerEngine.isMuted;
                document.getElementById('player-mute-btn').innerText = playerEngine.isMuted ? "üîá" : "üîä";
            }
        };

        // ======================================================
        // STATS SYSTEM
        // ======================================================
        const StatsSystem = {
            checkStreak: function() {
                const today = new Date().toDateString();
                const last = new Date(applicationData.status.lastWorkoutDate).toDateString();
                if(today !== last) {
                    applicationData.status.streak++;
                    applicationData.status.lastWorkoutDate = Date.now();
                }
            },

            renderFreq: function() {
                const now = new Date();
                let weekC = 0, monthC = 0, yearC = 0;
                
                const startW = new Date(now); startW.setDate(now.getDate() - now.getDay() + 1); startW.setHours(0,0,0,0);
                const startM = new Date(now.getFullYear(), now.getMonth(), 1);
                const startY = new Date(now.getFullYear(), 0, 1);

                applicationData.history.forEach(h => {
                    const d = new Date(h.date);
                    if(d >= startW) weekC++;
                    if(d >= startM) monthC++;
                    if(d >= startY) yearC++;
                });

                document.getElementById('freq-w').innerText = weekC;
                document.getElementById('freq-m').innerText = monthC;
                document.getElementById('freq-y').innerText = yearC;
                // Auch im Stats Tab aktualisieren
                document.getElementById('stats-week').innerText = weekC;
                document.getElementById('stats-month').innerText = monthC;
                document.getElementById('stats-year').innerText = yearC;
            },

            renderChart: function() {
                const svg = document.getElementById('chart-svg');
                svg.innerHTML = "";
                
                if(applicationData.bodyLogs.length < 2) return;

                const weights = applicationData.bodyLogs.map(l => parseFloat(l.w));
                const min = Math.min(...weights) - 1;
                const max = Math.max(...weights) + 1;
                const count = weights.length;

                let points = "";
                weights.forEach((w, i) => {
                    const x = (i / (count - 1)) * 100;
                    const y = 100 - ((w - min) / (max - min) * 100);
                    points += `${x},${y} `;
                });

                svg.innerHTML = `<polyline points="${points}" fill="none" stroke="#32d74b" stroke-width="3"/>`;
            },

            renderList: function() {
                const container = document.getElementById('hist-list');
                container.innerHTML = "<h2>VERLAUF</h2>";
                
                [...applicationData.history].reverse().slice(0, 15).forEach(h => {
                    const div = document.createElement('div');
                    div.className = "card";
                    div.style.padding = "10px";
                    
                    const ratingText = h.rating ? ` ‚Ä¢ Int: ${h.rating}/10` : "";
                    
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
                            <span style="font-weight:bold; color:var(--color-accent);">${h.type}</span>
                            <span style="color:#666;">${new Date(h.date).toLocaleDateString()}</span>
                        </div>
                        <div style="font-size:11px; color:#888;">
                            ${h.kcal} kcal${ratingText}
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        };

        // ======================================================
        // BACKUP SYSTEM
        // ======================================================
        const BackupSystem = {
            export: function() {
                const dataStr = JSON.stringify(applicationData);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "bodypulse_backup.json";
                a.click();
            },

            import: function(inputElement) {
                const file = inputElement.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        applicationData = JSON.parse(e.target.result);
                        AppCore.saveToStorage();
                        location.reload();
                    } catch(err) {
                        alert("Fehler beim Laden.");
                    }
                };
                reader.readAsText(file);
            }
        };

    </script>
</body>
</html>
