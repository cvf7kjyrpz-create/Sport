<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Body Pulse Pro</title>
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background:%23000000'%3E%3Cpath fill='%23ffffff' d='M256 48C141.1 48 48 141.1 48 256s93.1 208 208 208 208-93.1 208-208S370.9 48 256 48zm-32.1 289.8l-8.8 45.3c-2.1 10.7-16.5 13.6-22.7 4.6l-37.5-54.6c-5.8-8.4-5.4-19.6 1-27.6l74.9-93.6c7.9-9.9 23.4-4.8 24.3 7.9l3.3 46.1 45.1-66.2c6.1-8.9 19.3-8.6 25 0l42.6 62.4c5.8 8.5 5.2 19.7-1.3 27.6l-81.5 98.7c-8.4 10.2-24.6 4.8-25.3-8.3l-2.6-47.5-36.5 5.2z'/%3E%3C/svg%3E">

    <style>
        :root {
            /* MINIMALIST DARK THEME */
            --bg: #000000;
            --card: #121212;
            --border: #2a2a2a;
            --input-bg: #1a1a1a;
            --text: #ffffff;
            --text-dim: #666666;
            --accent: #3a86ff; /* Modernes Blau */
            --accent-dim: rgba(58, 134, 255, 0.1);
            --danger: #ff4d4d;
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        }

        body.light-mode {
            --bg: #f5f5f7;
            --card: #ffffff;
            --border: #e1e1e6;
            --input-bg: #f0f0f5;
            --text: #111111;
            --text-dim: #888888;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            background-color: var(--bg); color: var(--text); font-family: var(--font);
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            padding-top: env(safe-area-inset-top); overflow: hidden;
            transition: background 0.3s;
        }

        /* --- LAYOUT --- */
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; padding-bottom: 100px; overflow-y: auto; }
        .screen.active { display: flex; animation: fadein 0.3s; }
        
        /* --- TYPOGRAPHY --- */
        h1 { font-size: 26px; font-weight: 700; margin: 0 0 5px; letter-spacing: -0.5px; }
        h2 { font-size: 18px; font-weight: 600; margin: 0 0 10px; }
        .subtitle { color: var(--text-dim); font-size: 14px; margin-bottom: 25px; display: block; }
        .label { font-size: 12px; color: var(--text-dim); margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- CARDS & UI --- */
        .card { 
            background: var(--card); padding: 20px; border-radius: 18px; 
            margin-bottom: 16px; border: 1px solid var(--border);
        }
        
        .btn-main { 
            width: 100%; padding: 16px; border-radius: 12px; border: none; 
            font-size: 16px; font-weight: 600; cursor: pointer; 
            background: var(--text); color: var(--bg); margin-top: 10px; 
            transition: opacity 0.2s;
        }
        .btn-main:active { opacity: 0.7; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-accent { background: var(--accent); color: white; }

        /* --- INPUTS (FIXED) --- */
        input { 
            width: 100%; background: var(--input-bg); border: 1px solid var(--border); 
            color: var(--text); padding: 14px; border-radius: 12px; font-size: 16px; 
            font-family: var(--font); margin-bottom: 0; appearance: none;
        }
        /* Fix f√ºr Date Input Overflow */
        input[type="date"] { min-width: 0; width: 100%; display: block; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }

        /* --- HOME DASHBOARD --- */
        .level-badge { font-size:12px; color: var(--accent); background: var(--accent-dim); padding: 4px 10px; border-radius: 20px; font-weight: bold; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-item { background: var(--input-bg); padding: 10px; border-radius: 12px; text-align: center; }
        .stat-val { font-size: 18px; font-weight: 700; display: block; }
        .stat-lbl { font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin-top: 2px; }

        /* --- WATER TRACKER --- */
        .water-track { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .water-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border); background: var(--card); color: var(--accent); font-size: 20px; cursor: pointer; }
        .water-fill { display: flex; gap: 5px; }
        .drop { width: 12px; height: 12px; border-radius: 50%; background: var(--border); transition: 0.3s; }
        .drop.active { background: var(--accent); box-shadow: 0 0 10px var(--accent); }

        /* --- PLAYER --- */
        .full-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg);
            z-index: 200; display: none; flex-direction: column; padding: env(safe-area-inset-top) 20px 20px 20px;
        }
        .full-overlay.active { display: flex; }
        .timer-wrap { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .time-big { font-size: 90px; font-weight: 200; font-variant-numeric: tabular-nums; letter-spacing: -2px; }
        .progress-bar { width: 100%; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 20px; }
        .progress-fill { height: 100%; background: var(--text); width: 0%; transition: width 1s linear; }

        /* --- NAV --- */
        .nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 85px; 
            background: rgba(18,18,18, 0.9); backdrop-filter: blur(20px); 
            border-top: 1px solid var(--border); display: flex; justify-content: space-around; 
            padding-bottom: env(safe-area-inset-bottom); z-index: 100; 
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dim); opacity: 0.6; transition: 0.2s; }
        .nav-item.active { color: var(--text); opacity: 1; }
        .nav-icon { font-size: 22px; margin-bottom: 6px; }

        /* --- ANIMATIONS --- */
        @keyframes fadein { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- HELPERS --- */
        .row { display: flex; justify-content: space-between; align-items: center; }
        .toggle-switch { position: relative; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--input-bg); transition: .4s; border-radius: 34px; border: 1px solid var(--border); }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: var(--text-dim); transition: .4s; border-radius: 50%; }
        input:checked + .slider:before { transform: translateX(24px); background-color: var(--text); }
        
        .modal-bg { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 300; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(10px); }
        .modal-content { background: var(--card); width: 100%; max-width: 400px; border-radius: 20px; padding: 25px; border: 1px solid var(--border); }

        /* Fix f√ºr Text-Overflow */
        .ex-desc { color: var(--text-dim); font-size: 14px; line-height: 1.5; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="screen-onboarding" class="full-overlay" style="z-index: 500; justify-content: center;">
        <h1 style="text-align: center;">Dein Ziel</h1>
        <p class="subtitle" style="text-align: center;">Was m√∂chtest du fokussieren?</p>
        <div style="display: grid; gap: 10px;">
            <button class="btn-main btn-ghost" onclick="finishOnboarding(['bauch'])">Bauch & Core</button>
            <button class="btn-main btn-ghost" onclick="finishOnboarding(['po'])">Beine & Po</button>
            <button class="btn-main btn-ghost" onclick="finishOnboarding(['arme', 'ruecken'])">Oberk√∂rper (Arme/R√ºcken)</button>
            <button class="btn-main" onclick="finishOnboarding(['bauch', 'po', 'arme', 'ruecken'])">Ganzk√∂rper</button>
        </div>
    </div>

    <div id="tab-home" class="screen active">
        <div class="row">
            <div>
                <span class="label">Willkommen zur√ºck</span>
                <h1>Dashboard</h1>
            </div>
            <div class="level-badge" id="lvl-badge">Level 1</div>
        </div>

        <div class="card" style="margin-top: 20px; border-color: var(--text);">
            <div class="row">
                <h2>Heute</h2>
                <span style="font-size: 24px;">üî•</span>
            </div>
            <h1 id="next-workout-title" style="font-size: 22px; margin-bottom: 5px;">Lade Plan...</h1>
            <p id="next-workout-desc" class="ex-desc">...</p>
            <button class="btn-main" onclick="openPlayer()">Training starten</button>
        </div>

        <div class="stat-grid">
            <div class="stat-item">
                <span class="stat-val" id="disp-workouts">0</span>
                <span class="stat-lbl">Workouts</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="disp-bmi">--</span>
                <span class="stat-lbl">BMI</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="disp-streak">0</span>
                <span class="stat-lbl">Streak</span>
            </div>
        </div>

        <div class="card" style="margin-top: 15px;">
            <span class="label">Hydration</span>
            <div class="water-track">
                <div class="water-fill" id="water-fill">
                    <div class="drop"></div><div class="drop"></div><div class="drop"></div><div class="drop"></div><div class="drop"></div>
                </div>
                <button class="water-btn" onclick="addWater()">+</button>
            </div>
        </div>
    </div>

    <div id="tab-stats" class="screen">
        <h1>Tracking</h1>
        <span class="subtitle">Fortschritt eintragen</span>
        
        <div class="card">
            <span class="label">Neuer Eintrag</span>
            <input type="date" id="input-date" style="margin-bottom: 12px;">
            
            <div class="input-grid">
                <div>
                    <span class="label">Gewicht (kg)</span>
                    <input type="number" id="input-weight" placeholder="0.0">
                </div>
                <div>
                    <span class="label">Bauch (cm)</span>
                    <input type="number" id="input-waist" placeholder="0">
                </div>
            </div>
            <button class="btn-main btn-accent" onclick="saveStats()">Speichern</button>
        </div>

        <div class="card">
            <span class="label">Verlauf</span>
            <div id="chart-area" style="height: 120px; display:flex; align-items:flex-end; gap:4px; margin-top:10px;">
                <p style="color:var(--text-dim); width:100%; text-align:center; font-size:12px; align-self:center;">Keine Daten</p>
            </div>
        </div>
    </div>

    <div id="tab-settings" class="screen">
        <h1>Einstellungen</h1>
        <span class="subtitle">Profil & App</span>

        <div class="card">
            <span class="label">Stammdaten (f√ºr BMI)</span>
            <div class="input-grid">
                <input type="number" id="base-height" placeholder="Gr√∂√üe (cm)" onchange="saveBaseData()">
                <input type="number" id="base-age" placeholder="Alter" onchange="saveBaseData()">
            </div>
        </div>

        <div class="card">
            <div class="row">
                <span>Light Mode</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="theme-toggle" onchange="toggleTheme()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="card">
            <span class="label">Datenmanagement</span>
            <button class="btn-main btn-ghost" onclick="exportData()" style="margin-bottom:10px;">Backup speichern</button>
            <button class="btn-main btn-ghost" onclick="document.getElementById('import-file').click()">Backup laden</button>
            <input type="file" id="import-file" style="display:none" onchange="importData(this)" accept=".json">
            <button class="btn-main btn-ghost" onclick="resetApp()" style="margin-top:20px; border-color:var(--danger); color:var(--danger);">App zur√ºcksetzen</button>
        </div>
    </div>

    <div id="view-player" class="full-overlay">
        <div class="row" style="margin-bottom: 30px;">
            <button class="btn-ghost" style="border:none; font-size:24px; padding:0;" onclick="closePlayer()">‚úï</button>
            <span id="round-disp" class="label" style="font-size:14px; margin:0;">Runde 1/3</span>
            <button class="btn-ghost" style="border:none; font-size:20px; padding:0;" onclick="toggleSound()" id="sound-btn">üîä</button>
        </div>

        <div class="timer-wrap">
            <div class="time-big" id="time-disp">00</div>
            <span class="label" id="phase-disp" style="font-size: 16px; margin-top: 10px;">BEREIT</span>
            <div class="progress-bar">
                <div class="progress-fill" id="prog-fill"></div>
            </div>
        </div>

        <div style="text-align: center; margin-bottom: 40px;">
            <div style="display:flex; justify-content:center; align-items:center; gap:10px;">
                <h2 id="ex-name" style="font-size: 24px; margin:0;">√úbung</h2>
                <div style="background:var(--border); width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; cursor:pointer;" onclick="showInfo()">i</div>
            </div>
            <p id="next-ex" style="color:var(--text-dim); margin-top:5px;">...</p>
        </div>

        <button class="btn-main" id="main-btn" style="height: 60px; font-size: 20px;" onclick="toggleTimer()">START</button>
    </div>

    <div id="modal-info" class="modal-bg" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="info-title">Titel</h2>
            <p id="info-desc" style="color:var(--text-dim); line-height:1.5;">Beschreibung</p>
            <button class="btn-main" onclick="document.getElementById('modal-info').style.display='none'">OK</button>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="switchTab('tab-home', this)">
            <div class="nav-icon">‚òñ</div>
        </div>
        <div class="nav-item" onclick="switchTab('tab-stats', this)">
            <div class="nav-icon">üìà</div>
        </div>
        <div class="nav-item" onclick="switchTab('tab-settings', this)">
            <div class="nav-icon">‚öôÔ∏è</div>
        </div>
    </nav>

    <script>
        // --- DATA ---
        const DB = {
            bauch: [
                {n:"Crunches", d:"R√ºckenlage, H√§nde an Kopf. Schultern heben."},
                {n:"Beinheben", d:"R√ºckenlage, Beine gestreckt heben & senken."},
                {n:"Plank", d:"Unterarmst√ºtz halten. K√∂rper ist ein Brett."},
                {n:"Russian Twist", d:"Sitzen, F√º√üe hoch, H√§nde links/rechts."}
            ],
            po: [
                {n:"Squats", d:"Tiefbeugen, Gewicht auf Fersen. R√ºcken gerade."},
                {n:"Glute Bridges", d:"R√ºckenlage, H√ºfte hochdr√ºcken. Po fest."},
                {n:"Lunges", d:"Ausfallschritt nach hinten. Knie tief."},
                {n:"Donkey Kicks", d:"Vierf√º√üler, Bein nach oben kicken."}
            ],
            arme: [
                {n:"Liegest√ºtze", d:"Brust zum Boden, fest hochdr√ºcken."},
                {n:"Dips", d:"R√ºcklings an Kante st√ºtzen, Arme beugen."},
                {n:"Shoulder Taps", d:"Liegest√ºtz-Pos, H√§nde an Schulter tippen."},
                {n:"Plank Up", d:"Vom Unterarm in den Handst√ºtz & zur√ºck."}
            ],
            ruecken: [
                {n:"Superman", d:"Bauchlage, Arme & Beine anheben."},
                {n:"Schneeengel", d:"Bauchlage, Arme kreisen √ºber Kopf."},
                {n:"Br√ºcke", d:"R√ºckenlage, Becken hoch, Spannung halten."}
            ]
        };

        // --- APP STATE ---
        let app = {
            targets: [], plan: [], planIdx: 0,
            workouts: 0, level: 1, water: 0,
            height: '', age: '',
            logs: [], theme: 'dark'
        };
        
        let sess = { activeEx: [], round: 1, exIdx: 0, time: 0, max: 0, work: false, run: false, int: null };
        const CFG = { WORK: 40, REST: 20, PREP: 10, RNDS: 3 };
        let sound = true; let ac;

        // --- INIT ---
        window.onload = () => {
            if(localStorage.getItem('bpp_data')) app = JSON.parse(localStorage.getItem('bpp_data'));
            applyTheme();
            
            if(app.targets.length === 0) document.getElementById('screen-onboarding').style.display = 'flex';
            else updateHome();

            document.getElementById('input-date').valueAsDate = new Date();
            document.getElementById('base-height').value = app.height;
            document.getElementById('base-age').value = app.age;
            renderWater();
            renderChart();
        };

        // --- CORE ---
        function save() { localStorage.setItem('bpp_data', JSON.stringify(app)); }
        function haptic() { if(navigator.vibrate) navigator.vibrate(10); }

        function finishOnboarding(t) {
            app.targets = t;
            genPlan();
            document.getElementById('screen-onboarding').style.display = 'none';
            save(); updateHome();
        }

        function genPlan() {
            let pool = [];
            app.targets.forEach(k => { if(DB[k]) pool = pool.concat(DB[k]); });
            pool.sort(()=>Math.random()-0.5);
            app.plan = [];
            for(let i=0; i<3; i++) {
                let ex = [];
                for(let j=0; j<4; j++) ex.push(pool[(i*4+j)%pool.length]);
                app.plan.push({ name: "Workout "+(String.fromCharCode(65+i)), ex: ex });
            }
            app.planIdx = 0;
        }

        function updateHome() {
            const cur = app.plan[app.planIdx % app.plan.length];
            document.getElementById('next-workout-title').innerText = cur.name;
            document.getElementById('next-workout-desc').innerText = cur.ex.map(e=>e.n).join(', ');
            
            app.level = Math.floor(app.workouts / 5) + 1;
            document.getElementById('lvl-badge').innerText = "Level " + app.level;
            document.getElementById('disp-workouts').innerText = app.workouts;
            document.getElementById('disp-streak').innerText = getStreak();
            
            calcBMI();
        }

        function calcBMI() {
            if(app.height && app.logs.length > 0) {
                const w = parseFloat(app.logs[app.logs.length-1].w);
                const h = parseFloat(app.height) / 100;
                const bmi = (w / (h*h)).toFixed(1);
                document.getElementById('disp-bmi').innerText = bmi;
            } else {
                document.getElementById('disp-bmi').innerText = "--";
            }
        }

        function getStreak() {
            // Simple Logic for demo
            return app.logs.length > 0 ? "1" : "0"; 
        }

        // --- PLAYER ---
        function openPlayer() {
            sess.activeEx = app.plan[app.planIdx % app.plan.length].ex;
            sess.round = 1; sess.exIdx = 0;
            document.getElementById('view-player').classList.add('active');
            startPhase('PREP');
            if(!ac) ac = new (window.AudioContext||window.webkitAudioContext)();
        }
        function closePlayer() {
            clearInterval(sess.int); sess.run = false;
            document.getElementById('view-player').classList.remove('active');
        }

        function startPhase(type) {
            sess.work = (type === 'WORK');
            const ph = document.getElementById('phase-disp');
            const ex = document.getElementById('ex-name');
            const nx = document.getElementById('next-ex');
            
            if(type === 'PREP') {
                sess.time = sess.max = CFG.PREP;
                ph.innerText = "BEREIT MACHEN";
                ex.innerText = sess.activeEx[0].n;
                nx.innerText = "";
            } else if(type === 'WORK') {
                sess.time = sess.max = CFG.WORK;
                ph.innerText = "WORK";
                ex.innerText = sess.activeEx[sess.exIdx].n;
                nx.innerText = "Danach: Pause";
                beep(600, 800, 0.3); // High Sweep
            } else {
                sess.time = sess.max = CFG.REST;
                ph.innerText = "PAUSE";
                ex.innerText = "Erholen";
                let n = (sess.exIdx+1 < sess.activeEx.length) ? sess.activeEx[sess.exIdx+1].n : (sess.round<CFG.RNDS ? sess.activeEx[0].n : "ENDE");
                nx.innerText = "N√§chste: " + n;
                beep(600, 300, 0.3); // Low Sweep
            }
            drawTimer();
            if(!sess.run) toggleTimer();
        }

        function tick() {
            if(sess.time > 0) {
                sess.time--; drawTimer();
                if(sess.time <= 3) { beep(800, 800, 0.1); haptic(); }
            } else {
                haptic();
                if(document.getElementById('phase-disp').innerText === "BEREIT MACHEN") startPhase('WORK');
                else if(sess.work) {
                    if(sess.exIdx >= sess.activeEx.length-1 && sess.round >= CFG.RNDS) finish();
                    else startPhase('REST');
                } else {
                    sess.exIdx++;
                    if(sess.exIdx >= sess.activeEx.length) { sess.exIdx = 0; sess.round++; }
                    document.getElementById('round-disp').innerText = "Runde " + sess.round + "/3";
                    startPhase('WORK');
                }
            }
        }

        function drawTimer() {
            document.getElementById('time-disp').innerText = sess.time;
            const pct = (sess.time / sess.max) * 100;
            document.getElementById('prog-fill').style.width = pct + "%";
        }

        function toggleTimer() {
            const btn = document.getElementById('main-btn');
            if(sess.run) {
                clearInterval(sess.int); sess.run = false;
                btn.innerText = "WEITER"; btn.style.background = "var(--text)"; btn.style.color = "var(--bg)";
            } else {
                sess.int = setInterval(tick, 1000); sess.run = true;
                btn.innerText = "PAUSE"; btn.style.background = "var(--card)"; btn.style.color = "var(--text)";
            }
            haptic();
        }

        function finish() {
            closePlayer();
            app.workouts++; app.planIdx++;
            save(); updateHome();
            alert("Training beendet! Level up! üöÄ");
        }

        function showInfo() {
            if(sess.run) toggleTimer();
            const e = sess.activeEx[sess.exIdx];
            document.getElementById('info-title').innerText = e.n;
            document.getElementById('info-desc').innerText = e.d;
            document.getElementById('modal-info').style.display = 'flex';
        }

        // --- AUDIO ---
        function toggleSound() { sound = !sound; document.getElementById('sound-btn').style.opacity = sound ? 1 : 0.4; }
        function beep(f1, f2, dur) {
            if(!sound || !ac) return;
            const o = ac.createOscillator(); const g = ac.createGain();
            o.connect(g); g.connect(ac.destination);
            o.type = 'sawtooth';
            o.frequency.setValueAtTime(f1, ac.currentTime);
            o.frequency.exponentialRampToValueAtTime(f2, ac.currentTime + dur);
            g.gain.setValueAtTime(0.5, ac.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + dur);
            o.start(); o.stop(ac.currentTime + dur);
        }

        // --- STATS & DATA ---
        function saveBaseData() {
            app.height = document.getElementById('base-height').value;
            app.age = document.getElementById('base-age').value;
            save(); updateHome();
        }

        function saveStats() {
            const d = document.getElementById('input-date').value;
            const w = document.getElementById('input-weight').value;
            if(!d || !w) return alert("Bitte Datum & Gewicht angeben.");
            app.logs.push({ date: d, w: w });
            app.logs.sort((a,b) => new Date(a.date) - new Date(b.date));
            save(); updateHome(); renderChart(); haptic();
        }

        function renderChart() {
            const el = document.getElementById('chart-area'); el.innerHTML = "";
            if(app.logs.length < 2) return el.innerHTML = '<p style="width:100%;text-align:center;color:#666;">2 Eintr√§ge n√∂tig</p>';
            app.logs.slice(-7).forEach(l => {
                const bar = document.createElement('div');
                bar.style.width = "100%";
                bar.style.height = (l.w / 150 * 100) + "%"; // Rough scale
                bar.style.background = "var(--accent)";
                bar.style.borderRadius = "4px 4px 0 0";
                bar.style.opacity = 0.8;
                el.appendChild(bar);
            });
        }

        // --- WATER ---
        function renderWater() {
            const drops = document.querySelectorAll('.drop');
            drops.forEach((d, i) => {
                if(i < app.water) d.classList.add('active');
                else d.classList.remove('active');
            });
        }
        function addWater() {
            app.water = (app.water + 1) % 6;
            renderWater(); haptic();
        }

        // --- UTILS ---
        function switchTab(id, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            haptic();
        }
        function toggleTheme() {
            app.theme = document.getElementById('theme-toggle').checked ? 'light' : 'dark';
            applyTheme(); save();
        }
        function applyTheme() {
            document.body.className = app.theme + '-mode';
            document.getElementById('theme-toggle').checked = (app.theme === 'light');
        }
        function exportData() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app));
            a.download = "backup.json"; a.click();
        }
        function importData(el) {
            const r = new FileReader();
            r.onload = e => { app = JSON.parse(e.target.result); save(); location.reload(); };
            r.readAsText(el.files[0]);
        }
        function resetApp() { if(confirm("Alles l√∂schen?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
