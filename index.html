<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Body Pulse V32.0 - FIXED DATA</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <style>
        /* ======================================================================
           1. CSS DESIGN SYSTEM (VOLLST√ÑNDIG)
           ====================================================================== */
        :root {
            --color-background: #000000;
            --color-card-background: #111111;
            --color-card-light: #1c1c1e;
            --color-border: #333333;
            --color-text-primary: #ffffff;
            --color-text-secondary: #8e8e93;
            --color-accent-green: #32d74b;
            --color-accent-blue: #0a84ff;
            --color-accent-orange: #ff9f0a;
            --color-accent-red: #ff453a;
            --color-accent-purple: #bf5af2;
            --font-family-system: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        html, body {
            position: fixed;
            width: 100%;
            height: 100%;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            font-family: var(--font-family-system);
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
            padding-top: var(--safe-area-top);
        }

        /* SCREEN LAYOUTS */
        .app-screen-container {
            flex: 1;
            display: none;
            flex-direction: column;
            width: 100%;
            padding: 15px;
            /* SEHR WICHTIG: Genug Platz unten, damit die Buttons nicht verdeckt werden */
            padding-bottom: 200px; 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .app-screen-container.screen-active {
            display: flex;
        }

        /* UI KARTEN STYLES */
        .ui-card {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }

        .ui-card-compact {
            background-color: var(--color-card-background);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }

        /* GRID F√úR KPI BOXEN */
        .dashboard-grid-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .stat-display-item {
            background-color: var(--color-card-light);
            border: 1px solid #222222;
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-value-text {
            font-size: 18px;
            font-weight: 800;
            color: #ffffff;
        }

        .stat-label-text {
            font-size: 10px;
            color: var(--color-text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* TEXT FORMATE */
        h1.headline-text {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 5px;
            line-height: 1.1;
        }

        h2.sub-headline-text {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #666666;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        /* BUTTONS */
        .primary-button {
            background-color: var(--color-text-primary);
            color: #000000;
            border: none;
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .outline-button {
            background-color: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .small-toggle-button {
            padding: 10px;
            font-size: 12px;
            border-radius: 10px;
            border: 1px solid var(--color-border);
            background-color: transparent;
            color: #888888;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
        }
        .small-toggle-button.button-active {
            background-color: #ffffff;
            color: #000000;
            border-color: #ffffff;
        }

        /* FORMULAR ELEMENTE */
        input.text-input, select.select-input, textarea.text-area-input {
            width: 100%;
            background-color: #111111;
            border: 1px solid #333333;
            color: white;
            padding: 14px;
            border-radius: 12px;
            font-size: 15px;
            margin-bottom: 10px;
            font-family: inherit;
        }

        /* WASSER TRACKER DESIGN */
        .water-tracker-row {
            display: flex;
            align-items: center;
            gap: 10px;
            height: 40px;
        }
        .water-control-button {
            width: 40px;
            height: 100%;
            background-color: #222222;
            border: 1px solid #333333;
            color: #ffffff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        .water-bar-container {
            flex: 1;
            height: 12px;
            background-color: #222222;
            border-radius: 6px;
            overflow: hidden;
        }
        .water-bar-fill {
            height: 100%;
            width: 0%;
            background-color: var(--color-accent-blue);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* CHECKLISTE DESIGN */
        .checklist-row-item {
            display: flex;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #222222;
            cursor: pointer;
        }
        .checkbox-indicator {
            width: 24px;
            height: 24px;
            border: 2px solid #555555;
            border-radius: 8px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .checklist-row-item.item-checked .checkbox-indicator {
            background-color: var(--color-accent-green);
            border-color: var(--color-accent-green);
            color: #000000;
        }
        .checklist-row-item.item-checked .checkbox-indicator::after {
            content: '‚úì';
            font-weight: 900;
            font-size: 16px;
        }

        /* COMPARISON TABLE STYLING */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        .comparison-table td {
            padding: 12px 0;
            border-bottom: 1px solid #222222;
            font-size: 15px;
        }
        .comparison-table td:last-child {
            text-align: right;
            font-weight: 800;
        }
        .diff-positive { color: var(--color-accent-green); }
        .diff-negative { color: var(--color-accent-red); }
        .diff-neutral { color: #666666; }

        /* NAVIGATION LEISTE (FIXED BOTTOM) */
        .bottom-navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            /* Maximale Tiefe unter Ber√ºcksichtigung der iOS Home-Bar */
            height: calc(60px + var(--safe-area-bottom));
            background-color: rgba(10, 10, 10, 0.98);
            border-top: 1px solid #222222;
            display: flex;
            justify-content: space-around;
            padding-bottom: var(--safe-area-bottom);
            z-index: 9999;
        }

        .nav-item-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0.3;
            color: white;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .nav-item-btn.nav-active {
            opacity: 1;
            color: var(--color-text-primary);
        }
        .nav-icon-font {
            font-size: 22px;
            margin-bottom: 3px;
        }
        .nav-label-text {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
        }

        /* OVERLAYS SYSTEM */
        .fullscreen-overlay {
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background-color: #000000;
            z-index: 10000;
            display: none;
            flex-direction: column;
            padding: var(--safe-area-top) 15px 15px 15px;
        }

        .overlay-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #222222;
        }

        .overlay-scroll-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 120px;
        }

        /* PLAYER COMPONENTS */
        .player-visual-circle {
            position: relative;
            width: 260px;
            height: 260px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-svg-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            transform: rotate(-90deg);
        }
        .player-timer-text {
            font-size: 90px;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
        }
        .player-next-preview-box {
            background-color: #222222;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            text-align: center;
            width: 100%;
            border: 1px solid #333333;
        }
        .player-guide-link {
            font-size: 15px;
            color: var(--color-accent-blue);
            margin-top: 15px;
            text-decoration: underline;
            cursor: pointer;
            font-weight: 600;
        }

    </style>
</head>
<body>

    <div id="overlay-setup" class="fullscreen-overlay" style="z-index:11000; justify-content:center;">
        <h1 style="text-align:center; margin-bottom:20px;">ERSTE SCHRITTE</h1>
        <div class="ui-card">
            <h2 class="sub-headline-text">PERS√ñNLICHE WERTE</h2>
            <label style="font-size:12px; color:#666;">K√∂rpergr√∂√üe in cm</label>
            <input type="number" id="setup-height" class="text-input" placeholder="z.B. 180">
            <label style="font-size:12px; color:#666;">Gewicht in kg</label>
            <input type="number" id="setup-weight" class="text-input" placeholder="z.B. 85">
            <label style="font-size:12px; color:#666;">Alter</label>
            <input type="number" id="setup-age" class="text-input" placeholder="z.B. 32">
        </div>
        <button class="primary-button" onclick="AppController.finishSetup()">PROFIL ERSTELLEN</button>
    </div>

    <div id="overlay-daily" class="fullscreen-overlay">
        <div class="overlay-header-row">
            <h1 class="headline-text">DAILY LOG</h1>
            <button class="small-toggle-button" onclick="UserInterface.closeOverlay('overlay-daily')">FERTIG</button>
        </div>
        <div class="overlay-scroll-content">
            <div class="ui-card" id="checklist-container">
                </div>
            <div class="ui-card">
                <h2 class="sub-headline-text">TAGEBUCH & NOTIZEN</h2>
                <textarea id="note-input" class="text-area-input" style="height:200px;" placeholder="Wie f√ºhlst du dich heute? Irgendwelche Besonderheiten?" oninput="AppController.saveNote(this.value)"></textarea>
            </div>
        </div>
    </div>

    <div id="overlay-library" class="fullscreen-overlay">
        <div class="overlay-header-row">
            <h1 class="headline-text">BIBLIOTHEK</h1>
            <button class="small-toggle-button" onclick="UserInterface.closeOverlay('overlay-library')">ZUR√úCK</button>
        </div>
        <div class="overlay-scroll-content" id="library-list">
            </div>
    </div>

    <div id="overlay-detail" class="fullscreen-overlay" style="z-index:12000;">
        <div class="overlay-header-row">
            <h1 class="headline-text" id="detail-title">ANLEITUNG</h1>
            <button class="small-toggle-button" onclick="UserInterface.closeOverlay('overlay-detail')">SCHLIESSEN</button>
        </div>
        <div class="overlay-scroll-content">
            <div class="ui-card">
                <span id="detail-category" style="color:var(--color-accent-purple); font-weight:bold; font-size:13px; text-transform:uppercase;">KATEGORIE</span>
                <div id="detail-body" style="white-space:pre-wrap; line-height:1.7; margin-top:15px; font-size:16px; color:#eee;">TEXT</div>
            </div>
        </div>
    </div>

    <div id="overlay-player" class="fullscreen-overlay">
        <div class="overlay-header-row">
            <button class="small-toggle-button" onclick="PlayerSystem.exit()">ABBRECHEN</button>
            <span id="player-status-round" style="font-weight:800; color:#888; letter-spacing:1px;">√úBUNG 1 / 10</span>
            <div id="player-mute" onclick="PlayerSystem.toggleMute()" style="font-size:26px; cursor:pointer;">üîä</div>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div id="player-phase" style="font-size:26px; font-weight:900; color:var(--color-accent-green); letter-spacing:4px; text-transform:uppercase;">BEREIT MACHEN</div>
            
            <div class="player-visual-circle">
                <svg class="player-svg-container">
                    <circle cx="130" cy="130" r="120" stroke="#222" stroke-width="14" fill="none"/>
                    <circle id="player-ring" cx="130" cy="130" r="120" stroke="white" stroke-width="14" fill="none" stroke-dasharray="754" stroke-dashoffset="0" style="transition:1s linear;"/>
                </svg>
                <div id="player-timer" class="player-timer-text">10</div>
            </div>

            <div style="text-align:center; padding:0 20px;">
                <div id="player-ex-cat" style="color:var(--color-accent-purple); font-size:13px; font-weight:800; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">KATEGORIE</div>
                <div id="player-ex-name" style="font-size:32px; font-weight:900; line-height:1.1;">√úBUNG NAME</div>
                <div id="player-guide-trigger" class="player-guide-link" onclick="PlayerSystem.showCurrentGuide()">ANLEITUNG JETZT LESEN</div>
            </div>

            <div id="player-next-box" class="player-next-preview-box" style="display:none;">
                <span style="font-size:11px; color:#888; font-weight:800; letter-spacing:1px;">N√ÑCHSTE √úBUNG:</span><br>
                <span id="player-next-name" style="font-size:20px; font-weight:900; color:#fff;">NAME DER √úBUNG</span><br>
                <button class="primary-button" style="margin-top:10px; padding:8px; font-size:11px; width:auto; display:inline-flex;" onclick="PlayerSystem.showNextGuide()">ANLEITUNG VORAB LESEN</button>
            </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;">
            <button id="player-play-pause" class="primary-button" onclick="PlayerSystem.toggle()">START</button>
            <button id="player-skip" class="outline-button" onclick="PlayerSystem.skip()">PAUSE √úBERSPRINGEN</button>
        </div>
    </div>

    <div id="overlay-rating" class="fullscreen-overlay" style="z-index:13000; justify-content:center;">
        <h1 style="text-align:center; font-size:32px; font-weight:900; color:var(--color-accent-green);">WORKOUT KOMPLETT!</h1>
        <div class="ui-card" style="text-align:center; margin-top:30px;">
            <p style="color:#aaa; font-weight:700;">Wie intensiv war das Training?</p>
            <h2 id="rating-val" style="font-size:60px; color:var(--color-accent-green); margin:15px 0;">5</h2>
            <input type="range" id="rating-slider" min="1" max="10" value="5" style="width:100%;" oninput="document.getElementById('rating-val').innerText=this.value">
            <div style="display:flex; justify-content:space-between; font-size:12px; color:#666; font-weight:bold; margin-top:10px;">
                <span>SEHR LEICHT</span><span>MAXIMALE ANSTRENGUNG</span>
            </div>
        </div>
        <button class="primary-button" onclick="PlayerSystem.saveAndFinish()">TRAINING IN HISTORIE SPEICHERN</button>
    </div>

    <div id="screen-home" class="app-screen-container screen-active">
        
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
            <div>
                <h1 id="home-day-title" class="headline-text">TAG 1</h1>
                <span id="home-date-title" style="color:var(--color-accent-green); font-weight:900; font-size:13px; letter-spacing:1px;">DATUM LADEN...</span>
            </div>
            <div style="text-align:right;">
                <span style="font-size:11px; color:#666; font-weight:800; text-transform:uppercase;">Streak</span><br>
                <span style="font-size:28px; font-weight:900; color:var(--color-accent-orange);">üî• <span id="home-streak-val">0</span></span>
            </div>
        </div>

        <div class="dashboard-grid-layout">
            <div class="stat-display-item">
                <span class="stat-label-text">BMI</span>
                <span class="stat-value-text" id="home-bmi">-</span>
            </div>
            <div class="stat-display-item">
                <span class="stat-label-text">KCAL</span>
                <span class="stat-value-text" id="home-kcal">0</span>
            </div>
            <div class="stat-display-item">
                <span class="stat-label-text">LEVEL</span>
                <span class="stat-value-text" id="home-lvl" style="color:var(--color-accent-orange);">1</span>
            </div>
        </div>

        <div class="ui-card" style="padding:12px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <h2 style="margin:0; font-size:11px; font-weight:800;">WASSER-TRACKER</h2>
                <span id="home-water-text" style="color:var(--color-accent-blue); font-weight:900; font-size:13px;">0.0L</span>
            </div>
            <div class="water-tracker-row">
                <button class="water-control-button" onclick="AppController.addWater(-1)">‚àí</button>
                <div class="water-bar-container">
                    <div id="home-water-bar" class="water-bar-fill"></div>
                </div>
                <button class="water-control-button" style="background-color:var(--color-accent-blue);" onclick="AppController.addWater(1)">+</button>
            </div>
        </div>

        <div class="ui-card">
            <h2 class="sub-headline-text" style="text-align:center;">WORKOUT STARTEN</h2>
            <div class="dashboard-grid-layout">
                <button id="dur-10" class="small-toggle-button" onclick="AppController.setDuration(10)">10 MIN</button>
                <button id="dur-20" class="small-toggle-button" onclick="AppController.setDuration(20)">20 MIN</button>
                <button id="dur-30" class="small-toggle-button" onclick="AppController.setDuration(30)">30 MIN</button>
            </div>
            
            <label style="font-size:10px; font-weight:800; color:#666; margin-top:15px; display:block; text-transform:uppercase; letter-spacing:1px;">Fokus-Bereich:</label>
            <select id="home-focus" class="select-input">
                <option value="all">Ganzk√∂rper Mix (Standard)</option>
                <option value="Bauch & Core">Bauch & Core Fokus</option>
                <option value="Beine & Po">Beine & Po Fokus</option>
                <option value="Oberk√∂rper">Oberk√∂rper Fokus</option>
                <option value="Ganzk√∂rper & Cardio">Cardio & Fettverbrennung</option>
            </select>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px;">
                <button class="primary-button" onclick="PlayerSystem.start()">LIVE START</button>
                <button class="outline-button" onclick="UserInterface.openLibrary()">BIBLIOTHEK</button>
            </div>
        </div>

        <button class="primary-button" style="background-color:#1c1c1e; color:white; border:1px solid #333; margin-top:5px;" onclick="UserInterface.openDaily()">
            DAILY CHECKLISTE & NOTIZEN
        </button>
    </div>

    <div id="screen-stats" class="app-screen-container">
        <h1 class="headline-text">STATISTIKEN</h1>
        
        <div class="ui-card" style="margin-top:15px;">
            <h2 class="sub-headline-text">GEWICHTSENTWICKLUNG</h2>
            <div style="height:160px; width:100%; margin-top:10px;">
                <svg id="weight-svg" width="100%" height="100%" preserveAspectRatio="none" style="overflow:visible;"></svg>
            </div>
        </div>

        <div class="ui-card">
            <h2 class="sub-headline-text">VERGLEICH ZUR LETZTEN MESSUNG</h2>
            <div id="compare-table-div" style="font-size:14px; color:#888;">
                Du ben√∂tigst mindestens zwei Messungen, um Fortschritte zu vergleichen.
            </div>
        </div>

        <div class="ui-card">
            <h2 class="sub-headline-text">K√ñRPERWERTE EINTRAGEN</h2>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <input type="number" id="m-weight" class="text-input" placeholder="Gewicht (kg)">
                <input type="number" id="m-waist" class="text-input" placeholder="Bauch (cm)">
                <input type="number" id="m-chest" class="text-input" placeholder="Brust (cm)">
                <input type="number" id="m-arm" class="text-input" placeholder="Arm (cm)">
                <input type="number" id="m-leg" class="text-input" placeholder="Bein (cm)">
                <input type="number" id="m-glute" class="text-input" placeholder="Po (cm)">
            </div>
            <button class="primary-button" style="margin-top:10px;" onclick="AppController.saveMeasurement()">WERTE SPEICHERN</button>
        </div>

        <div id="workout-history-list">
            </div>
    </div>

    <div id="screen-settings" class="app-screen-container">
        <h1 class="headline-text">SYSTEM</h1>
        
        <div class="ui-card" style="margin-top:15px;">
            <h2 class="sub-headline-text">TRAININGSTIMER ANPASSEN</h2>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-weight:700;">Belastungsphase</span>
                <b id="val-work" style="color:var(--color-accent-green);">40s</b>
            </div>
            <input type="range" id="range-work" min="20" max="120" step="5" style="width:100%; margin-bottom:20px;" oninput="AppController.updateConfig()">
            
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-weight:700;">Pausenphase</span>
                <b id="val-rest" style="color:var(--color-accent-blue);">20s</b>
            </div>
            <input type="range" id="range-rest" min="10" max="60" step="5" style="width:100%;" oninput="AppController.updateConfig()">
        </div>

        <div class="ui-card">
            <h2 class="sub-headline-text">DATENSICHERUNG</h2>
            <button class="outline-button" style="margin-bottom:12px;" onclick="BackupSystem.export()">BACKUP DATEI EXPORTIEREN</button>
            <input type="file" id="import-file" style="display:none" onchange="BackupSystem.import(this)">
            <button class="outline-button" style="margin-bottom:25px;" onclick="document.getElementById('import-file').click()">BACKUP DATEI IMPORTIEREN</button>
            
            <h2 class="sub-headline-text" style="color:var(--color-accent-red);">GEFAHRENZONE</h2>
            <button class="outline-button" style="border-color:var(--color-accent-red); color:var(--color-accent-red);" onclick="AppController.clearAll()">ALLE APP-DATEN L√ñSCHEN</button>
        </div>
    </div>

    <div class="bottom-navbar">
        <div id="nav-home" class="nav-item-btn nav-active" onclick="UserInterface.nav('screen-home', this)">
            <div class="nav-icon-font">üè†</div>
            <span class="nav-label-text">Home</span>
        </div>
        <div id="nav-stats" class="nav-item-btn" onclick="UserInterface.nav('screen-stats', this)">
            <div class="nav-icon-font">üìä</div>
            <span class="nav-label-text">Stats</span>
        </div>
        <div id="nav-settings" class="nav-item-btn" onclick="UserInterface.nav('screen-settings', this)">
            <div class="nav-icon-font">‚öôÔ∏è</div>
            <span class="nav-label-text">System</span>
        </div>
    </div>

    <script>
        const STORAGE_KEY = "BODYPULSE_APP_DATA_FIXED";

        /**
         * VOLLST√ÑNDIGE √úBUNGSDATENBANK
         * Alle 36 √úbungen mit detaillierten Anleitungen.
         */
        const EXERCISES = {
            "Planks": {
                cat: "Bauch & Core",
                short: "Statische Halte√ºbung f√ºr die gesamte Rumpfmuskulatur.",
                long: "1. Gehe in den Unterarmst√ºtz.\n2. Die Ellbogen befinden sich direkt unter den Schultern.\n3. Strecke die Beine aus und stelle die Zehenspitzen auf.\n4. Dein K√∂rper bildet von Kopf bis Fu√ü eine gerade Linie.\n5. Spanne Bauch, Po und Beine fest an.\n6. Halte die Position und atme ruhig weiter, ohne ins Hohlkreuz zu fallen."
            },
            "Liegest√ºtze": {
                cat: "Oberk√∂rper",
                short: "Klassische Kr√§ftigung f√ºr Brust, Schultern und Arme.",
                long: "1. Platziere die H√§nde etwas weiter als schulterbreit auf dem Boden.\n2. Strecke die Beine nach hinten aus.\n3. Senke den gesamten K√∂rper ab, bis die Brust fast den Boden ber√ºhrt.\n4. Achte darauf, dass der K√∂rper stabil und steif bleibt.\n5. Dr√ºcke dich kraftvoll wieder nach oben in die Ausgangsposition."
            },
            "Kniebeugen": {
                cat: "Beine & Po",
                short: "Die wichtigste √úbung f√ºr einen starken Unterk√∂rper.",
                long: "1. Stelle dich etwa schulterbreit hin, Zehen leicht nach au√üen.\n2. Schiebe den Po nach hinten unten, als w√ºrdest du dich auf einen Stuhl setzen.\n3. Halte den R√ºcken absolut gerade und die Brust aufgerichtet.\n4. Gehe so tief wie m√∂glich, wobei die Fersen fest am Boden bleiben m√ºssen.\n5. Dr√ºcke dich kontrolliert wieder nach oben."
            },
            "Crunches": {
                cat: "Bauch & Core",
                short: "Gezielte √úbung f√ºr die gerade Bauchmuskulatur.",
                long: "1. Lege dich auf den R√ºcken und stelle die Beine angewinkelt auf.\n2. Lege die H√§nde leicht an die Schl√§fen, ziehe aber nicht am Kopf.\n3. Hebe nur den oberen R√ºcken und die Schulterbl√§tter vom Boden ab.\n4. Spanne dabei den Bauch aktiv an.\n5. Senke dich langsam wieder ab, ohne die Schultern ganz abzulegen."
            },
            "Ausfallschritte": {
                cat: "Beine & Po",
                short: "St√§rkt die Beine und verbessert die Koordination.",
                long: "1. Mache einen gro√üen Schritt nach vorne.\n2. Senke das hintere Knie ab, bis es fast den Boden ber√ºhrt.\n3. Das vordere Knie sollte einen 90-Grad-Winkel bilden und nicht √ºber die Zehen ragen.\n4. Halte den Oberk√∂rper aufrecht.\n5. Dr√ºcke dich mit dem vorderen Bein zur√ºck in den Stand und wechsle die Seite."
            },
            "Dips": {
                cat: "Oberk√∂rper",
                short: "Hocheffektive √úbung f√ºr den Trizeps.",
                long: "1. St√ºtze dich mit den H√§nden auf einer stabilen Kante (Stuhl oder Sofa) hinter dir ab.\n2. Strecke die Beine nach vorne aus.\n3. Beuge die Arme und senke den Po kontrolliert in Richtung Boden.\n4. Dr√ºcke dich rein aus der Kraft der Armr√ºckseite wieder hoch."
            },
            "Burpees": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Die ultimative √úbung f√ºr Kraft und Ausdauer.",
                long: "1. Gehe aus dem Stand in die Hocke und setze die H√§nde auf.\n2. Springe mit den F√º√üen nach hinten in den Liegest√ºtz.\n3. Absolviere einen Liegest√ºtz.\n4. Springe mit den F√º√üen wieder nach vorne zu den H√§nden.\n5. Schlie√üe die Bewegung mit einem explosiven Strecksprung nach oben ab."
            },
            "Mountain Climber": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Dynamische √úbung f√ºr Core, Beine und Puls.",
                long: "1. Gehe in die Liegest√ºtzposition (H√§nde unter den Schultern).\n2. Ziehe abwechselnd und schnell ein Knie unter die Brust.\n3. Behalte eine flache H√ºftposition bei, Po nicht zu hoch.\n4. Die Bewegung sollte fl√ºssig und schnell wie ein 'Rennen im St√ºtz' sein."
            },
            "Wandsitzen": {
                cat: "Beine & Po",
                short: "Isometrische Kraft√ºbung f√ºr die Oberschenkel.",
                long: "1. Lehne dich mit dem R√ºcken flach gegen eine Wand.\n2. Rutsche nach unten, bis deine Knie einen exakten 90-Grad-Winkel bilden.\n3. Deine Oberschenkel sind parallel zum Boden.\n4. Dr√ºcke den gesamten R√ºcken fest gegen die Wand und halte diese Position statisch."
            },
            "Hampelmann": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Bew√§hrte Cardio-√úbung zum Aufw√§rmen.",
                long: "1. Stehe aufrecht mit geschlossenen Beinen und Armen an der Seite.\n2. Springe in die Gr√§tsche und f√ºhre gleichzeitig die Arme √ºber dem Kopf zusammen.\n3. Springe sofort zur√ºck in den Stand und bringe die Arme wieder an die Seiten.\n4. Achte auf weiche Landungen auf den Fu√üballen."
            },
            "Beinheben": {
                cat: "Bauch & Core",
                short: "Isolation f√ºr die untere Bauchmuskulatur.",
                long: "1. Lege dich flach auf den R√ºcken, Arme liegen neben dem K√∂rper.\n2. Hebe die gestreckten Beine langsam an, bis sie im 90 Grad Winkel zum Boden stehen.\n3. Senke sie ebenso langsam und kontrolliert wieder ab.\n4. Halte die F√º√üe kurz vor dem Boden in der Luft, bevor du die n√§chste Wiederholung startest."
            },
            "Glute Bridge": {
                cat: "Beine & Po",
                short: "Isolierte √úbung f√ºr Po und Beinr√ºckseite.",
                long: "1. R√ºckenlage, Beine angewinkelt, F√º√üe nah am Po aufgestellt.\n2. Hebe das Becken so weit wie m√∂glich in Richtung Decke.\n3. Spanne den Po am h√∂chsten Punkt f√ºr eine Sekunde maximal an.\n4. Senke das Becken langsam ab, ohne es ganz auf dem Boden abzulegen."
            },
            "High Knees": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Intensives Laufen am Platz f√ºr hohen Kalorienverbrauch.",
                long: "1. Laufe dynamisch auf der Stelle.\n2. Ziehe die Knie abwechselnd so hoch wie m√∂glich, idealerweise bis auf H√ºfth√∂he.\n3. Nimm die Arme aktiv mit.\n4. Bleibe aufrecht im Oberk√∂rper und lande federnd."
            },
            "Russian Twist": {
                cat: "Bauch & Core",
                short: "Kr√§ftigung der schr√§gen Bauchmuskulatur.",
                long: "1. Setze dich hin, winkle die Beine an und hebe die F√º√üe leicht vom Boden ab.\n2. Lehne den Oberk√∂rper leicht zur√ºck, um das Gleichgewicht zu halten.\n3. Drehe den Oberk√∂rper abwechselnd nach links und rechts.\n4. Ber√ºhre mit den H√§nden jeweils kurz den Boden neben deiner H√ºfte."
            },
            "Superman": {
                cat: "Bauch & Core",
                short: "Wichtige √úbung f√ºr den unteren R√ºcken.",
                long: "1. Lege dich flach auf den Bauch, Arme nach vorne gestreckt.\n2. Hebe gleichzeitig Arme, Brust und Beine vom Boden ab.\n3. Halte die Spannung kurz am obersten Punkt.\n4. Senke alles kontrolliert wieder ab, ohne die Arme/Beine ganz abzulegen."
            },
            "Wadenheben": {
                cat: "Beine & Po",
                short: "Isolationstraining f√ºr die Wadenmuskeln.",
                long: "1. Stehe aufrecht, F√º√üe h√ºftbreit.\n2. Dr√ºcke dich aus den Fu√üballen so hoch wie physisch m√∂glich nach oben.\n3. Halte die Kontraktion kurz oben.\n4. Senke die Fersen langsam wieder ab, bis sie fast den Boden ber√ºhren."
            },
            "Side Plank (L)": {
                cat: "Bauch & Core",
                short: "Seitlicher St√ºtz f√ºr die Taille und Stabilit√§t.",
                long: "1. Lege dich auf die linke Seite.\n2. St√ºtze dich auf dem linken Unterarm ab (Ellbogen unter der Schulter).\n3. Hebe die H√ºfte hoch, bis der K√∂rper eine gerade Linie bildet.\n4. Halte die Position statisch und lass die H√ºfte nicht absinken."
            },
            "Side Plank (R)": {
                cat: "Bauch & Core",
                short: "Seitlicher St√ºtz f√ºr die Taille und Stabilit√§t.",
                long: "1. Lege dich auf die rechte Seite.\n2. St√ºtze dich auf dem rechten Unterarm ab (Ellbogen unter der Schulter).\n3. Hebe die H√ºfte hoch, bis der K√∂rper eine gerade Linie bildet.\n4. Halte die Position statisch und lass die H√ºfte nicht absinken."
            },
            "Diamond Pushups": {
                cat: "Oberk√∂rper",
                short: "Anspruchsvolle Liegest√ºtz-Variante f√ºr den Trizeps.",
                long: "1. Gehe in Liegest√ºtzposition.\n2. Platziere die H√§nde unter der Brust so nah zusammen, dass Daumen und Zeigefinger ein Dreieck bilden.\n3. Senke dich ab, halte die Ellenbogen nah am K√∂rper.\n4. Dr√ºcke dich kraftvoll wieder hoch."
            },
            "Bicycle Crunches": {
                cat: "Bauch & Core",
                short: "Kombinierte Bauch√ºbung mit Rotation.",
                long: "1. R√ºckenlage, H√§nde leicht an den Kopf, Beine angehoben.\n2. F√ºhre den rechten Ellenbogen zum linken Knie, w√§hrend das rechte Bein gestreckt wird.\n3. Wechsle flie√üend und kontrolliert die Seiten.\n4. Achte auf die st√§ndige Spannung im Bauch."
            },
            "Flutter Kicks": {
                cat: "Bauch & Core",
                short: "Intensive √úbung f√ºr den unteren Bauchbereich.",
                long: "1. R√ºckenlage, Arme liegen flach neben dem K√∂rper oder unter dem Po.\n2. Hebe die gestreckten Beine etwa 20cm vom Boden ab.\n3. Bewege die Beine abwechselnd in kleinen, schnellen Bewegungen auf und ab.\n4. Der untere R√ºcken darf den Kontakt zum Boden nie verlieren!"
            },
            "Box Jumps": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Explosivkraft und Koordination.",
                long: "1. Stelle dich vor eine stabile Erh√∂hung (Box oder Bank).\n2. Springe beidbeinig explosiv nach oben auf die Box.\n3. Lande sanft in einer leichten Hocke.\n4. Richte dich oben komplett auf und steige kontrolliert wieder ab."
            },
            "Schattenboxen": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Bewegungstraining f√ºr Cardio und Oberk√∂rper.",
                long: "1. Gehe in eine lockere Boxstellung.\n2. Schlage abwechselnd gerade Punches (Jabs) in die Luft.\n3. Bleibe st√§ndig in Bewegung auf den Fu√üballen.\n4. Atme bei jedem Schlag explosiv aus."
            },
            "Sit-Ups": {
                cat: "Bauch & Core",
                short: "Klassische Rumpfbeuge f√ºr die Bauchkraft.",
                long: "1. R√ºckenlage, Beine angewinkelt aufgestellt.\n2. Richte den gesamten Oberk√∂rper auf, bis du in einer sitzenden Position bist.\n3. Ber√ºhre mit den H√§nden deine F√º√üe.\n4. Rolle dich Wirbel f√ºr Wirbel langsam wieder ab."
            },
            "Trizeps Dips": {
                cat: "Oberk√∂rper",
                short: "Isolation der Armstrecker ohne Zusatzgewichte.",
                long: "1. H√§nde auf eine Stuhlkante, F√º√üe vorne aufgestellt.\n2. Beuge die Ellenbogen nach hinten, bis der Po fast den Boden ber√ºhrt.\n3. Dr√ºcke dich rein aus der Kraft der Arme wieder hoch.\n4. Halte den R√ºcken nah an der Stuhlkante."
            },
            "Reverse Crunches": {
                cat: "Bauch & Core",
                short: "Gezieltes Training des unteren Bauchbereichs.",
                long: "1. R√ºckenlage, Beine in der Luft angewinkelt.\n2. Ziehe die Knie in Richtung Brust und hebe dabei das Becken vom Boden ab.\n3. Nutze keinen Schwung, sondern nur die Kraft der Bauchmuskeln.\n4. Senke das Becken langsam und kontrolliert wieder ab."
            },
            "Plank Jacks": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Plank kombiniert mit dynamischen Beinspr√ºngen.",
                long: "1. Starte in der Unterarmst√ºtz-Position (Plank).\n2. Springe mit den F√º√üen wie beim Hampelmann auseinander und wieder zusammen.\n3. Halte den Rumpf dabei so stabil wie m√∂glich, der Po sollte nicht auf und ab wippen."
            },
            "Skater Jumps": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Seitliche Sprungkraft und Stabilit√§t.",
                long: "1. Springe seitlich nach rechts und lande auf dem rechten Fu√ü.\n2. Kreuze das linke Bein hinter dem rechten und ber√ºhre kurz den Boden.\n3. Springe sofort kraftvoll nach links um.\n4. Nutze die Arme aktiv f√ºr Balance und Schwung."
            },
            "Donkey Kicks": {
                cat: "Beine & Po",
                short: "Isolation f√ºr den gro√üen Ges√§√ümuskel.",
                long: "1. Gehe in den Vierf√º√ülerstand (H√§nde und Knie).\n2. Hebe ein Bein angewinkelt nach oben, die Fu√üsohle zeigt zur Decke.\n3. Spanne den Po am h√∂chsten Punkt fest an.\n4. Bringe das Knie zur√ºck in Richtung Boden, ohne es ganz abzusetzen."
            },
            "Fire Hydrants": {
                cat: "Beine & Po",
                short: "Kr√§ftigung der Abduktoren und der Ges√§√ümuskulatur.",
                long: "1. Vierf√º√ülerstand.\n2. Hebe ein angewinkeltes Bein seitlich nach oben.\n3. Halte den R√ºcken dabei stabil und gerade, vermeide das seitliche Wegkippen.\n4. Senke das Bein langsam wieder ab."
            },
            "Armkreisen": {
                cat: "Oberk√∂rper",
                short: "Kleine Bewegungen f√ºr gro√üe Ausdauer in den Schultern.",
                long: "1. Stehe aufrecht und strecke die Arme waagerecht zur Seite aus.\n2. Mache kleine, sehr schnelle Kreise mit den H√§nden.\n3. Halte die Spannung in den Schultern.\n4. Nach der H√§lfte der Zeit wechselst du die Drehrichtung."
            },
            "Seitl. Beinheben": {
                cat: "Beine & Po",
                short: "Gezielte √úbung f√ºr die H√ºftstabilit√§t.",
                long: "1. Lege dich gestreckt auf die Seite.\n2. Hebe das obere Bein gestreckt so weit wie m√∂glich nach oben.\n3. Halte die Spannung oben kurz.\n4. Senke das Bein langsam ab, ohne das untere Bein zu ber√ºhren."
            },
            "K√§fer (Dead Bug)": {
                cat: "Bauch & Core",
                short: "Koordinative Core-√úbung f√ºr einen starken Rumpf.",
                long: "1. R√ºckenlage, Beine im 90 Grad Winkel in der Luft, Arme zeigen zur Decke.\n2. Strecke gleichzeitig den rechten Arm nach hinten und das linke Bein nach vorne aus.\n3. Dein unterer R√ºcken muss fest in den Boden gepresst bleiben!\n4. Kehre zur Mitte zur√ºck und wechsle diagonal die Seite."
            },
            "Hollow Body": {
                cat: "Bauch & Core",
                short: "Anspruchsvolle Halte√ºbung aus dem Turnen.",
                long: "1. R√ºckenlage, Arme gestreckt hinter den Kopf.\n2. Hebe gestreckte Beine und Schultern gleichzeitig leicht vom Boden ab.\n3. Dein K√∂rper sollte nun wie eine flache Banane geformt sein.\n4. Halte die Spannung, w√§hrend du den unteren R√ºcken aktiv in den Boden presst."
            },
            "Inchworm": {
                cat: "Ganzk√∂rper & Cardio",
                short: "Ganzk√∂rper-Mobilit√§t und Kraft.",
                long: "1. Aus dem Stand mit den H√§nden so nah wie m√∂glich an den F√º√üen zum Boden beugen.\n2. Laufe mit den H√§nden nach vorne, bis du im Liegest√ºtz bist.\n3. Halte die Position kurz.\n4. Laufe mit den H√§nden wieder zur√ºck zu den F√º√üen und richte dich komplett auf."
            },
            "Wall Pushups": {
                cat: "Oberk√∂rper",
                short: "Einsteiger-Variante des Liegest√ºtzes.",
                long: "1. Stehe etwa einen Meter vor einer Wand.\n2. Lege die H√§nde flach auf Schulterh√∂he gegen die Wand.\n3. Beuge die Arme und bringe die Brust kontrolliert zur Wand.\n4. Dr√ºcke dich kraftvoll wieder ab."
            }
        };

        const CHECKLIST_ITEMS = ["Protein Shake", "Kreatin", "Vitamine", "Eisen", "Magnesium"];

        /**
         * GLOBALER DATENSPEICHER
         */
        let db = {
            profile: { height: 0, weight: 0, age: 0 },
            config: { work: 40, rest: 20, duration: 10, note: "" },
            status: { water: 0, waterDate: "", checklist: [false,false,false,false,false], streak: 0, lastWorkout: 0 },
            history: [],
            measurements: [],
            meta: { installed: Date.now() }
        };

        let player = {
            timerId: null,
            running: false,
            time: 10,
            phase: 'PREP',
            idx: 0,
            plan: []
        };

        let audioContext = null;
        let isMuted = false;

        // ======================================================
        // APP CONTROLLER (VOLLST√ÑNDIG)
        // ======================================================

        const AppController = {
            save: function() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
            },

            finishSetup: function() {
                const h = parseFloat(document.getElementById('setup-height').value);
                const w = parseFloat(document.getElementById('setup-weight').value);
                const a = parseFloat(document.getElementById('setup-age').value);
                
                if(h > 50 && w > 10) {
                    db.profile.height = h;
                    db.profile.weight = w;
                    db.profile.age = a || 25;
                    db.status.waterDate = new Date().toDateString();
                    this.save();
                    document.getElementById('overlay-setup').style.display = 'none';
                    UserInterface.refreshAll();
                } else {
                    alert("Bitte gib g√ºltige Werte ein.");
                }
            },

            checkDailyReset: function() {
                const today = new Date().toDateString();
                if(db.status.waterDate !== today) {
                    db.status.water = 0;
                    db.status.waterDate = today;
                    db.status.checklist = [false, false, false, false, false];
                    this.save();
                }
            },

            addWater: function(val) {
                db.status.water = Math.max(0, db.status.water + val);
                this.save();
                UserInterface.refreshAll();
            },

            setDuration: function(val) {
                db.config.duration = val;
                this.save();
                UserInterface.refreshAll();
            },

            saveNote: function(val) {
                db.config.note = val;
                this.save();
            },

            updateConfig: function() {
                db.config.work = parseInt(document.getElementById('range-work').value);
                db.config.rest = parseInt(document.getElementById('range-rest').value);
                this.save();
                UserInterface.refreshAll();
            },

            saveMeasurement: function() {
                const wInput = document.getElementById('m-weight').value;
                
                // Wir erzwingen Zahlen oder 0, um NaN Fehler zu vermeiden
                const entry = {
                    date: new Date().toISOString(),
                    w: parseFloat(wInput) || 0,
                    b: parseFloat(document.getElementById('m-waist').value) || 0,
                    c: parseFloat(document.getElementById('m-chest').value) || 0,
                    a: parseFloat(document.getElementById('m-arm').value) || 0,
                    l: parseFloat(document.getElementById('m-leg').value) || 0,
                    g: parseFloat(document.getElementById('m-glute').value) || 0
                };
                
                // Gewicht ist Pflicht, der Rest optional
                if(entry.w > 0) {
                    db.profile.weight = entry.w;
                    db.measurements.push(entry);
                    this.save();
                    UserInterface.refreshAll();
                    alert("Werte erfolgreich gespeichert!");
                    
                    // Felder leeren
                    document.querySelectorAll('#screen-stats input').forEach(i => i.value = "");
                } else {
                    alert("Bitte mindestens das Gewicht eintragen.");
                }
            },

            clearAll: function() {
                if(confirm("Bist du sicher? Alle Fortschritte, die Historie und deine Messungen werden unwiderruflich gel√∂scht.")) {
                    localStorage.removeItem(STORAGE_KEY);
                    location.reload();
                }
            }
        };

        // ======================================================
        // USER INTERFACE LOGIK (VOLLST√ÑNDIG)
        // ======================================================

        const UserInterface = {
            nav: function(screenId, el) {
                document.querySelectorAll('.app-screen-container').forEach(s => s.classList.remove('screen-active'));
                document.getElementById(screenId).classList.add('screen-active');
                document.querySelectorAll('.nav-item-btn').forEach(b => b.classList.remove('nav-active'));
                el.classList.add('nav-active');
            },

            closeOverlay: function(id) {
                document.getElementById(id).style.display = 'none';
            },

            openDaily: function() {
                const container = document.getElementById('checklist-container');
                container.innerHTML = "<h2 class='sub-headline-text'>DAILY SUPPLEMENTS</h2>";
                
                CHECKLIST_ITEMS.forEach((label, i) => {
                    const row = document.createElement('div');
                    row.className = "checklist-row-item" + (db.status.checklist[i] ? " item-checked" : "");
                    row.innerHTML = `<div class="checkbox-indicator"></div><span style="font-weight:700;">${label}</span>`;
                    row.onclick = () => {
                        db.status.checklist[i] = !db.status.checklist[i];
                        AppController.save();
                        UserInterface.openDaily();
                    };
                    container.appendChild(row);
                });
                document.getElementById('overlay-daily').style.display = 'flex';
            },

            openLibrary: function() {
                const list = document.getElementById('library-list');
                list.innerHTML = "";
                
                const sortedKeys = Object.keys(EXERCISES).sort();
                sortedKeys.forEach(key => {
                    const ex = EXERCISES[key];
                    const card = document.createElement('div');
                    card.className = "ui-card";
                    card.style.cursor = "pointer";
                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <b style="font-size:16px;">${key}</b>
                            <span style="font-size:10px; color:var(--color-accent-purple); font-weight:800; text-transform:uppercase;">${ex.cat}</span>
                        </div>
                        <p style="font-size:13px; color:#aaa; margin-bottom:8px;">${ex.short}</p>
                        <div style="text-align:right;">
                            <span style="color:var(--color-accent-blue); font-size:11px; font-weight:800;">ZUR ANLEITUNG ‚ñ∏</span>
                        </div>
                    `;
                    card.onclick = () => UserInterface.showDetail(key);
                    list.appendChild(card);
                });
                document.getElementById('overlay-library').style.display = 'flex';
            },

            showDetail: function(key) {
                const ex = EXERCISES[key];
                document.getElementById('detail-title').innerText = key;
                document.getElementById('detail-category').innerText = ex.cat;
                document.getElementById('detail-body').innerText = ex.long;
                document.getElementById('overlay-detail').style.display = 'flex';
            },

            refreshAll: function() {
                // Header & KPIs
                const dayCounter = Math.ceil((Date.now() - db.meta.installed) / 86400000);
                document.getElementById('home-day-title').innerText = "TAG " + (dayCounter || 1);
                document.getElementById('home-date-title').innerText = new Date().toLocaleDateString('de-DE', { weekday:'long', day:'2-digit', month:'long' }).toUpperCase();
                document.getElementById('home-streak-val').innerText = db.status.streak;
                
                const hMeters = db.profile.height / 100;
                const bmi = (db.profile.weight / (hMeters * hMeters)).toFixed(1);
                document.getElementById('home-bmi').innerText = isNaN(bmi) ? "-" : bmi;
                
                const totalKcal = db.history.reduce((acc, curr) => acc + (curr.kcal || 0), 0);
                document.getElementById('home-kcal').innerText = totalKcal.toLocaleString();
                document.getElementById('home-lvl').innerText = 1 + Math.floor(totalKcal / 1000);

                // Wasserstand
                document.getElementById('home-water-text').innerText = (db.status.water * 0.25).toFixed(1) + " / 2.5L";
                document.getElementById('home-water-bar').style.width = Math.min((db.status.water / 10) * 100, 100) + "%";

                // Dauer Buttons
                document.querySelectorAll('.small-toggle-button[id^="dur-"]').forEach(btn => btn.classList.remove('button-active'));
                const activeBtn = document.getElementById('dur-' + db.config.duration);
                if(activeBtn) activeBtn.classList.add('button-active');

                // Settings
                document.getElementById('range-work').value = db.config.work;
                document.getElementById('range-rest').value = db.config.rest;
                document.getElementById('val-work').innerText = db.config.work + "s";
                document.getElementById('val-rest').innerText = db.config.rest + "s";

                // Notizen
                document.getElementById('note-input').value = db.config.note;

                // Historie & Statistik
                StatsSystem.render();
            }
        };

        // ======================================================
        // PLAYER SYSTEM (VOLLST√ÑNDIG)
        // ======================================================

        const PlayerSystem = {
            start: function() {
                if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                const focus = document.getElementById('home-focus').value;
                const totalWorkSeconds = db.config.duration * 60;
                const cycleTime = db.config.work + db.config.rest;
                const exerciseCount = Math.max(1, Math.floor(totalWorkSeconds / cycleTime));

                let primaryPool = [];
                let secondaryPool = [];
                
                Object.keys(EXERCISES).forEach(key => {
                    if(focus === 'all' || EXERCISES[key].cat === focus) {
                        primaryPool.push(key);
                    } else {
                        secondaryPool.push(key);
                    }
                });

                let workoutPlan = [];
                for(let i=0; i < exerciseCount; i++) {
                    if(focus === 'all' || Math.random() < 0.75) {
                        workoutPlan.push(primaryPool[Math.floor(Math.random() * primaryPool.length)]);
                    } else {
                        workoutPlan.push(secondaryPool[Math.floor(Math.random() * secondaryPool.length)]);
                    }
                }

                player.plan = workoutPlan;
                player.idx = 0;
                player.phase = 'PREP';
                player.time = 10;
                player.running = false;

                document.getElementById('overlay-player').style.display = 'flex';
                this.draw();
            },

            toggle: function() {
                const btn = document.getElementById('player-play-pause');
                if(player.running) {
                    clearInterval(player.timerId);
                    player.running = false;
                    btn.innerText = "WEITER";
                } else {
                    player.timerId = setInterval(this.tick.bind(this), 1000);
                    player.running = true;
                    btn.innerText = "PAUSE";
                }
            },

            tick: function() {
                if(player.time > 0) {
                    player.time--;
                    if(player.time < 4 && player.time > 0) this.beep(600);
                    this.draw();
                } else {
                    this.beep(900);
                    this.nextPhase();
                }
            },

            nextPhase: function() {
                if(player.phase === 'PREP') {
                    player.phase = 'WORK';
                    player.time = db.config.work;
                } else if(player.phase === 'WORK') {
                    if(player.idx >= player.plan.length - 1) {
                        this.finish();
                        return;
                    }
                    player.phase = 'REST';
                    player.time = db.config.rest;
                } else {
                    player.idx++;
                    player.phase = 'WORK';
                    player.time = db.config.work;
                }
                this.draw();
            },

            skip: function() {
                if(player.phase !== 'WORK') {
                    player.time = 0;
                    this.nextPhase();
                } else {
                    alert("Halte durch! In der Belastungsphase kannst du nicht √ºberspringen.");
                }
            },

            draw: function() {
                document.getElementById('player-timer').innerText = player.time;
                document.getElementById('player-phase').innerText = player.phase === 'PREP' ? "BEREIT MACHEN" : (player.phase === 'WORK' ? "LOS GEHT'S!" : "PAUSE");
                
                const color = player.phase === 'WORK' ? "var(--color-accent-green)" : (player.phase === 'REST' ? "var(--color-accent-blue)" : "#fff");
                document.getElementById('player-phase').style.color = color;
                document.getElementById('player-ring').style.stroke = color;

                const maxTime = player.phase === 'WORK' ? db.config.work : (player.phase === 'REST' ? db.config.rest : 10);
                document.getElementById('player-ring').style.strokeDashoffset = 754 - (player.time / maxTime) * 754;

                const exName = player.plan[player.idx];
                const ex = EXERCISES[exName];

                if(player.phase !== 'REST') {
                    document.getElementById('player-ex-name').innerText = exName.toUpperCase();
                    document.getElementById('player-ex-cat').innerText = ex.cat;
                    document.getElementById('player-guide-trigger').style.display = 'block';
                    document.getElementById('player-next-box').style.display = 'none';
                } else {
                    document.getElementById('player-ex-name').innerText = "PAUSE";
                    document.getElementById('player-ex-cat').innerText = "ATMUNG REGULIEREN";
                    document.getElementById('player-guide-trigger').style.display = 'none';
                    
                    const nextExName = player.plan[player.idx + 1];
                    document.getElementById('player-next-box').style.display = 'block';
                    document.getElementById('player-next-name').innerText = nextExName;
                }
                
                document.getElementById('player-status-round').innerText = `√úBUNG ${player.idx + 1} / ${player.plan.length}`;
            },

            showCurrentGuide: function() {
                UserInterface.showDetail(player.plan[player.idx]);
            },

            showNextGuide: function() {
                UserInterface.showDetail(player.plan[player.idx + 1]);
            },

            finish: function() {
                clearInterval(player.timerId);
                document.getElementById('overlay-player').style.display = 'none';
                document.getElementById('overlay-rating').style.display = 'flex';
            },

            saveAndFinish: function() {
                const intensity = document.getElementById('rating-slider').value;
                const kcalBurned = db.config.duration * 8; // Durchschnittswert
                
                db.history.push({
                    date: new Date().toISOString(),
                    kcal: kcalBurned,
                    rating: intensity,
                    type: "Live Training"
                });

                // Streak Logik
                const lastDate = new Date(db.status.lastWorkout).toDateString();
                const todayDate = new Date().toDateString();
                if(lastDate !== todayDate) {
                    db.status.streak++;
                    db.status.lastWorkout = Date.now();
                }

                AppController.save();
                UserInterface.refreshAll();
                document.getElementById('overlay-rating').style.display = 'none';
                alert("Training erfolgreich gespeichert!");
            },

            exit: function() {
                if(confirm("Training wirklich beenden? Dein Fortschritt geht verloren.")) {
                    clearInterval(player.timerId);
                    document.getElementById('overlay-player').style.display = 'none';
                }
            },

            beep: function(freq) {
                if(isMuted || !audioContext) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = freq;
                gainNode.gain.value = 0.1;
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.15);
            },

            toggleMute: function() {
                isMuted = !isMuted;
                document.getElementById('player-mute').innerText = isMuted ? "üîá" : "üîä";
            }
        };

        // ======================================================
        // STATISTIK & HISTORIE SYSTEM (VOLLST√ÑNDIG)
        // ======================================================

        const StatsSystem = {
            render: function() {
                // Gewichts-Graph
                const svg = document.getElementById('weight-svg');
                svg.innerHTML = "";
                if(db.measurements.length > 1) {
                    const weightValues = db.measurements.map(m => parseFloat(m.w));
                    const minWeight = Math.min(...weightValues) - 1;
                    const maxWeight = Math.max(...weightValues) + 1;
                    const points = weightValues.map((w, i) => {
                        const x = (i / (weightValues.length - 1)) * 100;
                        const y = 100 - ((w - minWeight) / (maxWeight - minWeight) * 100);
                        return `${x},${y}`;
                    }).join(' ');
                    svg.innerHTML = `<polyline points="${points}" fill="none" stroke="#32d74b" stroke-width="3" stroke-linejoin="round"/>`;
                }

                // Vergleichstabelle
                const compTableDiv = document.getElementById('compare-table-div');
                if(db.measurements.length >= 2) {
                    const current = db.measurements[db.measurements.length - 1];
                    const previous = db.measurements[db.measurements.length - 2];
                    
                    const fields = [
                        {key:'w', label:'Gewicht'}, 
                        {key:'b', label:'Bauch'}, 
                        {key:'c', label:'Brust'},
                        {key:'a', label:'Arm'}, 
                        {key:'l', label:'Bein'}, 
                        {key:'g', label:'Po'}
                    ];
                    
                    let tableHtml = `<table class="comparison-table">`;
                    fields.forEach(f => {
                        const valCur = parseFloat(current[f.key]) || 0;
                        const valPre = parseFloat(previous[f.key]) || 0;
                        
                        // Nur anzeigen, wenn mindestens einer der Werte > 0 ist
                        if(valCur > 0 || valPre > 0) {
                            const diff = valCur - valPre;
                            let cssClass = "diff-neutral";
                            
                            if(diff !== 0) {
                                if(f.key === 'w') {
                                    cssClass = diff < 0 ? "diff-positive" : "diff-negative";
                                } else {
                                    cssClass = diff > 0 ? "diff-positive" : "diff-negative";
                                }
                            }
                            
                            tableHtml += `
                                <tr>
                                    <td>${f.label}</td>
                                    <td>${valCur > 0 ? valCur : '-'}</td>
                                    <td class="${cssClass}">${diff > 0 ? "+" : ""}${diff.toFixed(1)}</td>
                                </tr>`;
                        }
                    });
                    compTableDiv.innerHTML = tableHtml + "</table>";
                }

                // Trainings-Historie
                const historyList = document.getElementById('workout-history-list');
                historyList.innerHTML = "<h2 class='sub-headline-text'>TRAININGS-VERLAUF</h2>";
                
                const reversedHistory = [...db.history].reverse().slice(0, 10);
                if(reversedHistory.length === 0) {
                    historyList.innerHTML += "<p style='color:#666; font-size:12px;'>Noch keine Trainings absolviert.</p>";
                }
                
                reversedHistory.forEach(entry => {
                    const card = document.createElement('div');
                    card.className = "ui-card";
                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:800; margin-bottom:4px;">
                            <span>${entry.type}</span>
                            <span style="color:#666;">${new Date(entry.date).toLocaleDateString('de-DE')}</span>
                        </div>
                        <div style="color:var(--color-accent-blue); font-size:12px; font-weight:700;">
                            ${entry.kcal} kcal verbrannt ‚Ä¢ Intensit√§t: ${entry.rating}/10
                        </div>
                    `;
                    historyList.appendChild(card);
                });
            }
        };

        const BackupSystem = {
            export: function() {
                const blob = new Blob([JSON.stringify(db)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bodypulse_backup_' + new Date().toISOString().split('T')[0] + '.json';
                a.click();
            },
            
            // HIER IST DER FIX F√úR ALTE BACKUPS
            import: function(input) {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        let importedData = JSON.parse(e.target.result);
                        
                        // FIX: Pr√ºfen, ob das Backup aus einer alten Version (Variable "appData") kommt
                        // Alte Versionen hatten eine andere Struktur, wir mappen sie um.
                        if(!importedData.profile && importedData.height) {
                            // Sehr altes Format, wir versuchen es zu retten
                             alert("Dieses Backup ist zu alt und nicht kompatibel.");
                             return;
                        }

                        // Falls das Backup Struktur hat, aber wir sichergehen wollen
                        db = importedData;
                        
                        AppController.save();
                        alert("Backup erfolgreich geladen!");
                        location.reload();
                    } catch(err) {
                        alert("Fehler beim Laden des Backups. Datei besch√§digt?");
                        console.error(err);
                    }
                };
                reader.readAsText(input.files[0]);
            }
        };
    </script>
</body>
</html>
