<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Body Pulse V18.1 - FINAL UNCUT</title>

    <style>
        /* ======================================================================
           1. CSS RESET & VARIABLEN
           ====================================================================== */
        :root {
            --color-bg: #000000;
            --color-surface: #121212;
            --color-surface-bright: #1c1c1e;
            --color-border: #333333;
            --color-text: #ffffff;
            --color-text-muted: #8e8e93;
            
            --color-accent: #32d74b;  /* Neon Gr√ºn */
            --color-blue: #0a84ff;    /* Wasser Blau */
            --color-orange: #ff9f0a;  /* Streak Orange */
            --color-red: #ff453a;     /* Danger / Stop */
            
            --font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
            
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
            
            --shadow-card: 0 4px 20px rgba(0,0,0,0.4);
        }

        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        html, body {
            position: fixed;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-family);
            overflow: hidden;
            touch-action: none;
        }

        body {
            display: flex;
            flex-direction: column;
            padding-top: var(--safe-area-top);
        }

        /* ======================================================================
           2. LAYOUT CONTAINER & ANIMATIONEN
           ====================================================================== */
        .app-screen {
            flex: 1;
            display: none; /* JS Toggle */
            flex-direction: column;
            width: 100%;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 120px; /* Platz f√ºr Navleiste */
            -webkit-overflow-scrolling: touch;
        }

        .app-screen.active {
            display: flex;
            animation: fadeEffect 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }

        @keyframes fadeEffect {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar Verstecken */
        ::-webkit-scrollbar { display: none; }

        /* ======================================================================
           3. KARTEN & UI ELEMENTE
           ====================================================================== */
        .card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 14px;
            box-shadow: var(--shadow-card);
            position: relative;
        }

        /* NOTIZEN SPECIAL RAHMEN */
        .card-white-border {
            background-color: var(--color-surface-bright);
            border: 2px solid #ffffff !important;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.15);
        }

        h1 {
            font-size: 28px;
            font-weight: 800;
            margin: 0;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        h2 {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--color-text-muted);
            margin: 0 0 12px 0;
        }

        .label {
            font-size: 10px;
            font-weight: 700;
            color: #666;
            margin-bottom: 4px;
            display: block;
            text-transform: uppercase;
        }

        /* GRID SYSTEM */
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 10px;
        }

        /* STAT BOXES */
        .kpi-box {
            background: var(--color-surface-bright);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            border: 1px solid var(--color-border);
        }
        .kpi-val { font-size: 19px; font-weight: 800; display: block; margin-top: 2px; }
        .kpi-lbl { font-size: 9px; color: #888; font-weight: 700; text-transform: uppercase; }

        /* BUTTONS */
        .btn {
            background-color: var(--color-text);
            color: #000000;
            border: none;
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.97); opacity: 0.9; }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }
        .btn-outline:active { background: rgba(255,255,255,0.1); }

        .btn-pill {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--color-border);
            background: transparent;
            color: var(--color-text-muted);
            font-size: 11px;
            font-weight: 700;
        }
        .btn-pill.active {
            background: var(--color-text);
            color: #000;
            border-color: var(--color-text);
        }

        /* INPUTS */
        input, select, textarea {
            width: 100%;
            background: #000;
            border: 1px solid var(--color-border);
            color: white;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            margin-bottom: 10px;
            -webkit-appearance: none;
        }
        input:focus, textarea:focus { border-color: var(--color-blue); }

        /* ======================================================================
           4. FEATURE: WASSER TRACKER (SLIM)
           ====================================================================== */
        .water-module-slim {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 5px;
        }
        .water-btn-small {
            width: 32px; height: 32px;
            border-radius: 8px;
            background: var(--color-surface-bright);
            border: 1px solid var(--color-border);
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
        }
        .water-track-bg {
            flex: 1;
            height: 10px; /* Schmaler */
            background: #222;
            border-radius: 5px;
            overflow: hidden;
        }
        .water-fill-bar {
            height: 100%;
            width: 0%;
            background: var(--color-blue);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ======================================================================
           5. FEATURE: MANUAL LOG STACK
           ====================================================================== */
        .log-stack-item {
            background: var(--color-surface-bright);
            border-left: 4px solid var(--color-accent);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from{opacity:0; transform:translateX(-10px);} to{opacity:1; transform:translateX(0);} }

        .log-set-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #000;
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
        }
        .log-set-input {
            width: 80px;
            border: none;
            background: transparent;
            text-align: right;
            font-weight: bold;
            font-size: 16px;
            padding: 0; margin: 0;
        }

        /* ======================================================================
           6. FEATURE: CHECKLIST POPUP
           ====================================================================== */
        .check-row {
            display: flex;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #333;
            cursor: pointer;
        }
        .check-viz {
            width: 26px; height: 26px;
            border: 2px solid #555;
            border-radius: 8px;
            margin-right: 15px;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .check-row.checked .check-viz {
            background: var(--color-accent);
            border-color: var(--color-accent);
            color: #000;
        }
        .check-row.checked .check-viz::after {
            content: '‚úì'; font-weight: 900;
        }

        /* ======================================================================
           7. OVERLAYS (VOLLBILD MODALE)
           ====================================================================== */
        .overlay-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000000;
            z-index: 5000;
            display: none;
            flex-direction: column;
            padding: var(--safe-area-top) 20px 20px 20px;
        }

        .overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .overlay-scroll {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        /* PLAYER ELEMENTS */
        .player-circle-container {
            position: relative;
            width: 260px;
            height: 260px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-svg {
            position: absolute; top:0; left:0;
            width: 100%; height: 100%;
            transform: rotate(-90deg);
        }
        .player-time-text {
            font-size: 90px;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
            z-index: 10;
        }

        /* ======================================================================
           8. NAVIGATION BAR
           ====================================================================== */
        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 85px;
            background: rgba(10,10,10,0.96);
            border-top: 1px solid var(--color-border);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding-bottom: var(--safe-area-bottom);
            z-index: 1000;
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0.4;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-btn.active {
            opacity: 1;
            transform: translateY(-3px);
            color: var(--color-text);
        }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }
        .nav-text { font-size: 10px; font-weight: 800; letter-spacing: 0.5px; }

    </style>
</head>
<body>

    <div id="ov-setup" class="overlay-container" style="z-index:9000; justify-content:center;">
        <h1 style="text-align:center;">WILLKOMMEN</h1>
        <p style="text-align:center; color:#888; margin-bottom:30px;">Profil einrichten</p>
        <div class="card">
            <span class="label">K√ñRPERGR√ñSSE (CM)</span>
            <input type="number" id="inp-setup-h" placeholder="180">
            <span class="label">GEWICHT (KG)</span>
            <input type="number" id="inp-setup-w" placeholder="80">
            <span class="label">ALTER</span>
            <input type="number" id="inp-setup-a" placeholder="30">
        </div>
        <button class="btn" onclick="app.finishSetup()">PROFIL SPEICHERN</button>
    </div>

    <div id="ov-daily" class="overlay-container">
        <div class="overlay-header">
            <h1>DAILY CHECK</h1>
            <div onclick="ui.closeDaily()" style="font-size:20px; padding:10px;">‚úï</div>
        </div>
        <div class="overlay-scroll">
            <div class="card">
                <div id="daily-list-container">
                    </div>
            </div>
            <div class="card">
                <h2>NOTIZEN</h2>
                <textarea id="daily-note-text" style="height:120px; background:transparent; border:none; border-bottom:1px solid #555;" placeholder="Wie war dein Tag?..." oninput="app.saveNote(this.value)"></textarea>
            </div>
        </div>
    </div>

    <div id="ov-manual" class="overlay-container">
        <div class="overlay-header">
            <h1>LOGBUCH</h1>
            <div onclick="ui.closeManual()" style="font-size:20px; padding:10px;">‚úï</div>
        </div>
        <div class="overlay-scroll">
            <div class="card" style="background:var(--color-surface-bright);">
                <span class="label">1. √úBUNG</span>
                <select id="man-ex-select" style="margin-bottom:10px;"></select>
                
                <span class="label">2. ANZAHL RUNDEN</span>
                <input type="number" id="man-rounds-count" value="3" min="1" max="10">
                
                <button class="btn" style="margin-top:15px;" onclick="logSys.addToStack()">+ HINZUF√úGEN</button>
            </div>

            <div id="manual-stack-list" style="margin-top:20px;"></div>
        </div>
        <div style="padding-top:10px;">
            <button class="btn" style="background:var(--color-accent); color:#000;" onclick="logSys.saveStack()">GESAMTES TRAINING SPEICHERN</button>
        </div>
    </div>

    <div id="ov-player" class="overlay-container">
        <div class="overlay-header">
            <div onclick="player.exit()" style="font-size:14px; font-weight:bold; color:#888;">BEENDEN</div>
            <span id="p-info" style="font-weight:800; color:#fff;">RUNDE 1</span>
            <div id="p-mute" onclick="player.toggleMute()" style="font-size:20px;">üîä</div>
        </div>

        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div id="p-phase" style="font-size:20px; font-weight:900; color:var(--color-accent); letter-spacing:4px; margin-bottom:10px;">READY</div>
            
            <div class="player-circle-container">
                <svg class="player-svg">
                    <circle cx="130" cy="130" r="120" stroke="#222" stroke-width="12" fill="none"/>
                    <circle id="p-ring" cx="130" cy="130" r="120" stroke="white" stroke-width="12" fill="none"
                            stroke-dasharray="754" stroke-dashoffset="0" style="transition: stroke-dashoffset 1s linear;"/>
                </svg>
                <div id="p-time" class="player-time-text">10</div>
            </div>

            <div id="p-ex-name" style="font-size:28px; font-weight:900; text-align:center; margin-top:20px;">√úBUNG</div>
        </div>

        <div class="grid-2">
            <button class="btn" id="p-btn-main" onclick="player.toggle()">START</button>
            <button class="btn btn-outline" id="p-btn-skip" onclick="player.skip()">PAUSE SKIP</button>
        </div>
    </div>

    <div id="view-home" class="app-screen active">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
            <div>
                <h1 id="home-day">TAG 1</h1>
                <span id="home-date" style="font-size:12px; font-weight:700; color:var(--color-accent);">LADEN...</span>
            </div>
            <div style="text-align:right;">
                <span class="label">STREAK</span>
                <span style="font-size:24px; font-weight:900; color:var(--color-orange);">üî• <span id="home-streak">0</span></span>
            </div>
        </div>

        <div class="grid-3">
            <div class="kpi-box"><span class="kpi-lbl">BMI</span><span class="kpi-val" id="kpi-bmi">-</span></div>
            <div class="kpi-box"><span class="kpi-lbl">KCAL</span><span class="kpi-val" id="kpi-kcal">0</span></div>
            <div class="kpi-box"><span class="kpi-lbl">LEVEL</span><span class="kpi-val" id="kpi-lvl">1</span></div>
        </div>

        <div class="card" style="padding:12px 16px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                <h2 style="margin:0; font-size:10px;">WASSER</h2>
                <span id="water-val" style="font-size:12px; font-weight:bold; color:var(--color-blue);">0.0L</span>
            </div>
            <div class="water-module-slim">
                <button class="water-btn-small" onclick="app.modWater(-1)">-</button>
                <div class="water-track-bg"><div id="water-bar" class="water-fill-bar"></div></div>
                <button class="water-btn-small" style="background:var(--color-blue); border:none;" onclick="app.modWater(1)">+</button>
            </div>
        </div>

        <div class="card">
            <h2 style="color:white;">WORKOUT</h2>
            <div class="grid-3" style="margin-bottom:8px;">
                <button id="pre-10" class="btn-pill" onclick="app.setDur(10)">10 MIN</button>
                <button id="pre-20" class="btn-pill" onclick="app.setDur(20)">20 MIN</button>
                <button id="pre-30" class="btn-pill" onclick="app.setDur(30)">30 MIN</button>
            </div>
            <div style="margin-bottom:15px; display:flex; align-items:center; gap:10px;">
                <input type="number" id="custom-min" placeholder="Minuten..." style="margin:0; text-align:center;" oninput="app.setCustomDur(this.value)">
            </div>
            
            <div class="grid-2">
                <button class="btn" onclick="player.init()">START</button>
                <button class="btn btn-outline" onclick="logSys.open()">LOGBUCH</button>
            </div>
        </div>

        <button class="btn btn-outline" style="border-color:#fff; color:#fff; margin-bottom:20px;" onclick="ui.openDaily()">
            DAILY CHECK & NOTIZEN
        </button>

        <div class="card card-white-border">
            <h2 style="color:#000;">DEINE HEUTIGE NOTIZ</h2>
            <div id="home-note-preview" style="color:#333; font-style:italic; min-height:20px;">Keine Notiz...</div>
        </div>
    </div>

    <div id="view-stats" class="app-screen">
        <h1>STATISTIK</h1>

        <div class="card" style="margin-top:20px;">
            <h2>TRAININGS FREQUENZ</h2>
            <div class="grid-3">
                <div class="kpi-box"><span class="kpi-lbl">WOCHE</span><span class="kpi-val" id="stat-week">0</span></div>
                <div class="kpi-box"><span class="kpi-lbl">MONAT</span><span class="kpi-val" id="stat-month">0</span></div>
                <div class="kpi-box"><span class="kpi-lbl">JAHR</span><span class="kpi-val" id="stat-year">0</span></div>
            </div>
        </div>

        <div class="card">
            <h2>GEWICHTSVERLAUF</h2>
            <div style="height:160px; width:100%; position:relative;">
                <svg id="chart-svg" width="100%" height="100%" preserveAspectRatio="none" style="overflow:visible;"></svg>
            </div>
        </div>

        <div class="card">
            <h2>MESSDATEN</h2>
            <div class="grid-2">
                <div><span class="label">GEWICHT</span><input type="number" id="m-weight"></div>
                <div><span class="label">BAUCH</span><input type="number" id="m-waist"></div>
            </div>
            <div class="grid-2">
                <div><span class="label">BRUST</span><input type="number" id="m-chest"></div>
                <div><span class="label">PO</span><input type="number" id="m-glute"></div>
            </div>
            <div class="grid-2">
                <div><span class="label">ARM</span><input type="number" id="m-arm"></div>
                <div><span class="label">BEIN</span><input type="number" id="m-leg"></div>
            </div>
            <button class="btn btn-outline" onclick="app.logBody()">SPEICHERN</button>
        </div>

        <div id="history-list"></div>
    </div>

    <div id="view-settings" class="app-screen">
        <h1>SYSTEM</h1>
        
        <div class="card" style="margin-top:20px;">
            <h2>TIMER</h2>
            <div style="display:flex; justify-content:space-between;"><span>Belastung</span><b id="lbl-work">40s</b></div>
            <input type="range" id="rng-work" min="20" max="120" step="5" oninput="app.updSettings()">
            
            <div style="display:flex; justify-content:space-between; margin-top:10px;"><span>Pause</span><b id="lbl-rest">20s</b></div>
            <input type="range" id="rng-rest" min="10" max="90" step="5" oninput="app.updSettings()">
        </div>

        <div class="card">
            <h2>BACKUP & DATEN</h2>
            <button class="btn btn-outline" style="margin-bottom:10px;" onclick="backup.export()">BACKUP EXPORTIEREN</button>
            
            <input type="file" id="bk-import" style="display:none" onchange="backup.import(this)">
            <button class="btn btn-outline" style="margin-bottom:20px;" onclick="document.getElementById('bk-import').click()">BACKUP LADEN</button>
            
            <button class="btn btn-outline" style="border-color:var(--danger-color); color:var(--danger-color);" onclick="app.reset()">ALLES L√ñSCHEN</button>
        </div>
    </div>

    <div class="navbar">
        <div class="nav-btn active" onclick="ui.nav('view-home', this)">
            <div class="nav-icon">üè†</div><div class="nav-text">HOME</div>
        </div>
        <div class="nav-btn" onclick="ui.nav('view-stats', this)">
            <div class="nav-icon">üìä</div><div class="nav-text">STATS</div>
        </div>
        <div class="nav-btn" onclick="ui.nav('view-settings', this)">
            <div class="nav-icon">‚öôÔ∏è</div><div class="nav-text">SYSTEM</div>
        </div>
    </div>

    <script>
        // --- KONFIGURATION & DATEN ---
        const DB_KEY = "BP_V18_FINAL";
        const EXERCISES = [
            {n:"Planks", u:"Sek"}, {n:"Liegest√ºtze", u:"Wdh"}, {n:"Kniebeugen", u:"Wdh"},
            {n:"Crunches", u:"Wdh"}, {n:"Ausfallschritte", u:"Wdh"}, {n:"Dips", u:"Wdh"},
            {n:"Burpees", u:"Wdh"}, {n:"Mountain Climber", u:"Sek"}, {n:"Wandsitzen", u:"Sek"},
            {n:"Hampelmann", u:"Sek"}, {n:"Beinheben", u:"Wdh"}, {n:"Glute Bridge", u:"Wdh"}
        ];

        let db = {
            profile: { h:0, w:0, a:0 },
            config: { work:40, rest:20, dur:10, note:"" },
            state: { water:0, waterDate:"", checks:[false,false,false,false], streak:0, lastWorkout:0 },
            history: [],
            bodyLogs: [],
            meta: { installed: Date.now() }
        };

        // --- APP CONTROLLER ---
        const app = {
            init: () => {
                let s = localStorage.getItem(DB_KEY);
                if(s) { 
                    try { db = JSON.parse(s); } catch(e){ console.log(e); }
                    app.checkDate();
                    ui.refresh();
                } else {
                    document.getElementById('ov-setup').style.display = 'flex';
                }
            },

            save: () => { localStorage.setItem(DB_KEY, JSON.stringify(db)); },

            finishSetup: () => {
                db.profile.h = parseFloat(document.getElementById('inp-setup-h').value) || 175;
                db.profile.w = parseFloat(document.getElementById('inp-setup-w').value) || 75;
                db.profile.a = parseFloat(document.getElementById('inp-setup-a').value) || 30;
                db.meta.installed = Date.now();
                db.state.waterDate = new Date().toDateString();
                app.save();
                document.getElementById('ov-setup').style.display='none';
                ui.refresh();
            },

            checkDate: () => {
                let today = new Date().toDateString();
                if(db.state.waterDate !== today) {
                    db.state.water = 0;
                    db.state.waterDate = today;
                    db.state.checks = [false, false, false, false];
                    app.save();
                }
            },

            modWater: (val) => {
                db.state.water = Math.max(0, db.state.water + val);
                app.save(); ui.refresh();
            },

            setDur: (min) => {
                db.config.dur = min;
                document.getElementById('custom-dur').value = ""; // Clear custom
                app.save(); ui.refresh();
            },

            setCustomDur: (val) => {
                if(val > 0) {
                    db.config.dur = parseInt(val);
                    app.save(); ui.refresh();
                }
            },

            saveNote: (val) => {
                db.config.note = val;
                app.save();
                document.getElementById('home-note-preview').innerText = val || "Keine Notiz...";
            },

            updSettings: () => {
                db.config.work = parseInt(document.getElementById('rng-work').value);
                db.config.rest = parseInt(document.getElementById('rng-rest').value);
                app.save(); ui.refresh();
            },

            logBody: () => {
                let log = {
                    date: new Date().toISOString(),
                    w: document.getElementById('m-weight').value,
                    waist: document.getElementById('m-waist').value,
                    chest: document.getElementById('m-chest').value,
                    arm: document.getElementById('m-arm').value,
                    leg: document.getElementById('m-leg').value,
                    glute: document.getElementById('m-glute').value
                };
                if(log.w) {
                    db.profile.w = parseFloat(log.w);
                    db.bodyLogs.push(log);
                    app.save(); ui.refresh(); alert("Gespeichert");
                }
            },

            reset: () => {
                if(confirm("ALLES L√ñSCHEN?")) { localStorage.clear(); location.reload(); }
            }
        };

        // --- UI RENDERER ---
        const ui = {
            refresh: () => {
                // Header
                let days = Math.ceil((Date.now() - db.meta.installed)/86400000);
                document.getElementById('lbl-day').innerText = "TAG " + days;
                document.getElementById('lbl-date').innerText = new Date().toLocaleDateString('de-DE', {weekday:'long', day:'numeric', month:'long'}).toUpperCase();
                document.getElementById('home-streak').innerText = db.state.streak;

                // KPIs
                if(db.profile.h) {
                    let h = db.profile.h/100;
                    document.getElementById('kpi-bmi').innerText = (db.profile.w / (h*h)).toFixed(1);
                }
                let sum = db.history.reduce((a,b)=>a+(b.kcal||0),0);
                document.getElementById('kpi-kcal').innerText = sum.toLocaleString();
                document.getElementById('kpi-lvl').innerText = 1 + Math.floor(sum/1500);

                // Water
                document.getElementById('water-val').innerText = (db.state.water * 0.25).toFixed(1) + " / 2.5 L";
                document.getElementById('water-bar').style.width = Math.min((db.state.water/10)*100, 100) + "%";

                // Pills
                document.querySelectorAll('.btn-pill').forEach(b => b.classList.remove('active'));
                let pBtn = document.getElementById('d-'+db.config.dur);
                if(pBtn) pBtn.classList.add('active');

                // Settings
                document.getElementById('rng-work').value = db.config.work;
                document.getElementById('rng-rest').value = db.config.rest;
                document.getElementById('lbl-work').innerText = db.config.work+"s";
                document.getElementById('lbl-rest').innerText = db.config.rest+"s";

                // Note
                document.getElementById('daily-note-text').value = db.config.note;
                document.getElementById('home-note-preview').innerText = db.config.note || "Keine Notiz...";

                // Frequenz Stats
                stats.calcFreq();
                stats.renderChart();
                stats.renderList();
            },

            nav: (id, el) => {
                document.querySelectorAll('.app-screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                el.classList.add('active');
            },

            openDaily: () => {
                let c = document.getElementById('daily-list-container'); c.innerHTML="";
                let labs = ["Protein Shake", "Kreatin", "Vitamine", "7h Schlaf"];
                labs.forEach((l,i)=>{
                    let d = document.createElement('div');
                    d.className = "check-row" + (db.state.check[i]?" done":"");
                    d.innerHTML = `<div class="check-viz"></div><span>${l}</span>`;
                    d.onclick = () => { db.state.check[i] = !db.state.check[i]; app.save(); ui.openDaily(); };
                    c.appendChild(d);
                });
                document.getElementById('ov-daily').style.display='flex';
            },
            closeDaily: () => { document.getElementById('ov-daily').style.display='none'; },

            openManual: () => {
                logSys.stack = [];
                logSys.render();
                let sel = document.getElementById('man-ex-select'); sel.innerHTML="";
                EXERCISES.forEach(e=>{
                    let opt = document.createElement('option');
                    opt.value = e.n;
                    opt.innerText = e.n;
                    sel.appendChild(opt);
                });
                document.getElementById('ov-manual').style.display='flex';
            },
            closeManual: () => { document.getElementById('ov-manual').style.display='none'; }
        };

        // --- MANUAL LOG SYSTEM (PRO) ---
        const logSys = {
            stack: [],
            addToStack: () => {
                let name = document.getElementById('man-ex-select').value;
                let rounds = parseInt(document.getElementById('man-rounds-count').value);
                let entry = { name: name, rounds: [] };
                for(let i=0; i<rounds; i++) entry.rounds.push({val: 0});
                logSys.stack.push(entry);
                logSys.render();
            },
            render: () => {
                let c = document.getElementById('manual-stack-list'); c.innerHTML="";
                logSys.stack.forEach((item, idx) => {
                    let div = document.createElement('div');
                    div.className = "log-stack-item";
                    let html = `<div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <b>${item.name}</b> <span onclick="logSys.rem(${idx})" style="color:red;">‚úï</span>
                    </div>`;
                    item.rounds.forEach((r, ri) => {
                        html += `<div class="log-set-row">
                            <span style="font-size:12px; color:#888;">SATZ ${ri+1}</span>
                            <input type="number" class="log-set-input" placeholder="0" oninput="logSys.stack[${idx}].rounds[${ri}].val=this.value">
                        </div>`;
                    });
                    div.innerHTML = html;
                    c.appendChild(div);
                });
            },
            rem: (i) => { logSys.stack.splice(i,1); logSys.render(); },
            saveStack: () => {
                if(logSys.stack.length===0) return;
                let cnt = logSys.stack.length;
                let sets = logSys.stack.reduce((a,b)=>a+b.rounds.length,0);
                db.history.push({
                    date: new Date().toISOString(),
                    type: "Manual Log",
                    kcal: sets * 15,
                    desc: `${cnt} √úbungen, ${sets} S√§tze`
                });
                stats.checkStreak();
                app.save(); ui.refresh(); ui.closeManual();
            }
        };

        // --- PLAYER ENGINE (TIME IN CIRCLE) ---
        const player = {
            timer: null,
            time: 0,
            phase: 'PREP',
            round: 1,
            exIdx: 0,
            plan: [],
            completed: false,
            audioCtx: null,
            muted: false,

            init: () => {
                if(!player.audioCtx) player.audioCtx = new (window.AudioContext||window.webkitAudioContext)();
                player.plan = [...EXERCISES].sort(()=>0.5-Math.random()).slice(0,6);
                player.round = 1; 
                player.exIdx = 0; 
                player.phase = 'PREP'; 
                player.time = 10;
                player.completed = false;
                document.getElementById('ov-player').style.display='flex';
                player.updateUI();
            },

            toggle: () => {
                let btn = document.getElementById('p-btn-main');
                if(player.timer) { clearInterval(player.timer); player.timer=null; btn.innerText="WEITER"; }
                else { player.timer = setInterval(player.tick, 1000); btn.innerText="PAUSE"; }
            },

            tick: () => {
                if(player.time > 0) {
                    player.time--;
                    if(player.time<=3 && player.time>0) player.beep(600);
                    player.updateUI();
                } else {
                    player.beep(900);
                    player.next();
                }
            },

            next: () => {
                if(player.phase === 'PREP') {
                    player.phase = 'WORK'; player.time = db.config.work;
                } else if(player.phase === 'WORK') {
                    player.phase = 'REST'; player.time = db.config.rest;
                } else {
                    // End of Rest
                    player.exIdx++;
                    if(player.exIdx >= 6) {
                        player.exIdx = 0; player.round++;
                        let maxR = db.config.dur===10?1:(db.config.dur===20?2:3);
                        if(player.round > maxR) { player.finish(); return; }
                    }
                    player.phase = 'WORK'; player.time = db.config.work;
                }
                player.updateUI();
            },

            skip: () => {
                if(player.phase === 'WORK') { alert("Training l√§uft! Nicht √ºberspringen!"); return; }
                player.time = 0; player.next();
            },

            updateUI: () => {
                document.getElementById('p-info').innerText = `RUNDE ${player.round} ‚Ä¢ √úBUNG ${player.exIdx+1}/6`;
                document.getElementById('p-time').innerText = player.time;
                document.getElementById('p-phase').innerText = player.phase;
                document.getElementById('p-ex-name').innerText = player.plan[player.exIdx].n.toUpperCase();
                
                let max = player.phase==='WORK'?db.config.work:(player.phase==='REST'?db.config.rest:10);
                let off = 754 - (player.time/max)*754;
                document.getElementById('p-ring').style.strokeDashoffset = off;

                let skp = document.getElementById('p-btn-skip');
                if(player.phase==='WORK') { skp.style.opacity='0.3'; skp.innerText="LOCKED"; }
                else { skp.style.opacity='1'; skp.innerText="SKIP PAUSE"; }
            },

            finish: () => {
                clearInterval(player.timer);
                let k = db.config.dur * 8;
                db.history.push({ date: new Date().toISOString(), type: "Live Workout", kcal: k, desc: db.config.dur+" Min Zirkel" });
                stats.checkStreak();
                app.save(); ui.refresh();
                document.getElementById('ov-player').style.display='none';
                alert("TRAINING BEENDET! "+k+" kcal");
            },

            exit: () => {
                clearInterval(player.timer); player.timer=null;
                if(confirm("Abbrechen? (Training z√§hlt nicht)")) document.getElementById('ov-player').style.display='none';
            },

            beep: (f) => {
                if(player.muted || !player.audioCtx) return;
                let o = player.audioCtx.createOscillator();
                let g = player.audioCtx.createGain();
                o.connect(g); g.connect(player.audioCtx.destination);
                o.frequency.value = f;
                g.gain.value = 0.1; o.start(); o.stop(player.audioCtx.currentTime+0.1);
            },
            toggleMute: () => { player.muted = !player.muted; document.getElementById('p-mute').innerText = player.muted?"üîá":"üîä"; }
        };

        // --- STATS ENGINE ---
        const stats = {
            checkStreak: () => {
                let last = new Date(db.state.lastWorkout).toDateString();
                let today = new Date().toDateString();
                if(last !== today) { db.state.streak++; db.state.lastWorkout = Date.now(); }
            },
            calcFreq: () => {
                let now = new Date();
                let w=0, m=0, y=0;
                let startW = new Date(now); startW.setDate(now.getDate()-now.getDay()+1); startW.setHours(0,0,0,0);
                let startM = new Date(now.getFullYear(), now.getMonth(), 1);
                let startY = new Date(now.getFullYear(), 0, 1);
                
                db.history.forEach(h => {
                    let d = new Date(h.date);
                    if(d >= startW) w++;
                    if(d >= startM) m++;
                    if(d >= startY) y++;
                });
                document.getElementById('cnt-week').innerText = w;
                document.getElementById('cnt-month').innerText = m;
                document.getElementById('cnt-year').innerText = y;
            },
            renderChart: () => {
                let svg = document.getElementById('chart-svg'); svg.innerHTML="";
                if(db.bodyLogs.length < 2) return;
                let ws = db.bodyLogs.map(l=>parseFloat(l.w));
                let min = Math.min(...ws)-2, max = Math.max(...ws)+2;
                let pts = ws.map((w,i) => `${(i/(ws.length-1))*100},${100 - ((w-min)/(max-min)*100)}`).join(' ');
                svg.innerHTML = `<polyline points="${pts}" fill="none" stroke="#32d74b" stroke-width="3" />`;
            },
            renderList: () => {
                let c = document.getElementById('hist-list'); c.innerHTML="";
                [...db.history].reverse().slice(0,10).forEach(h => {
                    let div = document.createElement('div');
                    div.className="card"; div.style.padding="12px";
                    div.innerHTML = `<div style="display:flex; justify-content:space-between; font-size:13px;">
                        <b style="color:var(--color-accent);">${h.type}</b>
                        <span>${new Date(h.date).toLocaleDateString()}</span>
                    </div>
                    <div style="font-size:12px; color:#888;">${h.kcal} kcal ‚Ä¢ ${h.desc||''}</div>`;
                    c.appendChild(div);
                });
            }
        };

        // --- BACKUP ---
        const backup = {
            export: () => {
                let b = new Blob([JSON.stringify(db)], {type:'application/json'});
                let a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='bodypulse.json'; a.click();
            },
            import: (el) => {
                let r = new FileReader();
                r.onload = e => { db = JSON.parse(e.target.result); app.save(); location.reload(); };
                r.readAsText(el.files[0]);
            }
        };

        app.init();
    </script>
</body>
</html>
